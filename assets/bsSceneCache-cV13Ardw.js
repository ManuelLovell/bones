import{C as r,O as a}from"./bsConstants-E4N5t5Rc.js";function S(){const i=document.createElement("img");i.id="whatsNewButton",i.style.cursor="pointer",i.setAttribute("class","icon"),i.classList.add("clickable"),i.setAttribute("title","Whats New?"),i.setAttribute("src","/info.svg"),i.onclick=async function(){try{localStorage.setItem(r.VERSION,"true"),i.classList.remove("whats-new-shine")}catch{}await a.modal.open({id:r.EXTENSIONWHATSNEW,url:"/bsWhatsNew.html",height:500,width:350})};try{localStorage.getItem(r.VERSION)!=="true"&&i.classList.add("whats-new-shine")}catch{}return i}function E(i,e){let t;return function(){clearTimeout(t),t=setTimeout(()=>{i()},e)}}function T(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),o=t.matches?"dark":"light",n=t.matches?"light":"dark";for(var l=0;l<e.styleSheets.length;l++)for(var c=0;c<e.styleSheets[l].cssRules.length;c++){let d=e.styleSheets[l].cssRules[c];d&&d.media&&d.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(d.media.appendMedium(`(prefers-color-scheme: ${o})`),d.media.mediaText.includes(n)&&d.media.deleteMedium(`(prefers-color-scheme: ${n})`)):i.mode=="DARK"&&(d.media.appendMedium(`(prefers-color-scheme: ${n})`),d.media.mediaText.includes(o)&&d.media.deleteMedium(`(prefers-color-scheme: ${o})`)))}}class M{constructor(e){this.totalSlots=e,this.initializeSlots()}slots=[];initializeSlots(){for(let e=0;e<this.totalSlots;e++)this.slots.push(!0)}occupySlot(){const e=this.slots.findIndex(t=>t);return e!==-1?(this.slots[e]=!1,setTimeout(()=>{this.releaseSlot(e)},3500),e):-1}releaseSlot(e){this.slots[e]=!0}runFunction(){const e=this.occupySlot();return console.log(e!==-1?`Function is running on slot ${e}`:"No available slots. Please try again later."),e}}class O{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new M(4)}IsThisOld(e,t,o="DEFAULT"){const n=`${t}_${o}`,l=this.messageCounter[n];return l?l!==e?(this.messageCounter[n]=e,!1):!0:(this.messageCounter[n]=e,!1)}async LogBonesRoll(e){if(e[`${r.EXTENSIONID}/metadata_logroll`]!=null){const t=e[`${r.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(t.created,t.senderId,"LOG"))if(t.senderId===u.playerId||t.viewers===u.playerRole||t.viewers==="ALL"){const o=document.querySelector("#rollLog"),n=t.rollHtml;let l="";t.viewers==="GM"&&(l="[GM]"),t.viewers==="SELF"&&(l="[SELF]");const c=document.createElement("li");if(c.className="dice-log-item",c.innerHTML=`[${this.getTimestamp(t.created)}] ${l}<span style="font-weight: bold; color:${t.senderColor};">${t.senderName}</span> => ${n}`,o.append(c),c.scrollIntoView(!1),t.senderId!==u.playerId){const d=await a.viewport.getHeight(),y=encodeURIComponent(n),f=encodeURIComponent(t.senderName);let h=u.party.find(I=>I.id===t.senderId)?.color??"#FFF";const g=encodeURIComponent(h),p=this.queue.runFunction();if(p!==-1){const I=p===0?d-50:d-p*100-50;await a.popover.open({id:r.EXTENSIONNOTIFY+p.toString(),url:`/dicenotify.html?sender=${f}&message=${y}&color=${g}&queue=${encodeURIComponent(p)}`,height:95,width:300,anchorPosition:{top:I,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}else{const o=document.querySelector("#rollLog"),n=document.createElement("li");if(n.className="dice-log-item",n.innerHTML=`[${this.getTimestamp(t.created)}]<span style="font-weight: bold; color:${t.senderColor};">${t.senderName}</span> rolled out of view.`,o.append(n),n.scrollIntoView(!1),t.senderId!==u.playerId){const l=await a.viewport.getHeight(),c=encodeURIComponent(" just rolled out of view."),d=encodeURIComponent(t.senderName);let y=u.party.find(g=>g.id===t.senderId)?.color??"#FFF";const f=encodeURIComponent(y),h=this.queue.runFunction();if(h!==-1){const g=h===0?l-50:l-h*100-50;await a.popover.open({id:r.EXTENSIONNOTIFY+h.toString(),url:`/dicenotify.html?sender=${d}&message=${c}&color=${f}&queue=${encodeURIComponent(h)}`,height:95,width:300,anchorPosition:{top:g,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}getTimestamp(e){const t=new Date(e),o=t.getHours().toString().padStart(2,"0"),n=t.getMinutes().toString().padStart(2,"0");return`${o}:${n}`}}const m=new O;class s{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerDiceTexture;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="skulls",this.playerDiceColor="#ff0000",this.caches=e,this.debouncedOnSceneItemsChange=E(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=E(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=E(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await a.scene.isReady(),this.theme=await a.theme.getTheme(),T(this.theme,document),this.caches.includes(s.PLAYER)){this.playerId=await a.player.getId(),this.playerName=await a.player.getName(),this.playerColor=await a.player.getColor(),this.playerMetadata=await a.player.getMetadata(),this.playerRole=await a.player.getRole();const e=this.playerMetadata[`${r.EXTENSIONID}/metadata_bonesroll`];e&&m.IsThisOld(e.created,e.senderName,"DEFAULT");const t=this.playerMetadata[`${r.EXTENSIONID}/metadata_logroll`];t&&m.IsThisOld(t.created,t.senderId,"LOG")}if(this.caches.includes(s.PARTY)){this.party=await a.party.getPlayers();for(const e of this.party){const t=e.metadata[`${r.EXTENSIONID}/metadata_bonesroll`];t&&m.IsThisOld(t.created,t.senderName,"DEFAULT");const o=e.metadata[`${r.EXTENSIONID}/metadata_logroll`];o&&m.IsThisOld(o.created,o.senderId,"LOG")}}this.caches.includes(s.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await a.scene.items.getItems()),this.caches.includes(s.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await a.scene.getMetadata()),this.caches.includes(s.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await a.scene.grid.getDpi(),this.gridScale=(await a.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(s.ROOMMETA)&&(this.roomMetadata=await a.room.getMetadata(),this.playerDiceColor=this.roomMetadata[r.DICECOLORSETTING+this.playerId]??"#ff0000",this.playerDiceTexture=this.roomMetadata[r.DICETEXTURESETTING+this.playerId]??"default",["default","diceOfRolling","gemstone","gemstoneMarble","rock","rust","smooth","wooden"].includes(this.playerDiceTexture)||(this.playerDiceTexture="default"))}KillHandlers(){this.caches.includes(s.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(s.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(s.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(s.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(s.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(s.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(s.SCENEMETA)&&(this.sceneMetadataHandler=a.scene.onMetadataChange(async e=>{this.sceneMetadata=e,this.debouncedOnSceneMetadataChange(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(s.SCENEITEMS)&&(this.sceneItemsHandler=a.scene.items.onChange(async e=>{this.sceneItems=e,this.debouncedOnSceneItemsChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(s.SCENEGRID)&&(this.sceneGridHandler=a.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(s.PLAYER)&&(this.playerHandler=a.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(s.PARTY)&&(this.partyHandler=a.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(s.ROOMMETA)&&(this.roomHandler=a.room.onMetadataChange(async e=>{this.roomMetadata=e,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=a.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=a.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await a.scene.items.getItems(),this.sceneMetadata=await a.scene.getMetadata(),this.gridDpi=await a.scene.grid.getDpi(),this.gridScale=(await a.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){}async OnSceneItemsChange(e){this.sceneReady}async OnSceneGridChange(e){}async OnSceneReadyChange(e){}async OnPlayerChange(e){await m.LogBonesRoll(e.metadata)}async OnPartyChange(e){for await(const t of e)await m.LogBonesRoll(t.metadata)}async OnRoomMetadataChange(){const e=this.roomMetadata[r.DICECOLORSETTING+this.playerId],t=this.roomMetadata[r.DICETEXTURESETTING+this.playerId];e&&(this.playerDiceColor=e),t&&(this.playerDiceTexture=t)}async OnThemeChange(e){T(e,document)}}const u=new s([s.PLAYER,s.PARTY,s.ROOMMETA]);export{u as B,S as G,m as M};
