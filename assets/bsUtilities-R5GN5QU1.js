import{C as o,O as a,b as R,D as u,a as w}from"./bsConstants-BwvBGUaJ.js";class N{constructor(e){this.totalSlots=e,this.initializeSlots()}slots=[];initializeSlots(){for(let e=0;e<this.totalSlots;e++)this.slots.push(!0)}occupySlot(){const e=this.slots.findIndex(t=>t);return e!==-1?(this.slots[e]=!1,setTimeout(()=>{this.releaseSlot(e)},3500),e):-1}releaseSlot(e){this.slots[e]=!0}runFunction(){const e=this.occupySlot();return console.log(e!==-1?`Function is running on slot ${e}`:"No available slots. Please try again later."),e}}class H{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new N(4)}IsThisOld(e,t,n="DEFAULT"){const s=`${t}_${n}`,l=this.messageCounter[s];return l?l!==e?(this.messageCounter[s]=e,!1):!0:(this.messageCounter[s]=e,!1)}async ShowBonesRoll(e){if(e[`${o.EXTENSIONID}/metadata_bonesroll`]!=null){const t=e[`${o.EXTENSIONID}/metadata_bonesroll`];if(!this.IsThisOld(t.created,t.senderId,"ROLL")){const n=await a.viewport.getHeight(),s=await a.viewport.getWidth();await a.modal.open({id:o.EXTENSIONDICEWINDOWID,url:"/dicewindow.html",height:n-100,width:s-50,hidePaper:!0,hideBackdrop:!0,disablePointerEvents:!0})}}}async LogBonesRoll(e){if(e[`${o.EXTENSIONID}/metadata_logroll`]!=null){const t=e[`${o.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(t.created,t.senderId,"LOG"))if(t.senderId===d.playerId||t.viewers===d.playerRole||t.viewers==="ALL"){const n=document.querySelector("#rollLog"),s=t.rollHtml;let l="";t.viewers==="GM"&&(l="[GM]"),t.viewers==="SELF"&&(l="[SELF]");const h=document.createElement("li");if(h.className="dice-log-item dice-notification",h.innerHTML=`[${this.getTimestamp(t.created)}] ${l}<span style="font-weight: bold; color:${t.senderColor};">${t.senderName}</span> => ${s}`,n.append(h),h.scrollIntoView(!1),t.senderId!==d.playerId){const c=await a.viewport.getHeight(),f=encodeURIComponent(s),g=encodeURIComponent(t.senderName);let p=d.party.find(E=>E.id===t.senderId)?.color??"#FFF";const m=encodeURIComponent(p),y=this.queue.runFunction();if(y!==-1){const E=y===0?c-50:c-y*100-50;await a.popover.open({id:o.EXTENSIONNOTIFY+y.toString(),url:`/dicenotify.html?sender=${g}&message=${f}&color=${m}&queue=${encodeURIComponent(y)}`,height:95,width:300,anchorPosition:{top:E,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}else{const n=document.querySelector("#rollLog"),s=document.createElement("li");if(s.className="dice-log-item dice-notification",s.innerHTML=`[${this.getTimestamp(t.created)}]<span style="font-weight: bold; color:${t.senderColor};">${t.senderName}</span> rolled out of view.`,n.append(s),s.scrollIntoView(!1),t.senderId!==d.playerId){const l=await a.viewport.getHeight(),h=encodeURIComponent(" just rolled out of view."),c=encodeURIComponent(t.senderName);let f=d.party.find(m=>m.id===t.senderId)?.color??"#FFF";const g=encodeURIComponent(f),p=this.queue.runFunction();if(p!==-1){const m=p===0?l-50:l-p*100-50;await a.popover.open({id:o.EXTENSIONNOTIFY+p.toString(),url:`/dicenotify.html?sender=${c}&message=${h}&color=${g}&queue=${encodeURIComponent(p)}`,height:95,width:300,anchorPosition:{top:m,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}getTimestamp(e){const t=new Date(e),n=t.getHours().toString().padStart(2,"0"),s=t.getMinutes().toString().padStart(2,"0");return`${n}:${s}`}}const I=new H;class r{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerSecondDiceColor;playerDiceTexture;playerDiceZoom;playerMarkers;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;USER_REGISTERED;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="default",this.playerDiceColor="#ff0000",this.playerSecondDiceColor="#FFFFFF",this.playerDiceZoom=4,this.playerMarkers=!1,this.USER_REGISTERED=!1,this.caches=e,this.debouncedOnSceneItemsChange=C(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=C(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=C(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await a.scene.isReady(),this.theme=await a.theme.getTheme(),S(this.theme,document),this.caches.includes(r.PLAYER)){this.playerId=await a.player.getId(),this.playerName=await a.player.getName(),this.playerColor=await a.player.getColor(),this.playerMetadata=await a.player.getMetadata(),this.playerRole=await a.player.getRole();const e=this.playerMetadata[`${o.EXTENSIONID}/metadata_bonesroll`];e&&I.IsThisOld(e.created,e.senderName,"DEFAULT");const t=this.playerMetadata[`${o.EXTENSIONID}/metadata_logroll`];t&&I.IsThisOld(t.created,t.senderId,"LOG")}if(this.caches.includes(r.PARTY)){this.party=await a.party.getPlayers();for(const e of this.party){const t=e.metadata[`${o.EXTENSIONID}/metadata_bonesroll`];t&&I.IsThisOld(t.created,t.senderName,"DEFAULT");const n=e.metadata[`${o.EXTENSIONID}/metadata_logroll`];n&&I.IsThisOld(n.created,n.senderId,"LOG")}}this.caches.includes(r.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await a.scene.items.getItems()),this.caches.includes(r.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await a.scene.getMetadata()),this.caches.includes(r.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await a.scene.grid.getDpi(),this.gridScale=(await a.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(r.ROOMMETA)&&(this.roomMetadata=await a.room.getMetadata(),this.playerDiceColor=this.roomMetadata[o.DICECOLORSETTING+this.playerId]??"#ff0000",this.playerDiceZoom=this.roomMetadata[o.DICEZOOMSETTING+this.playerId]??4,this.playerMarkers=this.roomMetadata[o.DICEMARKERSETTING+this.playerId]===!0,this.playerSecondDiceColor=this.roomMetadata[o.SECONDDICECOLORSETTING+this.playerId]??"#FFFFFF",this.playerDiceTexture=this.roomMetadata[o.DICETEXTURESETTING+this.playerId]??"default",o.DEFAULTTEXTURES.includes(this.playerDiceTexture)||(this.playerDiceTexture="default")),a.broadcast.onMessage(o.DICETOKENBROADCAST,async e=>{if(!this.playerMarkers)return;const t=this.gridDpi/2,n=e.data,s=[],l=await a.viewport.getWidth(),h=await a.viewport.getHeight(),c=await a.viewport.inverseTransformPoint({x:l/2,y:h/2});function f(E){switch(E){case 4:return u.D4Path(0,0,d.gridDpi);case 6:return u.D6Path(0,0,d.gridDpi);case 8:return u.D8Path(0,0,d.gridDpi);case 10:return u.D10Path(0,0,d.gridDpi);case 12:return u.D12Path(0,0,d.gridDpi);case 20:return u.D20Path(0,0,d.gridDpi);case 100:return u.D100Path(0,0,d.gridDpi);default:return u.D20Path(0,0,d.gridDpi)}}let g=5e-4,p=0,m=0;const y=2;for(const E of n){const T={x:c.x+p,y:c.y+m},O=R().position(T).commands(u.DiceRimPath(0,0,this.gridDpi)).strokeOpacity(1).strokeWidth(6).strokeColor(this.playerColor).fillOpacity(1).fillColor("black").layer("PROP").zIndex(g+1e-5).build(),D=R().position(T).commands(f(E.type)).attachedTo(O.id).strokeOpacity(1).strokeWidth(4).strokeColor("#828282").disableHit(!0).layer("PROP").zIndex(g+2e-5).build(),M=w().attachedTo(O.id).strokeColor("white").strokeOpacity(1).strokeWidth(4).fontWeight(600).fontSize(72).width(d.gridDpi).height(d.gridDpi).position({x:T.x-t,y:T.y-t}).textAlign("CENTER").textAlignVertical("MIDDLE").textType("PLAIN").fillColor("white").fillOpacity(1).plainText(E.value.toString()).disableHit(!0).layer("PROP").zIndex(g+3e-5).build();s.push(O),s.push(D),s.push(M),g+=1,m+=this.gridDpi,m>this.gridDpi*y&&(m=0,p+=this.gridDpi)}await a.scene.items.addItems(s)}),await this.CheckRegistration()}KillHandlers(){this.caches.includes(r.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(r.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(r.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(r.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(r.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(r.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(r.SCENEMETA)&&(this.sceneMetadataHandler=a.scene.onMetadataChange(async e=>{this.sceneMetadata=e,this.debouncedOnSceneMetadataChange(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(r.SCENEITEMS)&&(this.sceneItemsHandler=a.scene.items.onChange(async e=>{this.sceneItems=e,this.debouncedOnSceneItemsChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(r.SCENEGRID)&&(this.sceneGridHandler=a.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(r.PLAYER)&&(this.playerHandler=a.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(r.PARTY)&&(this.partyHandler=a.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(r.ROOMMETA)&&(this.roomHandler=a.room.onMetadataChange(async e=>{this.roomMetadata=e,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=a.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=a.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await a.scene.items.getItems(),this.sceneMetadata=await a.scene.getMetadata(),this.gridDpi=await a.scene.grid.getDpi(),this.gridScale=(await a.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){}async OnSceneItemsChange(e){this.sceneReady}async OnSceneGridChange(e){}async OnSceneReadyChange(e){}async OnPlayerChange(e){await I.ShowBonesRoll(e.metadata),await I.LogBonesRoll(e.metadata)}async OnPartyChange(e){for await(const t of e)await I.LogBonesRoll(t.metadata)}async OnRoomMetadataChange(){const e=this.roomMetadata[o.DICECOLORSETTING+this.playerId],t=this.roomMetadata[o.DICEZOOMSETTING+this.playerId];this.playerMarkers=this.roomMetadata[o.DICEMARKERSETTING+this.playerId]===!0;const n=this.roomMetadata[o.SECONDDICECOLORSETTING+this.playerId],s=this.roomMetadata[o.DICETEXTURESETTING+this.playerId];e&&(this.playerDiceColor=e,await a.broadcast.sendMessage(o.COLORCHANNEL,{color:e},{destination:"LOCAL"})),n&&(this.playerSecondDiceColor=n,await a.broadcast.sendMessage(o.COLORCHANNEL,{secondaryColor:n},{destination:"LOCAL"})),t&&(this.playerDiceZoom=t),s&&(this.playerDiceTexture=s)}async OnThemeChange(e){S(e,document)}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",t={owlbearid:d.playerId},n={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:o.ANONAUTH,"x-manuel":e}),body:JSON.stringify(t)},s=await fetch(o.CHECKREGISTRATION,n);if(!s.ok){const h=await s.json();console.error("Error:",h);return}(await s.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}}const d=new r([r.PLAYER,r.PARTY,r.SCENEGRID,r.ROOMMETA]);function A(){const i=document.createElement("img");return i.id="PatreonButton",i.setAttribute("class","icon"),i.classList.add("patreon-clickable"),i.setAttribute("title",d.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),i.setAttribute("src",d.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),i.onclick=async function(e){e.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},i}function C(i,e){let t;return function(){clearTimeout(t),t=setTimeout(()=>{i()},e)}}function P(i){if(i.indexOf("#")===0&&(i=i.slice(1)),i.length===3&&(i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]),i.length!==6)throw new Error("Invalid HEX color.");var e=parseInt(i.slice(0,2),16),t=parseInt(i.slice(2,4),16),n=parseInt(i.slice(4,6),16);return e*.299+t*.587+n*.114>186?"#000000":"#FFFFFF"}function S(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",s=t.matches?"light":"dark";for(var l=0;l<e.styleSheets.length;l++)for(var h=0;h<e.styleSheets[l].cssRules.length;h++){let c=e.styleSheets[l].cssRules[h];c&&c.media&&c.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(c.media.appendMedium(`(prefers-color-scheme: ${n})`),c.media.mediaText.includes(s)&&c.media.deleteMedium(`(prefers-color-scheme: ${s})`)):i.mode=="DARK"&&(c.media.appendMedium(`(prefers-color-scheme: ${s})`),c.media.mediaText.includes(n)&&c.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}export{d as B,A as G,P as I};
