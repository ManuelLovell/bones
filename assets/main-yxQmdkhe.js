import{C as p,O as h}from"./bsConstants-vq7ZmLno.js";/* empty css                   */function He(){const f=document.createElement("img");f.id="whatsNewButton",f.style.cursor="pointer",f.setAttribute("class","icon"),f.classList.add("clickable"),f.setAttribute("title","Whats New?"),f.setAttribute("src","/info.svg"),f.onclick=async function(){try{localStorage.setItem(p.VERSION,"true"),f.classList.remove("whats-new-shine")}catch{}await h.modal.open({id:p.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(p.VERSION)!=="true"&&f.classList.add("whats-new-shine")}catch{}return f}function ce(f,t){let s;return function(){clearTimeout(s),s=setTimeout(()=>{f()},t)}}function me(f,t){const s=window.matchMedia("(prefers-color-scheme: dark)"),o=s.matches?"dark":"light",d=s.matches?"light":"dark";for(var m=0;m<t.styleSheets.length;m++)for(var g=0;g<t.styleSheets[m].cssRules.length;g++){let c=t.styleSheets[m].cssRules[g];c&&c.media&&c.media.mediaText.includes("prefers-color-scheme")&&(f.mode=="LIGHT"?(c.media.appendMedium(`(prefers-color-scheme: ${o})`),c.media.mediaText.includes(d)&&c.media.deleteMedium(`(prefers-color-scheme: ${d})`)):f.mode=="DARK"&&(c.media.appendMedium(`(prefers-color-scheme: ${d})`),c.media.mediaText.includes(o)&&c.media.deleteMedium(`(prefers-color-scheme: ${o})`)))}}class De{constructor(t){this.totalSlots=t,this.initializeSlots()}slots=[];initializeSlots(){for(let t=0;t<this.totalSlots;t++)this.slots.push(!0)}occupySlot(){const t=this.slots.findIndex(s=>s);return t!==-1?(this.slots[t]=!1,setTimeout(()=>{this.releaseSlot(t)},3500),t):-1}releaseSlot(t){this.slots[t]=!0}runFunction(){const t=this.occupySlot();return console.log(t!==-1?`Function is running on slot ${t}`:"No available slots. Please try again later."),t}}class xe{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new De(4)}IsThisOld(t,s,o="DEFAULT"){const d=`${s}_${o}`,m=this.messageCounter[d];return m?m!==t?(this.messageCounter[d]=t,!1):!0:(this.messageCounter[d]=t,!1)}async ShowBonesRoll(t){if(t[`${p.EXTENSIONID}/metadata_bonesroll`]!=null){const s=t[`${p.EXTENSIONID}/metadata_bonesroll`];if(!this.IsThisOld(s.created,s.senderId,"ROLL")){const o=await h.viewport.getHeight(),d=await h.viewport.getWidth();await h.popover.open({id:p.EXTENSIONDICEWINDOWID,url:"/dicewindow.html",height:o-50,width:d-50,anchorPosition:{top:25,left:25},anchorReference:"POSITION",anchorOrigin:{vertical:"TOP",horizontal:"LEFT"},transformOrigin:{vertical:"TOP",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}async LogBonesRoll(t){if(t[`${p.EXTENSIONID}/metadata_logroll`]!=null){const s=t[`${p.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(s.created,s.senderId,"LOG"))if(s.senderId===O.playerId||s.viewers===O.playerRole||s.viewers==="ALL"){const o=document.querySelector("#rollLog"),d=s.rollHtml;let m="";s.viewers==="GM"&&(m="[GM]"),s.viewers==="SELF"&&(m="[SELF]");const g=document.createElement("li");if(g.className="dice-log-item dice-notification",g.innerHTML=`[${this.getTimestamp(s.created)}] ${m}<span style="font-weight: bold; color:${s.senderColor};">${s.senderName}</span> => ${d}`,o.append(g),g.scrollIntoView(!1),s.senderId!==O.playerId){const c=await h.viewport.getHeight(),C=encodeURIComponent(d),b=encodeURIComponent(s.senderName);let S=O.party.find(A=>A.id===s.senderId)?.color??"#FFF";const w=encodeURIComponent(S),R=this.queue.runFunction();if(R!==-1){const A=R===0?c-50:c-R*100-50;await h.popover.open({id:p.EXTENSIONNOTIFY+R.toString(),url:`/dicenotify.html?sender=${b}&message=${C}&color=${w}&queue=${encodeURIComponent(R)}`,height:95,width:300,anchorPosition:{top:A,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}else{const o=document.querySelector("#rollLog"),d=document.createElement("li");if(d.className="dice-log-item dice-notification",d.innerHTML=`[${this.getTimestamp(s.created)}]<span style="font-weight: bold; color:${s.senderColor};">${s.senderName}</span> rolled out of view.`,o.append(d),d.scrollIntoView(!1),s.senderId!==O.playerId){const m=await h.viewport.getHeight(),g=encodeURIComponent(" just rolled out of view."),c=encodeURIComponent(s.senderName);let C=O.party.find(w=>w.id===s.senderId)?.color??"#FFF";const b=encodeURIComponent(C),S=this.queue.runFunction();if(S!==-1){const w=S===0?m-50:m-S*100-50;await h.popover.open({id:p.EXTENSIONNOTIFY+S.toString(),url:`/dicenotify.html?sender=${c}&message=${g}&color=${b}&queue=${encodeURIComponent(S)}`,height:95,width:300,anchorPosition:{top:w,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}getTimestamp(t){const s=new Date(t),o=s.getHours().toString().padStart(2,"0"),d=s.getMinutes().toString().padStart(2,"0");return`${o}:${d}`}}const F=new xe;class E{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerDiceTexture;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(t){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="skulls",this.playerDiceColor="#ff0000",this.caches=t,this.debouncedOnSceneItemsChange=ce(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=ce(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=ce(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await h.scene.isReady(),this.theme=await h.theme.getTheme(),me(this.theme,document),this.caches.includes(E.PLAYER)){this.playerId=await h.player.getId(),this.playerName=await h.player.getName(),this.playerColor=await h.player.getColor(),this.playerMetadata=await h.player.getMetadata(),this.playerRole=await h.player.getRole();const t=this.playerMetadata[`${p.EXTENSIONID}/metadata_bonesroll`];t&&F.IsThisOld(t.created,t.senderName,"DEFAULT");const s=this.playerMetadata[`${p.EXTENSIONID}/metadata_logroll`];s&&F.IsThisOld(s.created,s.senderId,"LOG")}if(this.caches.includes(E.PARTY)){this.party=await h.party.getPlayers();for(const t of this.party){const s=t.metadata[`${p.EXTENSIONID}/metadata_bonesroll`];s&&F.IsThisOld(s.created,s.senderName,"DEFAULT");const o=t.metadata[`${p.EXTENSIONID}/metadata_logroll`];o&&F.IsThisOld(o.created,o.senderId,"LOG")}}this.caches.includes(E.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await h.scene.items.getItems()),this.caches.includes(E.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await h.scene.getMetadata()),this.caches.includes(E.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await h.scene.grid.getDpi(),this.gridScale=(await h.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(E.ROOMMETA)&&(this.roomMetadata=await h.room.getMetadata(),this.playerDiceColor=this.roomMetadata[p.DICECOLORSETTING+this.playerId]??"#ff0000",this.playerDiceTexture=this.roomMetadata[p.DICETEXTURESETTING+this.playerId]??"default",p.DEFAULTTEXTURES.includes(this.playerDiceTexture)||(this.playerDiceTexture="default"))}KillHandlers(){this.caches.includes(E.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(E.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(E.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(E.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(E.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(E.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(E.SCENEMETA)&&(this.sceneMetadataHandler=h.scene.onMetadataChange(async t=>{this.sceneMetadata=t,this.debouncedOnSceneMetadataChange(t)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(E.SCENEITEMS)&&(this.sceneItemsHandler=h.scene.items.onChange(async t=>{this.sceneItems=t,this.debouncedOnSceneItemsChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(E.SCENEGRID)&&(this.sceneGridHandler=h.scene.grid.onChange(async t=>{this.gridDpi=t.dpi,this.gridScale=parseInt(t.scale),await this.OnSceneGridChange(t)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(E.PLAYER)&&(this.playerHandler=h.player.onChange(async t=>{this.playerName=t.name,this.playerColor=t.color,this.playerId=t.id,this.playerRole=t.role,this.playerMetadata=t.metadata,await this.OnPlayerChange(t)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(E.PARTY)&&(this.partyHandler=h.party.onChange(async t=>{this.party=t,await this.OnPartyChange(t)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(E.ROOMMETA)&&(this.roomHandler=h.room.onMetadataChange(async t=>{this.roomMetadata=t,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=h.theme.onChange(async t=>{this.theme=t.mode,await this.OnThemeChange(t)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=h.scene.onReadyChange(async t=>{this.sceneReady=t,t&&(this.sceneItems=await h.scene.items.getItems(),this.sceneMetadata=await h.scene.getMetadata(),this.gridDpi=await h.scene.grid.getDpi(),this.gridScale=(await h.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(t)}))}async OnSceneMetadataChanges(t){}async OnSceneItemsChange(t){this.sceneReady}async OnSceneGridChange(t){}async OnSceneReadyChange(t){}async OnPlayerChange(t){await F.ShowBonesRoll(t.metadata),await F.LogBonesRoll(t.metadata)}async OnPartyChange(t){for await(const s of t)await F.LogBonesRoll(s.metadata)}async OnRoomMetadataChange(){const t=this.roomMetadata[p.DICECOLORSETTING+this.playerId],s=this.roomMetadata[p.DICETEXTURESETTING+this.playerId];t&&(this.playerDiceColor=t),s&&(this.playerDiceTexture=s)}async OnThemeChange(t){me(t,document)}}const O=new E([E.PLAYER,E.PARTY,E.ROOMMETA]),H=(()=>{/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return((f,t,s,o)=>{const d=t.createElement("canvas").getContext("2d"),m={r:0,g:0,b:0,h:0,s:0,v:0,a:1};let g,c,C,b,S,w,R,A,W,ae,U,D,T,Y,x,le,N={};const n={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>o,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},V={};let ne="",q={},z=!1;function Q(e){if(typeof e=="object")for(const a in e)switch(a){case"el":ie(e.el),e.wrap!==!1&&J(e.el);break;case"parent":g=t.querySelector(e.parent),g&&(g.appendChild(c),n.parent=e.parent,g===t.body&&(g=o));break;case"themeMode":n.themeMode=e.themeMode,e.themeMode==="auto"&&f.matchMedia&&f.matchMedia("(prefers-color-scheme: dark)").matches&&(n.themeMode="dark");case"theme":e.theme&&(n.theme=e.theme),c.className=`clr-picker clr-${n.theme} clr-${n.themeMode}`,n.inline&&j();break;case"rtl":n.rtl=!!e.rtl,t.querySelectorAll(".clr-field").forEach(r=>r.classList.toggle("clr-rtl",n.rtl));break;case"margin":e.margin*=1,n.margin=isNaN(e.margin)?n.margin:e.margin;break;case"wrap":e.el&&e.wrap&&J(e.el);break;case"formatToggle":n.formatToggle=!!e.formatToggle,L("clr-format").style.display=n.formatToggle?"block":"none",n.formatToggle&&(n.format="auto");break;case"swatches":if(Array.isArray(e.swatches)){const r=[];e.swatches.forEach((u,v)=>{r.push(`<button type="button" id="clr-swatch-${v}" aria-labelledby="clr-swatch-label clr-swatch-${v}" style="color: ${u};">${u}</button>`)}),L("clr-swatches").innerHTML=r.length?`<div>${r.join("")}</div>`:"",n.swatches=e.swatches.slice()}break;case"swatchesOnly":n.swatchesOnly=!!e.swatchesOnly,c.setAttribute("data-minimal",n.swatchesOnly);break;case"alpha":n.alpha=!!e.alpha,c.setAttribute("data-alpha",n.alpha);break;case"inline":if(n.inline=!!e.inline,c.setAttribute("data-inline",n.inline),n.inline){const r=e.defaultColor||n.defaultColor;Y=re(r),j(),K(r)}break;case"clearButton":typeof e.clearButton=="object"&&(e.clearButton.label&&(n.clearLabel=e.clearButton.label,R.innerHTML=n.clearLabel),e.clearButton=e.clearButton.show),n.clearButton=!!e.clearButton,R.style.display=n.clearButton?"block":"none";break;case"clearLabel":n.clearLabel=e.clearLabel,R.innerHTML=n.clearLabel;break;case"closeButton":n.closeButton=!!e.closeButton,n.closeButton?c.insertBefore(A,S):S.appendChild(A);break;case"closeLabel":n.closeLabel=e.closeLabel,A.innerHTML=n.closeLabel;break;case"a11y":const l=e.a11y;let i=!1;if(typeof l=="object")for(const r in l)l[r]&&n.a11y[r]&&(n.a11y[r]=l[r],i=!0);if(i){const r=L("clr-open-label"),u=L("clr-swatch-label");r.innerHTML=n.a11y.open,u.innerHTML=n.a11y.swatch,A.setAttribute("aria-label",n.a11y.close),R.setAttribute("aria-label",n.a11y.clear),W.setAttribute("aria-label",n.a11y.hueSlider),U.setAttribute("aria-label",n.a11y.alphaSlider),w.setAttribute("aria-label",n.a11y.input),C.setAttribute("aria-label",n.a11y.instruction)}break;default:n[a]=e[a]}}function ve(e,a){typeof e=="string"&&typeof a=="object"&&(V[e]=a,z=!0)}function Ee(e){delete V[e],Object.keys(V).length===0&&(z=!1,e===ne&&se())}function de(e){if(z){const a=["el","wrap","rtl","inline","defaultColor","a11y"];for(let l in V){const i=V[l];if(e.matches(l)){ne=l,q={},a.forEach(r=>delete i[r]);for(let r in i)q[r]=Array.isArray(n[r])?n[r].slice():n[r];Q(i);break}}}}function se(){Object.keys(q).length>0&&(Q(q),ne="",q={})}function ie(e){y(t,"click",e,a=>{n.inline||(de(a.target),T=a.target,x=T.value,Y=re(x),c.classList.add("clr-open"),j(),K(x),(n.focusInput||n.selectInput)&&(w.focus({preventScroll:!0}),w.setSelectionRange(T.selectionStart,T.selectionEnd)),n.selectInput&&w.select(),(le||n.swatchesOnly)&&pe().shift().focus(),T.dispatchEvent(new Event("open",{bubbles:!0})))}),y(t,"input",e,a=>{const l=a.target.parentNode;l.classList.contains("clr-field")&&(l.style.color=a.target.value)})}function j(){if(!c||!T&&!n.inline)return;const e=g,a=f.scrollY,l=c.offsetWidth,i=c.offsetHeight,r={left:!1,top:!1};let u,v,k,I={x:0,y:0};if(e&&(u=f.getComputedStyle(e),v=parseFloat(u.marginTop),k=parseFloat(u.borderTopWidth),I=e.getBoundingClientRect(),I.y+=k+a),!n.inline){const M=T.getBoundingClientRect();let P=M.x,G=a+M.y+M.height+n.margin;e?(P-=I.x,G-=I.y,P+l>e.clientWidth&&(P+=M.width-l,r.left=!0),G+i>e.clientHeight-v&&i+n.margin<=M.top-(I.y-a)&&(G-=M.height+i+n.margin*2,r.top=!0),G+=e.scrollTop):(P+l>t.documentElement.clientWidth&&(P+=M.width-l,r.left=!0),G+i-a>t.documentElement.clientHeight&&i+n.margin<=M.top&&(G=a+M.y-i-n.margin,r.top=!0)),c.classList.toggle("clr-left",r.left),c.classList.toggle("clr-top",r.top),c.style.left=`${P}px`,c.style.top=`${G}px`,I.x+=c.offsetLeft,I.y+=c.offsetTop}N={width:C.offsetWidth,height:C.offsetHeight,x:C.offsetLeft+I.x,y:C.offsetTop+I.y}}function J(e){t.querySelectorAll(e).forEach(a=>{const l=a.parentNode;if(!l.classList.contains("clr-field")){const i=t.createElement("div");let r="clr-field";(n.rtl||a.classList.contains("clr-rtl"))&&(r+=" clr-rtl"),i.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',l.insertBefore(i,a),i.setAttribute("class",r),i.style.color=a.value,i.appendChild(a)}})}function X(e){if(T&&!n.inline){const a=T;e&&(T=o,x!==a.value&&(a.value=x,a.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{x!==a.value&&a.dispatchEvent(new Event("change",{bubbles:!0}))}),c.classList.remove("clr-open"),z&&se(),a.dispatchEvent(new Event("close",{bubbles:!0})),n.focusInput&&a.focus({preventScroll:!0}),T=o}}function K(e){const a=Le(e),l=Oe(a);ue(l.s,l.v),Z(a,l),W.value=l.h,c.style.color=`hsl(${l.h}, 100%, 50%)`,ae.style.left=`${l.h/360*100}%`,b.style.left=`${N.width*l.s/100}px`,b.style.top=`${N.height-N.height*l.v/100}px`,U.value=l.a*100,D.style.left=`${l.a*100}%`}function re(e){const a=e.substring(0,3).toLowerCase();return a==="rgb"||a==="hsl"?a:"hex"}function $(e){e=e!==o?e:w.value,T&&(T.value=e,T.dispatchEvent(new Event("input",{bubbles:!0}))),n.onChange&&n.onChange.call(f,e,T),t.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:e,currentEl:T}}))}function he(e,a){const l={h:W.value*1,s:e/N.width*100,v:100-a/N.height*100,a:U.value/100},i=Ce(l);ue(l.s,l.v),Z(i,l),$()}function ue(e,a){let l=n.a11y.marker;e=e.toFixed(1)*1,a=a.toFixed(1)*1,l=l.replace("{s}",e),l=l.replace("{v}",a),b.setAttribute("aria-label",l)}function be(e){return{pageX:e.changedTouches?e.changedTouches[0].pageX:e.pageX,pageY:e.changedTouches?e.changedTouches[0].pageY:e.pageY}}function B(e){const a=be(e);let l=a.pageX-N.x,i=a.pageY-N.y;g&&(i+=g.scrollTop),fe(l,i),e.preventDefault(),e.stopPropagation()}function we(e,a){let l=b.style.left.replace("px","")*1+e,i=b.style.top.replace("px","")*1+a;fe(l,i)}function fe(e,a){e=e<0?0:e>N.width?N.width:e,a=a<0?0:a>N.height?N.height:a,b.style.left=`${e}px`,b.style.top=`${a}px`,he(e,a),b.focus()}function Z(e,a){e===void 0&&(e={}),a===void 0&&(a={});let l=n.format;for(const u in e)m[u]=e[u];for(const u in a)m[u]=a[u];const i=Re(m),r=i.substring(0,7);switch(b.style.color=r,D.parentNode.style.color=r,D.style.color=i,S.style.color=i,C.style.display="none",C.offsetHeight,C.style.display="",D.nextElementSibling.style.display="none",D.nextElementSibling.offsetHeight,D.nextElementSibling.style.display="",l==="mixed"?l=m.a===1?"hex":"rgb":l==="auto"&&(l=Y),l){case"hex":w.value=i;break;case"rgb":w.value=Me(m);break;case"hsl":w.value=Ne(Se(m));break}t.querySelector(`.clr-format [value="${l}"]`).checked=!0}function Te(){const e=W.value*1,a=b.style.left.replace("px","")*1,l=b.style.top.replace("px","")*1;c.style.color=`hsl(${e}, 100%, 50%)`,ae.style.left=`${e/360*100}%`,he(a,l)}function Ie(){const e=U.value/100;D.style.left=`${e*100}%`,Z({a:e}),$()}function Ce(e){const a=e.s/100,l=e.v/100;let i=a*l,r=e.h/60,u=i*(1-s.abs(r%2-1)),v=l-i;i=i+v,u=u+v;const k=s.floor(r)%6,I=[i,u,v,v,u,i][k],M=[u,i,i,u,v,v][k],P=[v,v,u,i,i,u][k];return{r:s.round(I*255),g:s.round(M*255),b:s.round(P*255),a:e.a}}function Se(e){const a=e.v/100,l=a*(1-e.s/100/2);let i;return l>0&&l<1&&(i=s.round((a-l)/s.min(l,1-l)*100)),{h:e.h,s:i||0,l:s.round(l*100),a:e.a}}function Oe(e){const a=e.r/255,l=e.g/255,i=e.b/255,r=s.max(a,l,i),u=s.min(a,l,i),v=r-u,k=r;let I=0,M=0;return v&&(r===a&&(I=(l-i)/v),r===l&&(I=2+(i-a)/v),r===i&&(I=4+(a-l)/v),r&&(M=v/r)),I=s.floor(I*60),{h:I<0?I+360:I,s:s.round(M*100),v:s.round(k*100),a:e.a}}function Le(e){const a=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i;let l,i;return d.fillStyle="#000",d.fillStyle=e,l=a.exec(d.fillStyle),l?(i={r:l[3]*1,g:l[4]*1,b:l[5]*1,a:l[6]*1},i.a=+i.a.toFixed(2)):(l=d.fillStyle.replace("#","").match(/.{2}/g).map(r=>parseInt(r,16)),i={r:l[0],g:l[1],b:l[2],a:1}),i}function Re(e){let a=e.r.toString(16),l=e.g.toString(16),i=e.b.toString(16),r="";if(e.r<16&&(a="0"+a),e.g<16&&(l="0"+l),e.b<16&&(i="0"+i),n.alpha&&(e.a<1||n.forceAlpha)){const u=e.a*255|0;r=u.toString(16),u<16&&(r="0"+r)}return"#"+a+l+i+r}function Me(e){return!n.alpha||e.a===1&&!n.forceAlpha?`rgb(${e.r}, ${e.g}, ${e.b})`:`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`}function Ne(e){return!n.alpha||e.a===1&&!n.forceAlpha?`hsl(${e.h}, ${e.s}%, ${e.l}%)`:`hsla(${e.h}, ${e.s}%, ${e.l}%, ${e.a})`}function ke(){t.getElementById("clr-picker")||(g=o,c=t.createElement("div"),c.setAttribute("id","clr-picker"),c.className="clr-picker",c.innerHTML=`<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="${n.a11y.input}"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="${n.a11y.instruction}"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="${n.a11y.hueSlider}"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="${n.a11y.alphaSlider}"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>${n.a11y.format}</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear" aria-label="${n.a11y.clear}">${n.clearLabel}</button><div id="clr-color-preview" class="clr-preview"><button type="button" id="clr-close" class="clr-close" aria-label="${n.a11y.close}">${n.closeLabel}</button></div><span id="clr-open-label" hidden>${n.a11y.open}</span><span id="clr-swatch-label" hidden>${n.a11y.swatch}</span>`,t.body.appendChild(c),C=L("clr-color-area"),b=L("clr-color-marker"),R=L("clr-clear"),A=L("clr-close"),S=L("clr-color-preview"),w=L("clr-color-value"),W=L("clr-hue-slider"),ae=L("clr-hue-marker"),U=L("clr-alpha-slider"),D=L("clr-alpha-marker"),ie(n.el),J(n.el),y(c,"mousedown",e=>{c.classList.remove("clr-keyboard-nav"),e.stopPropagation()}),y(C,"mousedown",e=>{y(t,"mousemove",B)}),y(C,"touchstart",e=>{t.addEventListener("touchmove",B,{passive:!1})}),y(b,"mousedown",e=>{y(t,"mousemove",B)}),y(b,"touchstart",e=>{t.addEventListener("touchmove",B,{passive:!1})}),y(w,"change",e=>{const a=w.value;if(T||n.inline){const l=a===""?a:K(a);$(l)}}),y(R,"click",e=>{$(""),X()}),y(A,"click",e=>{$(),X()}),y(L("clr-format"),"click",".clr-format input",e=>{Y=e.target.value,Z(),$()}),y(c,"click",".clr-swatches button",e=>{K(e.target.textContent),$(),n.swatchesOnly&&X()}),y(t,"mouseup",e=>{t.removeEventListener("mousemove",B)}),y(t,"touchend",e=>{t.removeEventListener("touchmove",B)}),y(t,"mousedown",e=>{le=!1,c.classList.remove("clr-keyboard-nav"),X()}),y(t,"keydown",e=>{const a=e.key,l=e.target,i=e.shiftKey;if(a==="Escape"?X(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(a)&&(le=!0,c.classList.add("clr-keyboard-nav")),a==="Tab"&&l.matches(".clr-picker *")){const u=pe(),v=u.shift(),k=u.pop();i&&l===v?(k.focus(),e.preventDefault()):!i&&l===k&&(v.focus(),e.preventDefault())}}),y(t,"click",".clr-field button",e=>{z&&se(),e.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),y(b,"keydown",e=>{const a={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(a).includes(e.key)&&(we(...a[e.key]),e.preventDefault())}),y(C,"click",B),y(W,"input",Te),y(U,"input",Ie))}function pe(){return Array.from(c.querySelectorAll("input, button")).filter(l=>!!l.offsetWidth)}function L(e){return t.getElementById(e)}function y(e,a,l,i){const r=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof l=="string"?e.addEventListener(a,u=>{r.call(u.target,l)&&i.call(u.target,u)}):(i=l,e.addEventListener(a,i))}function _(e,a){a=a!==o?a:[],t.readyState!=="loading"?e(...a):t.addEventListener("DOMContentLoaded",()=>{e(...a)})}NodeList!==o&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function Ae(e,a){T=a,x=T.value,de(a),Y=re(e),j(),K(e),$(),x!==e&&T.dispatchEvent(new Event("change",{bubbles:!0}))}const oe=(()=>{const e={init:ke,set:Q,wrap:J,close:X,setInstance:ve,setColor:Ae,removeInstance:Ee,updatePosition:j,ready:_};function a(l){_(()=>{l&&(typeof l=="string"?ie(l):Q(l))})}for(const l in e)a[l]=function(){for(var i=arguments.length,r=new Array(i),u=0;u<i;u++)r[u]=arguments[u];_(e[l],r)};return _(()=>{f.addEventListener("resize",l=>{a.updatePosition()}),f.addEventListener("scroll",l=>{a.updatePosition()})}),a})();return oe.coloris=oe,oe})(window,document,Math)})();H.coloris;H.init;H.set;H.wrap;H.close;H.setInstance;H.removeInstance;H.updatePosition;p.BONESENTRY.innerHTML=`
    <div class="header">Dice Options</div><div id="whatsNew"></div>
    <div style="display:flex; justify-content:space-between;">
        <div id="selectContainer" class="select"></div>
        <div id="colorisContainer" class='coloris-container full'></div>
    </div>
    <div class="header">Dice Log</div>
    <div id="rollContainer"><ul id="rollLog"></ul></div>
    <div id="manualRollContainer">
        <div id="viewToggleContainer"></div>
    </div>
`;let ee,te;h.onReady(async()=>{await O.InitializeCache(),O.SetupHandlers(),Be(),Ge(),$e(),document.getElementById("whatsNew").appendChild(He()),await ye(),setInterval(Pe,2e3)});function $e(){const f=document.getElementById("manualRollContainer"),t=document.getElementById("viewToggleContainer"),s=document.createElement("input");s.type="text",s.placeholder="Custom Roll",s.classList.add("input-button");const o=document.createElement("input");o.id="manualRollSelfButton",o.type="button",o.classList.add("options-button"),o.classList.add("options-hover"),o.value="Self",o.dataset.active=p.FALSE,o.onclick=()=>{o.dataset.active===p.TRUE?(o.dataset.active=p.FALSE,o.classList.remove("options-active")):(o.dataset.active=p.TRUE,o.classList.add("options-active"))};const d=document.createElement("input");d.id="manualRollGMButton",d.type="button",d.classList.add("options-button"),d.classList.add("options-hover"),d.value="GM",d.onclick=()=>{d.dataset.active===p.TRUE?(d.dataset.active=p.FALSE,d.classList.remove("options-active")):(d.dataset.active=p.TRUE,d.classList.add("options-active"))};const m=document.createElement("input");m.id="rollButton",m.type="image",m.src="/dice-twenty.svg",m.onclick=async()=>{await g()},s.onkeydown=async c=>{c.key==="Enter"&&await g()},f.prepend(s),t.appendChild(m),t.appendChild(o),t.appendChild(d);async function g(){const c=s.value;if(c.length>0){const C=o.dataset.active,b=d.dataset.active;let S="ALL";C==="TRUE"&&(S="SELF"),b==="TRUE"&&(S="GM");const w={},R=new Date().toISOString();w[`${p.EXTENSIONID}/metadata_bonesroll`]={notation:c,created:R,senderName:O.playerName,senderId:O.playerId,viewers:S},await h.player.setMetadata(w)}s.value=""}}async function Pe(){const f=await h.viewport.getHeight(),t=await h.viewport.getWidth();(f!==ee||t!==te)&&(await h.popover.close(p.EXTENSIONDICECONTROLLERID),await ye(),ee=f,te=t)}async function ye(){try{await ge()}catch{setTimeout(async()=>{await ge()},2e3)}}async function ge(){ee=await h.viewport.getHeight(),te=await h.viewport.getWidth(),await h.popover.close(p.EXTENSIONDICECONTROLLERID),await h.popover.open({id:p.EXTENSIONDICECONTROLLERID,url:"/dicecontroller.html",height:54,width:54,anchorPosition:{top:ee-75,left:te-20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"RIGHT"},transformOrigin:{vertical:"BOTTOM",horizontal:"RIGHT"},disableClickAway:!0,hidePaper:!0})}function Be(){let f;const t=document.getElementById("colorisContainer"),s=document.createElement("input");s.type="text",s.classList.add("coloris"),s.id="diceColoris",s.value=O.playerDiceColor,s.maxLength=7,s.oninput=async o=>{if(!o||!o.target)return;const d=o.target;clearTimeout(f),f=setTimeout(async()=>{/#[a-f0-9]{6}/.test(d.value)&&await h.room.setMetadata({[p.DICECOLORSETTING+O.playerId]:d.value})},400)},t.appendChild(s),console.log(O.theme.mode),H.init(),H({alpha:!1,theme:"polaroid",closeButton:!0,themeMode:O.theme.mode==="DARK"?"dark":"light",el:"#diceColoris"})}function Ge(){const f=document.getElementById("selectContainer"),t=document.createElement("select");t.id="textureSelect",[{text:"Default",value:"default"},{text:"D.o.R",value:"diceOfRolling"},{text:"Gemstone",value:"gemstone"},{text:"Marble",value:"gemstoneMarble"},{text:"Rocky",value:"rock"},{text:"Rusty",value:"rust"},{text:"Smooth",value:"smooth"},{text:"Wood",value:"wooden"}].forEach(o=>{const d=document.createElement("option");d.setAttribute("value",o.value);const m=document.createTextNode(o.text);d.appendChild(m),t.appendChild(d)}),t.value=O.playerDiceTexture,t.onchange=async o=>{const d=o.currentTarget;await h.room.setMetadata({[p.DICETEXTURESETTING+O.playerId]:d.value})},f.appendChild(t)}
