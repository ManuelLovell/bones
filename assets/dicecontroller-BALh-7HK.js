import{C as p,O as u,b as fe,D as G,a as Le}from"./bsConstants-DvBRfYaJ.js";/* empty css                   */function xe(){const C=document.createElement("img");return C.id="PatreonButton",C.setAttribute("class","icon"),C.classList.add("patreon-clickable"),C.setAttribute("title",E.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),C.setAttribute("src",E.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),C.onclick=async function(t){t.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},C}function re(C,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>{C()},t)}}function me(C,t){const n=window.matchMedia("(prefers-color-scheme: dark)"),g=n.matches?"dark":"light",y=n.matches?"light":"dark";for(var b=0;b<t.styleSheets.length;b++)for(var T=0;T<t.styleSheets[b].cssRules.length;T++){let o=t.styleSheets[b].cssRules[T];o&&o.media&&o.media.mediaText.includes("prefers-color-scheme")&&(C.mode=="LIGHT"?(o.media.appendMedium(`(prefers-color-scheme: ${g})`),o.media.mediaText.includes(y)&&o.media.deleteMedium(`(prefers-color-scheme: ${y})`)):C.mode=="DARK"&&(o.media.appendMedium(`(prefers-color-scheme: ${y})`),o.media.mediaText.includes(g)&&o.media.deleteMedium(`(prefers-color-scheme: ${g})`)))}}class Ne{constructor(t){this.totalSlots=t,this.initializeSlots()}slots=[];initializeSlots(){for(let t=0;t<this.totalSlots;t++)this.slots.push(!0)}occupySlot(){const t=this.slots.findIndex(n=>n);return t!==-1?(this.slots[t]=!1,setTimeout(()=>{this.releaseSlot(t)},3500),t):-1}releaseSlot(t){this.slots[t]=!0}runFunction(){const t=this.occupySlot();return console.log(t!==-1?`Function is running on slot ${t}`:"No available slots. Please try again later."),t}}class Ae{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new Ne(4)}IsThisOld(t,n,g="DEFAULT"){const y=`${n}_${g}`,b=this.messageCounter[y];return b?b!==t?(this.messageCounter[y]=t,!1):!0:(this.messageCounter[y]=t,!1)}async ShowBonesRoll(t){if(t[`${p.EXTENSIONID}/metadata_bonesroll`]!=null){const n=t[`${p.EXTENSIONID}/metadata_bonesroll`];if(!this.IsThisOld(n.created,n.senderId,"ROLL")){const g=await u.viewport.getHeight(),y=await u.viewport.getWidth();await u.modal.open({id:p.EXTENSIONDICEWINDOWID,url:"/dicewindow.html",height:g-100,width:y-50,hidePaper:!0,hideBackdrop:!0,disablePointerEvents:!0})}}}async LogBonesRoll(t){if(t[`${p.EXTENSIONID}/metadata_logroll`]!=null){const n=t[`${p.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(n.created,n.senderId,"LOG"))if(n.senderId===E.playerId||n.viewers===E.playerRole||n.viewers==="ALL"){const g=document.querySelector("#rollLog"),y=n.rollHtml;let b="";n.viewers==="GM"&&(b="[GM]"),n.viewers==="SELF"&&(b="[SELF]");const T=document.createElement("li");if(T.className="dice-log-item dice-notification",T.innerHTML=`[${this.getTimestamp(n.created)}] ${b}<span style="font-weight: bold; color:${n.senderColor};">${n.senderName}</span> => ${y}`,g.append(T),T.scrollIntoView(!1),n.senderId!==E.playerId){const o=await u.viewport.getHeight(),f=encodeURIComponent(y),d=encodeURIComponent(n.senderName);let h=E.party.find(O=>O.id===n.senderId)?.color??"#FFF";const c=encodeURIComponent(h),v=this.queue.runFunction();if(v!==-1){const O=v===0?o-50:o-v*100-50;await u.popover.open({id:p.EXTENSIONNOTIFY+v.toString(),url:`/dicenotify.html?sender=${d}&message=${f}&color=${c}&queue=${encodeURIComponent(v)}`,height:95,width:300,anchorPosition:{top:O,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}else{const g=document.querySelector("#rollLog"),y=document.createElement("li");if(y.className="dice-log-item dice-notification",y.innerHTML=`[${this.getTimestamp(n.created)}]<span style="font-weight: bold; color:${n.senderColor};">${n.senderName}</span> rolled out of view.`,g.append(y),y.scrollIntoView(!1),n.senderId!==E.playerId){const b=await u.viewport.getHeight(),T=encodeURIComponent(" just rolled out of view."),o=encodeURIComponent(n.senderName);let f=E.party.find(c=>c.id===n.senderId)?.color??"#FFF";const d=encodeURIComponent(f),h=this.queue.runFunction();if(h!==-1){const c=h===0?b-50:b-h*100-50;await u.popover.open({id:p.EXTENSIONNOTIFY+h.toString(),url:`/dicenotify.html?sender=${o}&message=${T}&color=${d}&queue=${encodeURIComponent(h)}`,height:95,width:300,anchorPosition:{top:c,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}getTimestamp(t){const n=new Date(t),g=n.getHours().toString().padStart(2,"0"),y=n.getMinutes().toString().padStart(2,"0");return`${g}:${y}`}}const z=new Ae;class I{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerFrontDiceColor;playerDiceTexture;playerDiceZoom;playerMarkers;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;USER_REGISTERED;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(t){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="default",this.playerDiceColor="#ff0000",this.playerFrontDiceColor="#FFFFFF",this.playerDiceZoom=4,this.playerMarkers=!1,this.USER_REGISTERED=!1,this.caches=t,this.debouncedOnSceneItemsChange=re(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=re(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=re(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await u.scene.isReady(),this.theme=await u.theme.getTheme(),me(this.theme,document),this.caches.includes(I.PLAYER)){this.playerId=await u.player.getId(),this.playerName=await u.player.getName(),this.playerColor=await u.player.getColor(),this.playerMetadata=await u.player.getMetadata(),this.playerRole=await u.player.getRole();const t=this.playerMetadata[`${p.EXTENSIONID}/metadata_bonesroll`];t&&z.IsThisOld(t.created,t.senderName,"DEFAULT");const n=this.playerMetadata[`${p.EXTENSIONID}/metadata_logroll`];n&&z.IsThisOld(n.created,n.senderId,"LOG")}if(this.caches.includes(I.PARTY)){this.party=await u.party.getPlayers();for(const t of this.party){const n=t.metadata[`${p.EXTENSIONID}/metadata_bonesroll`];n&&z.IsThisOld(n.created,n.senderName,"DEFAULT");const g=t.metadata[`${p.EXTENSIONID}/metadata_logroll`];g&&z.IsThisOld(g.created,g.senderId,"LOG")}}this.caches.includes(I.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await u.scene.items.getItems()),this.caches.includes(I.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await u.scene.getMetadata()),this.caches.includes(I.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await u.scene.grid.getDpi(),this.gridScale=(await u.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(I.ROOMMETA)&&(this.roomMetadata=await u.room.getMetadata(),this.playerDiceColor=this.roomMetadata[p.DICECOLORSETTING+this.playerId]??"#ff0000",this.playerDiceZoom=this.roomMetadata[p.DICEZOOMSETTING+this.playerId]??4,this.playerMarkers=this.roomMetadata[p.DICEMARKERSETTING+this.playerId]===!0,this.playerFrontDiceColor=this.roomMetadata[p.FRONTDICECOLORSETTING+this.playerId]??"#FFFFFF",this.playerDiceTexture=this.roomMetadata[p.DICETEXTURESETTING+this.playerId]??"default",p.DEFAULTTEXTURES.includes(this.playerDiceTexture)||(this.playerDiceTexture="default")),u.broadcast.onMessage(p.DICETOKENBROADCAST,async t=>{if(!this.playerMarkers)return;const n=this.gridDpi/2,g=t.data,y=[],b=await u.viewport.getWidth(),T=await u.viewport.getHeight(),o=await u.viewport.inverseTransformPoint({x:b/2,y:T/2});function f(O){switch(O){case 4:return G.D4Path(0,0,E.gridDpi);case 6:return G.D6Path(0,0,E.gridDpi);case 8:return G.D8Path(0,0,E.gridDpi);case 10:return G.D10Path(0,0,E.gridDpi);case 12:return G.D12Path(0,0,E.gridDpi);case 20:return G.D20Path(0,0,E.gridDpi);case 100:return G.D100Path(0,0,E.gridDpi);default:return G.D20Path(0,0,E.gridDpi)}}let d=5e-4,h=0,c=0;const v=2;for(const O of g){const D={x:o.x+h,y:o.y+c},P=fe().position(D).commands(G.DiceRimPath(0,0,this.gridDpi)).strokeOpacity(1).strokeWidth(6).strokeColor(this.playerColor).fillOpacity(1).fillColor("black").layer("PROP").zIndex(d+1e-5).build(),H=fe().position(D).commands(f(O.type)).attachedTo(P.id).strokeOpacity(1).strokeWidth(4).strokeColor("#828282").disableHit(!0).layer("PROP").zIndex(d+2e-5).build(),L=Le().attachedTo(P.id).strokeColor("white").strokeOpacity(1).strokeWidth(4).fontWeight(600).fontSize(72).width(E.gridDpi).height(E.gridDpi).position({x:D.x-n,y:D.y-n}).textAlign("CENTER").textAlignVertical("MIDDLE").textType("PLAIN").fillColor("white").fillOpacity(1).plainText(O.value.toString()).disableHit(!0).layer("PROP").zIndex(d+3e-5).build();y.push(P),y.push(H),y.push(L),d+=1,c+=this.gridDpi,c>this.gridDpi*v&&(c=0,h+=this.gridDpi)}await u.scene.items.addItems(y)}),await this.CheckRegistration()}KillHandlers(){this.caches.includes(I.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(I.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(I.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(I.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(I.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(I.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(I.SCENEMETA)&&(this.sceneMetadataHandler=u.scene.onMetadataChange(async t=>{this.sceneMetadata=t,this.debouncedOnSceneMetadataChange(t)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(I.SCENEITEMS)&&(this.sceneItemsHandler=u.scene.items.onChange(async t=>{this.sceneItems=t,this.debouncedOnSceneItemsChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(I.SCENEGRID)&&(this.sceneGridHandler=u.scene.grid.onChange(async t=>{this.gridDpi=t.dpi,this.gridScale=parseInt(t.scale),await this.OnSceneGridChange(t)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(I.PLAYER)&&(this.playerHandler=u.player.onChange(async t=>{this.playerName=t.name,this.playerColor=t.color,this.playerId=t.id,this.playerRole=t.role,this.playerMetadata=t.metadata,await this.OnPlayerChange(t)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(I.PARTY)&&(this.partyHandler=u.party.onChange(async t=>{this.party=t,await this.OnPartyChange(t)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(I.ROOMMETA)&&(this.roomHandler=u.room.onMetadataChange(async t=>{this.roomMetadata=t,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=u.theme.onChange(async t=>{this.theme=t.mode,await this.OnThemeChange(t)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=u.scene.onReadyChange(async t=>{this.sceneReady=t,t&&(this.sceneItems=await u.scene.items.getItems(),this.sceneMetadata=await u.scene.getMetadata(),this.gridDpi=await u.scene.grid.getDpi(),this.gridScale=(await u.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(t)}))}async OnSceneMetadataChanges(t){}async OnSceneItemsChange(t){this.sceneReady}async OnSceneGridChange(t){}async OnSceneReadyChange(t){}async OnPlayerChange(t){await z.ShowBonesRoll(t.metadata),await z.LogBonesRoll(t.metadata)}async OnPartyChange(t){for await(const n of t)await z.LogBonesRoll(n.metadata)}async OnRoomMetadataChange(){const t=this.roomMetadata[p.DICECOLORSETTING+this.playerId],n=this.roomMetadata[p.DICEZOOMSETTING+this.playerId];this.playerMarkers=this.roomMetadata[p.DICEMARKERSETTING+this.playerId]===!0;const g=this.roomMetadata[p.FRONTDICECOLORSETTING+this.playerId],y=this.roomMetadata[p.DICETEXTURESETTING+this.playerId];t&&(this.playerDiceColor=t),g&&(this.playerFrontDiceColor=g),n&&(this.playerDiceZoom=n),y&&(this.playerDiceTexture=y)}async OnThemeChange(t){me(t,document)}async CheckRegistration(){try{const t=window.location.origin.includes("localhost")?"eternaldream":"",n={owlbearid:E.playerId},g={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:p.ANONAUTH,"x-manuel":t}),body:JSON.stringify(n)},y=await fetch(p.CHECKREGISTRATION,g);if(!y.ok){const T=await y.json();console.error("Error:",T);return}(await y.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(t){console.error("Error:",t)}}}const E=new I([I.PLAYER,I.PARTY,I.SCENEGRID,I.ROOMMETA]),$=(()=>{/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return((C,t,n,g)=>{const y=t.createElement("canvas").getContext("2d"),b={r:0,g:0,b:0,h:0,s:0,v:0,a:1};let T,o,f,d,h,c,v,O,D,P,H,L,w,X,F,ae,N={};const s={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>g,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},K={};let ie="",V={},j=!1;function Q(e){if(typeof e=="object")for(const a in e)switch(a){case"el":le(e.el),e.wrap!==!1&&_(e.el);break;case"parent":T=t.querySelector(e.parent),T&&(T.appendChild(o),s.parent=e.parent,T===t.body&&(T=g));break;case"themeMode":s.themeMode=e.themeMode,e.themeMode==="auto"&&C.matchMedia&&C.matchMedia("(prefers-color-scheme: dark)").matches&&(s.themeMode="dark");case"theme":e.theme&&(s.theme=e.theme),o.className=`clr-picker clr-${s.theme} clr-${s.themeMode}`,s.inline&&Z();break;case"rtl":s.rtl=!!e.rtl,t.querySelectorAll(".clr-field").forEach(r=>r.classList.toggle("clr-rtl",s.rtl));break;case"margin":e.margin*=1,s.margin=isNaN(e.margin)?s.margin:e.margin;break;case"wrap":e.el&&e.wrap&&_(e.el);break;case"formatToggle":s.formatToggle=!!e.formatToggle,M("clr-format").style.display=s.formatToggle?"block":"none",s.formatToggle&&(s.format="auto");break;case"swatches":if(Array.isArray(e.swatches)){const r=[];e.swatches.forEach((m,R)=>{r.push(`<button type="button" id="clr-swatch-${R}" aria-labelledby="clr-swatch-label clr-swatch-${R}" style="color: ${m};">${m}</button>`)}),M("clr-swatches").innerHTML=r.length?`<div>${r.join("")}</div>`:"",s.swatches=e.swatches.slice()}break;case"swatchesOnly":s.swatchesOnly=!!e.swatchesOnly,o.setAttribute("data-minimal",s.swatchesOnly);break;case"alpha":s.alpha=!!e.alpha,o.setAttribute("data-alpha",s.alpha);break;case"inline":if(s.inline=!!e.inline,o.setAttribute("data-inline",s.inline),s.inline){const r=e.defaultColor||s.defaultColor;X=ne(r),Z(),J(r)}break;case"clearButton":typeof e.clearButton=="object"&&(e.clearButton.label&&(s.clearLabel=e.clearButton.label,v.innerHTML=s.clearLabel),e.clearButton=e.clearButton.show),s.clearButton=!!e.clearButton,v.style.display=s.clearButton?"block":"none";break;case"clearLabel":s.clearLabel=e.clearLabel,v.innerHTML=s.clearLabel;break;case"closeButton":s.closeButton=!!e.closeButton,s.closeButton?o.insertBefore(O,h):h.appendChild(O);break;case"closeLabel":s.closeLabel=e.closeLabel,O.innerHTML=s.closeLabel;break;case"a11y":const i=e.a11y;let l=!1;if(typeof i=="object")for(const r in i)i[r]&&s.a11y[r]&&(s.a11y[r]=i[r],l=!0);if(l){const r=M("clr-open-label"),m=M("clr-swatch-label");r.innerHTML=s.a11y.open,m.innerHTML=s.a11y.swatch,O.setAttribute("aria-label",s.a11y.close),v.setAttribute("aria-label",s.a11y.clear),D.setAttribute("aria-label",s.a11y.hueSlider),H.setAttribute("aria-label",s.a11y.alphaSlider),c.setAttribute("aria-label",s.a11y.input),f.setAttribute("aria-label",s.a11y.instruction)}break;default:s[a]=e[a]}}function ye(e,a){typeof e=="string"&&typeof a=="object"&&(K[e]=a,j=!0)}function ge(e){delete K[e],Object.keys(K).length===0&&(j=!1,e===ie&&se())}function ce(e){if(j){const a=["el","wrap","rtl","inline","defaultColor","a11y"];for(let i in K){const l=K[i];if(e.matches(i)){ie=i,V={},a.forEach(r=>delete l[r]);for(let r in l)V[r]=Array.isArray(s[r])?s[r].slice():s[r];Q(l);break}}}}function se(){Object.keys(V).length>0&&(Q(V),ie="",V={})}function le(e){S(t,"click",e,a=>{s.inline||(ce(a.target),w=a.target,F=w.value,X=ne(F),o.classList.add("clr-open"),Z(),J(F),(s.focusInput||s.selectInput)&&(c.focus({preventScroll:!0}),c.setSelectionRange(w.selectionStart,w.selectionEnd)),s.selectInput&&c.select(),(ae||s.swatchesOnly)&&pe().shift().focus(),w.dispatchEvent(new Event("open",{bubbles:!0})))}),S(t,"input",e,a=>{const i=a.target.parentNode;i.classList.contains("clr-field")&&(i.style.color=a.target.value)})}function Z(){if(!o||!w&&!s.inline)return;const e=T,a=C.scrollY,i=o.offsetWidth,l=o.offsetHeight,r={left:!1,top:!1};let m,R,A,k={x:0,y:0};if(e&&(m=C.getComputedStyle(e),R=parseFloat(m.marginTop),A=parseFloat(m.borderTopWidth),k=e.getBoundingClientRect(),k.y+=A+a),!s.inline){const x=w.getBoundingClientRect();let U=x.x,W=a+x.y+x.height+s.margin;e?(U-=k.x,W-=k.y,U+i>e.clientWidth&&(U+=x.width-i,r.left=!0),W+l>e.clientHeight-R&&l+s.margin<=x.top-(k.y-a)&&(W-=x.height+l+s.margin*2,r.top=!0),W+=e.scrollTop):(U+i>t.documentElement.clientWidth&&(U+=x.width-i,r.left=!0),W+l-a>t.documentElement.clientHeight&&l+s.margin<=x.top&&(W=a+x.y-l-s.margin,r.top=!0)),o.classList.toggle("clr-left",r.left),o.classList.toggle("clr-top",r.top),o.style.left=`${U}px`,o.style.top=`${W}px`,k.x+=o.offsetLeft,k.y+=o.offsetTop}N={width:f.offsetWidth,height:f.offsetHeight,x:f.offsetLeft+k.x,y:f.offsetTop+k.y}}function _(e){t.querySelectorAll(e).forEach(a=>{const i=a.parentNode;if(!i.classList.contains("clr-field")){const l=t.createElement("div");let r="clr-field";(s.rtl||a.classList.contains("clr-rtl"))&&(r+=" clr-rtl"),l.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',i.insertBefore(l,a),l.setAttribute("class",r),l.style.color=a.value,l.appendChild(a)}})}function q(e){if(w&&!s.inline){const a=w;e&&(w=g,F!==a.value&&(a.value=F,a.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{F!==a.value&&a.dispatchEvent(new Event("change",{bubbles:!0}))}),o.classList.remove("clr-open"),j&&se(),a.dispatchEvent(new Event("close",{bubbles:!0})),s.focusInput&&a.focus({preventScroll:!0}),w=g}}function J(e){const a=Se(e),i=we(a);he(i.s,i.v),ee(a,i),D.value=i.h,o.style.color=`hsl(${i.h}, 100%, 50%)`,P.style.left=`${i.h/360*100}%`,d.style.left=`${N.width*i.s/100}px`,d.style.top=`${N.height-N.height*i.v/100}px`,H.value=i.a*100,L.style.left=`${i.a*100}%`}function ne(e){const a=e.substring(0,3).toLowerCase();return a==="rgb"||a==="hsl"?a:"hex"}function B(e){e=e!==g?e:c.value,w&&(w.value=e,w.dispatchEvent(new Event("input",{bubbles:!0}))),s.onChange&&s.onChange.call(C,e,w),t.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:e,currentEl:w}}))}function de(e,a){const i={h:D.value*1,s:e/N.width*100,v:100-a/N.height*100,a:H.value/100},l=Ie(i);he(i.s,i.v),ee(l,i),B()}function he(e,a){let i=s.a11y.marker;e=e.toFixed(1)*1,a=a.toFixed(1)*1,i=i.replace("{s}",e),i=i.replace("{v}",a),d.setAttribute("aria-label",i)}function Ee(e){return{pageX:e.changedTouches?e.changedTouches[0].pageX:e.pageX,pageY:e.changedTouches?e.changedTouches[0].pageY:e.pageY}}function Y(e){const a=Ee(e);let i=a.pageX-N.x,l=a.pageY-N.y;T&&(l+=T.scrollTop),ue(i,l),e.preventDefault(),e.stopPropagation()}function ve(e,a){let i=d.style.left.replace("px","")*1+e,l=d.style.top.replace("px","")*1+a;ue(i,l)}function ue(e,a){e=e<0?0:e>N.width?N.width:e,a=a<0?0:a>N.height?N.height:a,d.style.left=`${e}px`,d.style.top=`${a}px`,de(e,a),d.focus()}function ee(e,a){e===void 0&&(e={}),a===void 0&&(a={});let i=s.format;for(const m in e)b[m]=e[m];for(const m in a)b[m]=a[m];const l=Re(b),r=l.substring(0,7);switch(d.style.color=r,L.parentNode.style.color=r,L.style.color=l,h.style.color=l,f.style.display="none",f.offsetHeight,f.style.display="",L.nextElementSibling.style.display="none",L.nextElementSibling.offsetHeight,L.nextElementSibling.style.display="",i==="mixed"?i=b.a===1?"hex":"rgb":i==="auto"&&(i=X),i){case"hex":c.value=l;break;case"rgb":c.value=Oe(b);break;case"hsl":c.value=ke(Ce(b));break}t.querySelector(`.clr-format [value="${i}"]`).checked=!0}function be(){const e=D.value*1,a=d.style.left.replace("px","")*1,i=d.style.top.replace("px","")*1;o.style.color=`hsl(${e}, 100%, 50%)`,P.style.left=`${e/360*100}%`,de(a,i)}function Te(){const e=H.value/100;L.style.left=`${e*100}%`,ee({a:e}),B()}function Ie(e){const a=e.s/100,i=e.v/100;let l=a*i,r=e.h/60,m=l*(1-n.abs(r%2-1)),R=i-l;l=l+R,m=m+R;const A=n.floor(r)%6,k=[l,m,R,R,m,l][A],x=[m,l,l,m,R,R][A],U=[R,R,m,l,l,m][A];return{r:n.round(k*255),g:n.round(x*255),b:n.round(U*255),a:e.a}}function Ce(e){const a=e.v/100,i=a*(1-e.s/100/2);let l;return i>0&&i<1&&(l=n.round((a-i)/n.min(i,1-i)*100)),{h:e.h,s:l||0,l:n.round(i*100),a:e.a}}function we(e){const a=e.r/255,i=e.g/255,l=e.b/255,r=n.max(a,i,l),m=n.min(a,i,l),R=r-m,A=r;let k=0,x=0;return R&&(r===a&&(k=(i-l)/R),r===i&&(k=2+(l-a)/R),r===l&&(k=4+(a-i)/R),r&&(x=R/r)),k=n.floor(k*60),{h:k<0?k+360:k,s:n.round(x*100),v:n.round(A*100),a:e.a}}function Se(e){const a=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i;let i,l;return y.fillStyle="#000",y.fillStyle=e,i=a.exec(y.fillStyle),i?(l={r:i[3]*1,g:i[4]*1,b:i[5]*1,a:i[6]*1},l.a=+l.a.toFixed(2)):(i=y.fillStyle.replace("#","").match(/.{2}/g).map(r=>parseInt(r,16)),l={r:i[0],g:i[1],b:i[2],a:1}),l}function Re(e){let a=e.r.toString(16),i=e.g.toString(16),l=e.b.toString(16),r="";if(e.r<16&&(a="0"+a),e.g<16&&(i="0"+i),e.b<16&&(l="0"+l),s.alpha&&(e.a<1||s.forceAlpha)){const m=e.a*255|0;r=m.toString(16),m<16&&(r="0"+r)}return"#"+a+i+l+r}function Oe(e){return!s.alpha||e.a===1&&!s.forceAlpha?`rgb(${e.r}, ${e.g}, ${e.b})`:`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`}function ke(e){return!s.alpha||e.a===1&&!s.forceAlpha?`hsl(${e.h}, ${e.s}%, ${e.l}%)`:`hsla(${e.h}, ${e.s}%, ${e.l}%, ${e.a})`}function De(){t.getElementById("clr-picker")||(T=g,o=t.createElement("div"),o.setAttribute("id","clr-picker"),o.className="clr-picker",o.innerHTML=`<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="${s.a11y.input}"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="${s.a11y.instruction}"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="${s.a11y.hueSlider}"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="${s.a11y.alphaSlider}"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>${s.a11y.format}</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear" aria-label="${s.a11y.clear}">${s.clearLabel}</button><div id="clr-color-preview" class="clr-preview"><button type="button" id="clr-close" class="clr-close" aria-label="${s.a11y.close}">${s.closeLabel}</button></div><span id="clr-open-label" hidden>${s.a11y.open}</span><span id="clr-swatch-label" hidden>${s.a11y.swatch}</span>`,t.body.appendChild(o),f=M("clr-color-area"),d=M("clr-color-marker"),v=M("clr-clear"),O=M("clr-close"),h=M("clr-color-preview"),c=M("clr-color-value"),D=M("clr-hue-slider"),P=M("clr-hue-marker"),H=M("clr-alpha-slider"),L=M("clr-alpha-marker"),le(s.el),_(s.el),S(o,"mousedown",e=>{o.classList.remove("clr-keyboard-nav"),e.stopPropagation()}),S(f,"mousedown",e=>{S(t,"mousemove",Y)}),S(f,"touchstart",e=>{t.addEventListener("touchmove",Y,{passive:!1})}),S(d,"mousedown",e=>{S(t,"mousemove",Y)}),S(d,"touchstart",e=>{t.addEventListener("touchmove",Y,{passive:!1})}),S(c,"change",e=>{const a=c.value;if(w||s.inline){const i=a===""?a:J(a);B(i)}}),S(v,"click",e=>{B(""),q()}),S(O,"click",e=>{B(),q()}),S(M("clr-format"),"click",".clr-format input",e=>{X=e.target.value,ee(),B()}),S(o,"click",".clr-swatches button",e=>{J(e.target.textContent),B(),s.swatchesOnly&&q()}),S(t,"mouseup",e=>{t.removeEventListener("mousemove",Y)}),S(t,"touchend",e=>{t.removeEventListener("touchmove",Y)}),S(t,"mousedown",e=>{ae=!1,o.classList.remove("clr-keyboard-nav"),q()}),S(t,"keydown",e=>{const a=e.key,i=e.target,l=e.shiftKey;if(a==="Escape"?q(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(a)&&(ae=!0,o.classList.add("clr-keyboard-nav")),a==="Tab"&&i.matches(".clr-picker *")){const m=pe(),R=m.shift(),A=m.pop();l&&i===R?(A.focus(),e.preventDefault()):!l&&i===A&&(R.focus(),e.preventDefault())}}),S(t,"click",".clr-field button",e=>{j&&se(),e.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),S(d,"keydown",e=>{const a={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(a).includes(e.key)&&(ve(...a[e.key]),e.preventDefault())}),S(f,"click",Y),S(D,"input",be),S(H,"input",Te))}function pe(){return Array.from(o.querySelectorAll("input, button")).filter(i=>!!i.offsetWidth)}function M(e){return t.getElementById(e)}function S(e,a,i,l){const r=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof i=="string"?e.addEventListener(a,m=>{r.call(m.target,i)&&l.call(m.target,m)}):(l=i,e.addEventListener(a,l))}function te(e,a){a=a!==g?a:[],t.readyState!=="loading"?e(...a):t.addEventListener("DOMContentLoaded",()=>{e(...a)})}NodeList!==g&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function Me(e,a){w=a,F=w.value,ce(a),X=ne(e),Z(),J(e),B(),F!==e&&w.dispatchEvent(new Event("change",{bubbles:!0}))}const oe=(()=>{const e={init:De,set:Q,wrap:_,close:q,setInstance:ye,setColor:Me,removeInstance:ge,updatePosition:Z,ready:te};function a(i){te(()=>{i&&(typeof i=="string"?le(i):Q(i))})}for(const i in e)a[i]=function(){for(var l=arguments.length,r=new Array(l),m=0;m<l;m++)r[m]=arguments[m];te(e[i],r)};return te(()=>{C.addEventListener("resize",i=>{a.updatePosition()}),C.addEventListener("scroll",i=>{a.updatePosition()})}),a})();return oe.coloris=oe,oe})(window,document,Math)})();$.coloris;$.init;$.set;$.wrap;$.close;$.setInstance;$.removeInstance;$.updatePosition;p.BONESENTRY.innerHTML=`    
    <div class="header"><span style="float:left;" id="optionsToggle">▼</span>Dice Options</div><div id="patreonContainer"></div>
    <div id="optionsContainer">
        <div style="display:flex; justify-content:space-between;">
            <div id="selectContainer" class="select"></div>
            <div class="container">
                <label class="switch" for="diceMarkerToggle">
                    <input type="checkbox" id="diceMarkerToggle" />
                    <div class="slider round"></div>
                </label>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between;">
            <div id="zoomContainer" class="select"></div>
            <div id="backColorisContainer" class='coloris-container full'></div>
        </div>
    </div>
    <div class="header"><span style="float:left;" id="rollToggle">▼</span>Dice Log</div>
    <div id="rollContainer"><ul id="rollLog"></ul></div>
    <div class="header"><span style="float:left;" id="manualRollToggle">▼</span>Custom Rolls</div>
    <div id="manualRollContainer">
        <div id="viewToggleContainer"></div>
    </div>`;u.onReady(async()=>{await E.InitializeCache(),E.SetupHandlers(),g(),T(),b(),y(),n(),document.getElementById("patreonContainer").appendChild(xe()),t("optionsToggle","optionsContainer",50,"block"),t("rollToggle","rollContainer",160,"block"),t("manualRollToggle","manualRollContainer",31,"flex");function t(o,f,d,h){const c=document.getElementById(o);c.style.cursor="pointer";const v=document.getElementById(f);c.onclick=async()=>{const O=await u.popover.getHeight(p.EXTENSIONDICECONTROLLERID);v.style.display!=="none"?(c.innerText="▶",await u.popover.setHeight(p.EXTENSIONDICECONTROLLERID,O-d),v.style.display="none"):(c.innerText="▼",await u.popover.setHeight(p.EXTENSIONDICECONTROLLERID,O+d),v.style.display=h)}}function n(){const o=document.getElementById("manualRollContainer"),f=document.getElementById("viewToggleContainer"),d=document.createElement("input");d.type="text",d.placeholder="Custom Roll",d.classList.add("input-button");const h=document.createElement("input");h.id="manualRollSelfButton",h.type="button",h.classList.add("options-button"),h.classList.add("options-hover"),h.value="Self",h.dataset.active=p.FALSE,h.onclick=()=>{h.dataset.active===p.TRUE?(h.dataset.active=p.FALSE,h.classList.remove("options-active")):(h.dataset.active=p.TRUE,h.classList.add("options-active"))};const c=document.createElement("input");c.id="manualRollGMButton",c.type="button",c.classList.add("options-button"),c.classList.add("options-hover"),c.value="GM",c.onclick=()=>{c.dataset.active===p.TRUE?(c.dataset.active=p.FALSE,c.classList.remove("options-active")):(c.dataset.active=p.TRUE,c.classList.add("options-active"))};const v=document.createElement("input");v.id="rollButton",v.type="image",v.src="/dice-twenty.svg",v.onclick=async()=>{await O()},d.onkeydown=async D=>{D.key==="Enter"&&await O()},o.prepend(d),f.appendChild(v),f.appendChild(h),f.appendChild(c);async function O(){const D=d.value;if(D.length>0){const P=h.dataset.active,H=c.dataset.active;let L="ALL";P==="TRUE"&&(L="SELF"),H==="TRUE"&&(L="GM");const w={},X=new Date().toISOString();w[`${p.EXTENSIONID}/metadata_bonesroll`]={notation:D,created:X,senderName:E.playerName,senderId:E.playerId,viewers:L},await u.player.setMetadata(w)}d.value=""}}function g(){let o;const f=document.getElementById("backColorisContainer"),d=document.createElement("input");d.type="text",d.classList.add("coloris"),d.id="diceColoris",d.value=E.playerDiceColor,d.maxLength=7,d.oninput=async h=>{if(!h||!h.target)return;const c=h.target;clearTimeout(o),o=setTimeout(async()=>{/#[a-f0-9]{6}/.test(c.value)&&await u.room.setMetadata({[p.DICECOLORSETTING+E.playerId]:c.value})},400)},f.appendChild(d),$.init(),$({alpha:!1,theme:"polaroid",closeButton:!0,themeMode:E.theme.mode==="DARK"?"dark":"light",el:"#diceColoris"})}function y(){const o=document.getElementById("zoomContainer"),f=document.createElement("select");f.id="zoomSelect",[{text:"25%",value:"1"},{text:"50%",value:"2"},{text:"75%",value:"3"},{text:"100%",value:"4"},{text:"125%",value:"5"},{text:"150%",value:"6"},{text:"175%",value:"7"},{text:"200%",value:"8"}].forEach(h=>{const c=document.createElement("option");c.setAttribute("value",h.value);const v=document.createTextNode(h.text);c.appendChild(v),f.appendChild(c)}),f.value=E.playerDiceZoom.toString(),f.onchange=async h=>{const c=h.currentTarget;await u.room.setMetadata({[p.DICEZOOMSETTING+E.playerId]:parseInt(c.value)})},o.appendChild(f)}function b(){const o=document.getElementById("diceMarkerToggle");o.checked=E.playerMarkers,o.onchange=async f=>{const d=f.currentTarget;await u.room.setMetadata({[p.DICEMARKERSETTING+E.playerId]:d.checked})}}function T(){const o=document.getElementById("selectContainer"),f=document.createElement("select");f.id="textureSelect",[{text:"Default",value:"default"},{text:"D.o.R",value:"diceOfRolling"},{text:"Gemstone",value:"gemstone"},{text:"Marble",value:"gemstoneMarble"},{text:"Rocky",value:"rock"},{text:"Rusty",value:"rust"},{text:"Smooth",value:"smooth"},{text:"Wood",value:"wooden"},{text:"Genesys",value:"genesys"}].forEach(h=>{const c=document.createElement("option");c.setAttribute("value",h.value);const v=document.createTextNode(h.text);c.appendChild(v),f.appendChild(c)}),f.value=E.playerDiceTexture,f.onchange=async h=>{const c=h.currentTarget;await u.room.setMetadata({[p.DICETEXTURESETTING+E.playerId]:c.value})},o.appendChild(f)}});
