import{C as f,O as u}from"./bsConstants-CvMihxgX.js";/* empty css                   */function Me(){const b=document.createElement("img");return b.id="PatreonButton",b.setAttribute("class","icon"),b.classList.add("patreon-clickable"),b.setAttribute("title",R.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),b.setAttribute("src",R.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),b.onclick=async function(t){t.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},b}function ie(b,t){let o;return function(){clearTimeout(o),o=setTimeout(()=>{b()},t)}}function pe(b,t){const o=window.matchMedia("(prefers-color-scheme: dark)"),m=o.matches?"dark":"light",y=o.matches?"light":"dark";for(var v=0;v<t.styleSheets.length;v++)for(var g=0;g<t.styleSheets[v].cssRules.length;g++){let i=t.styleSheets[v].cssRules[g];i&&i.media&&i.media.mediaText.includes("prefers-color-scheme")&&(b.mode=="LIGHT"?(i.media.appendMedium(`(prefers-color-scheme: ${m})`),i.media.mediaText.includes(y)&&i.media.deleteMedium(`(prefers-color-scheme: ${y})`)):b.mode=="DARK"&&(i.media.appendMedium(`(prefers-color-scheme: ${y})`),i.media.mediaText.includes(m)&&i.media.deleteMedium(`(prefers-color-scheme: ${m})`)))}}class ke{constructor(t){this.totalSlots=t,this.initializeSlots()}slots=[];initializeSlots(){for(let t=0;t<this.totalSlots;t++)this.slots.push(!0)}occupySlot(){const t=this.slots.findIndex(o=>o);return t!==-1?(this.slots[t]=!1,setTimeout(()=>{this.releaseSlot(t)},3500),t):-1}releaseSlot(t){this.slots[t]=!0}runFunction(){const t=this.occupySlot();return console.log(t!==-1?`Function is running on slot ${t}`:"No available slots. Please try again later."),t}}class Ne{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new ke(4)}IsThisOld(t,o,m="DEFAULT"){const y=`${o}_${m}`,v=this.messageCounter[y];return v?v!==t?(this.messageCounter[y]=t,!1):!0:(this.messageCounter[y]=t,!1)}async ShowBonesRoll(t){if(t[`${f.EXTENSIONID}/metadata_bonesroll`]!=null){const o=t[`${f.EXTENSIONID}/metadata_bonesroll`];if(!this.IsThisOld(o.created,o.senderId,"ROLL")){const m=await u.viewport.getHeight(),y=await u.viewport.getWidth();await u.modal.open({id:f.EXTENSIONDICEWINDOWID,url:"/dicewindow.html",height:m-100,width:y-50,hidePaper:!0,hideBackdrop:!0,disablePointerEvents:!0})}}}async LogBonesRoll(t){if(t[`${f.EXTENSIONID}/metadata_logroll`]!=null){const o=t[`${f.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(o.created,o.senderId,"LOG"))if(o.senderId===R.playerId||o.viewers===R.playerRole||o.viewers==="ALL"){const m=document.querySelector("#rollLog"),y=o.rollHtml;let v="";o.viewers==="GM"&&(v="[GM]"),o.viewers==="SELF"&&(v="[SELF]");const g=document.createElement("li");if(g.className="dice-log-item dice-notification",g.innerHTML=`[${this.getTimestamp(o.created)}] ${v}<span style="font-weight: bold; color:${o.senderColor};">${o.senderName}</span> => ${y}`,m.append(g),g.scrollIntoView(!1),o.senderId!==R.playerId){const i=await u.viewport.getHeight(),p=encodeURIComponent(y),c=encodeURIComponent(o.senderName);let d=R.party.find(L=>L.id===o.senderId)?.color??"#FFF";const E=encodeURIComponent(d),O=this.queue.runFunction();if(O!==-1){const L=O===0?i-50:i-O*100-50;await u.popover.open({id:f.EXTENSIONNOTIFY+O.toString(),url:`/dicenotify.html?sender=${c}&message=${p}&color=${E}&queue=${encodeURIComponent(O)}`,height:95,width:300,anchorPosition:{top:L,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}else{const m=document.querySelector("#rollLog"),y=document.createElement("li");if(y.className="dice-log-item dice-notification",y.innerHTML=`[${this.getTimestamp(o.created)}]<span style="font-weight: bold; color:${o.senderColor};">${o.senderName}</span> rolled out of view.`,m.append(y),y.scrollIntoView(!1),o.senderId!==R.playerId){const v=await u.viewport.getHeight(),g=encodeURIComponent(" just rolled out of view."),i=encodeURIComponent(o.senderName);let p=R.party.find(E=>E.id===o.senderId)?.color??"#FFF";const c=encodeURIComponent(p),d=this.queue.runFunction();if(d!==-1){const E=d===0?v-50:v-d*100-50;await u.popover.open({id:f.EXTENSIONNOTIFY+d.toString(),url:`/dicenotify.html?sender=${i}&message=${g}&color=${c}&queue=${encodeURIComponent(d)}`,height:95,width:300,anchorPosition:{top:E,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}getTimestamp(t){const o=new Date(t),m=o.getHours().toString().padStart(2,"0"),y=o.getMinutes().toString().padStart(2,"0");return`${m}:${y}`}}const X=new Ne;class I{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerFrontDiceColor;playerDiceTexture;playerDiceZoom;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;USER_REGISTERED;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(t){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="default",this.playerDiceColor="#ff0000",this.playerFrontDiceColor="#FFFFFF",this.playerDiceZoom=4,this.USER_REGISTERED=!1,this.caches=t,this.debouncedOnSceneItemsChange=ie(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=ie(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=ie(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await u.scene.isReady(),this.theme=await u.theme.getTheme(),pe(this.theme,document),this.caches.includes(I.PLAYER)){this.playerId=await u.player.getId(),this.playerName=await u.player.getName(),this.playerColor=await u.player.getColor(),this.playerMetadata=await u.player.getMetadata(),this.playerRole=await u.player.getRole();const t=this.playerMetadata[`${f.EXTENSIONID}/metadata_bonesroll`];t&&X.IsThisOld(t.created,t.senderName,"DEFAULT");const o=this.playerMetadata[`${f.EXTENSIONID}/metadata_logroll`];o&&X.IsThisOld(o.created,o.senderId,"LOG")}if(this.caches.includes(I.PARTY)){this.party=await u.party.getPlayers();for(const t of this.party){const o=t.metadata[`${f.EXTENSIONID}/metadata_bonesroll`];o&&X.IsThisOld(o.created,o.senderName,"DEFAULT");const m=t.metadata[`${f.EXTENSIONID}/metadata_logroll`];m&&X.IsThisOld(m.created,m.senderId,"LOG")}}this.caches.includes(I.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await u.scene.items.getItems()),this.caches.includes(I.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await u.scene.getMetadata()),this.caches.includes(I.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await u.scene.grid.getDpi(),this.gridScale=(await u.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(I.ROOMMETA)&&(this.roomMetadata=await u.room.getMetadata(),this.playerDiceColor=this.roomMetadata[f.DICECOLORSETTING+this.playerId]??"#ff0000",this.playerDiceZoom=this.roomMetadata[f.DICEZOOMSETTING+this.playerId]??4,this.playerFrontDiceColor=this.roomMetadata[f.FRONTDICECOLORSETTING+this.playerId]??"#FFFFFF",this.playerDiceTexture=this.roomMetadata[f.DICETEXTURESETTING+this.playerId]??"default",f.DEFAULTTEXTURES.includes(this.playerDiceTexture)||(this.playerDiceTexture="default")),await this.CheckRegistration()}KillHandlers(){this.caches.includes(I.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(I.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(I.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(I.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(I.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(I.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(I.SCENEMETA)&&(this.sceneMetadataHandler=u.scene.onMetadataChange(async t=>{this.sceneMetadata=t,this.debouncedOnSceneMetadataChange(t)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(I.SCENEITEMS)&&(this.sceneItemsHandler=u.scene.items.onChange(async t=>{this.sceneItems=t,this.debouncedOnSceneItemsChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(I.SCENEGRID)&&(this.sceneGridHandler=u.scene.grid.onChange(async t=>{this.gridDpi=t.dpi,this.gridScale=parseInt(t.scale),await this.OnSceneGridChange(t)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(I.PLAYER)&&(this.playerHandler=u.player.onChange(async t=>{this.playerName=t.name,this.playerColor=t.color,this.playerId=t.id,this.playerRole=t.role,this.playerMetadata=t.metadata,await this.OnPlayerChange(t)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(I.PARTY)&&(this.partyHandler=u.party.onChange(async t=>{this.party=t,await this.OnPartyChange(t)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(I.ROOMMETA)&&(this.roomHandler=u.room.onMetadataChange(async t=>{this.roomMetadata=t,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=u.theme.onChange(async t=>{this.theme=t.mode,await this.OnThemeChange(t)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=u.scene.onReadyChange(async t=>{this.sceneReady=t,t&&(this.sceneItems=await u.scene.items.getItems(),this.sceneMetadata=await u.scene.getMetadata(),this.gridDpi=await u.scene.grid.getDpi(),this.gridScale=(await u.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(t)}))}async OnSceneMetadataChanges(t){}async OnSceneItemsChange(t){this.sceneReady}async OnSceneGridChange(t){}async OnSceneReadyChange(t){}async OnPlayerChange(t){await X.ShowBonesRoll(t.metadata),await X.LogBonesRoll(t.metadata)}async OnPartyChange(t){for await(const o of t)await X.LogBonesRoll(o.metadata)}async OnRoomMetadataChange(){const t=this.roomMetadata[f.DICECOLORSETTING+this.playerId],o=this.roomMetadata[f.DICEZOOMSETTING+this.playerId],m=this.roomMetadata[f.FRONTDICECOLORSETTING+this.playerId],y=this.roomMetadata[f.DICETEXTURESETTING+this.playerId];t&&(this.playerDiceColor=t),m&&(this.playerFrontDiceColor=m),o&&(this.playerDiceZoom=o),y&&(this.playerDiceTexture=y)}async OnThemeChange(t){pe(t,document)}async CheckRegistration(){try{const t=window.location.origin.includes("localhost")?"eternaldream":"",o={owlbearid:R.playerId},m={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:f.ANONAUTH,"x-manuel":t}),body:JSON.stringify(o)},y=await fetch(f.CHECKREGISTRATION,m);if(!y.ok){const g=await y.json();console.error("Error:",g);return}(await y.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(t){console.error("Error:",t)}}}const R=new I([I.PLAYER,I.PARTY,I.ROOMMETA]),H=(()=>{/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return((b,t,o,m)=>{const y=t.createElement("canvas").getContext("2d"),v={r:0,g:0,b:0,h:0,s:0,v:0,a:1};let g,i,p,c,d,E,O,L,$,q,x,A,w,W,F,te,N={};const n={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>m,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},z={};let ae="",j={},V=!1;function J(e){if(typeof e=="object")for(const a in e)switch(a){case"el":ne(e.el),e.wrap!==!1&&Q(e.el);break;case"parent":g=t.querySelector(e.parent),g&&(g.appendChild(i),n.parent=e.parent,g===t.body&&(g=m));break;case"themeMode":n.themeMode=e.themeMode,e.themeMode==="auto"&&b.matchMedia&&b.matchMedia("(prefers-color-scheme: dark)").matches&&(n.themeMode="dark");case"theme":e.theme&&(n.theme=e.theme),i.className=`clr-picker clr-${n.theme} clr-${n.themeMode}`,n.inline&&K();break;case"rtl":n.rtl=!!e.rtl,t.querySelectorAll(".clr-field").forEach(r=>r.classList.toggle("clr-rtl",n.rtl));break;case"margin":e.margin*=1,n.margin=isNaN(e.margin)?n.margin:e.margin;break;case"wrap":e.el&&e.wrap&&Q(e.el);break;case"formatToggle":n.formatToggle=!!e.formatToggle,M("clr-format").style.display=n.formatToggle?"block":"none",n.formatToggle&&(n.format="auto");break;case"swatches":if(Array.isArray(e.swatches)){const r=[];e.swatches.forEach((h,C)=>{r.push(`<button type="button" id="clr-swatch-${C}" aria-labelledby="clr-swatch-label clr-swatch-${C}" style="color: ${h};">${h}</button>`)}),M("clr-swatches").innerHTML=r.length?`<div>${r.join("")}</div>`:"",n.swatches=e.swatches.slice()}break;case"swatchesOnly":n.swatchesOnly=!!e.swatchesOnly,i.setAttribute("data-minimal",n.swatchesOnly);break;case"alpha":n.alpha=!!e.alpha,i.setAttribute("data-alpha",n.alpha);break;case"inline":if(n.inline=!!e.inline,i.setAttribute("data-inline",n.inline),n.inline){const r=e.defaultColor||n.defaultColor;W=se(r),K(),Z(r)}break;case"clearButton":typeof e.clearButton=="object"&&(e.clearButton.label&&(n.clearLabel=e.clearButton.label,O.innerHTML=n.clearLabel),e.clearButton=e.clearButton.show),n.clearButton=!!e.clearButton,O.style.display=n.clearButton?"block":"none";break;case"clearLabel":n.clearLabel=e.clearLabel,O.innerHTML=n.clearLabel;break;case"closeButton":n.closeButton=!!e.closeButton,n.closeButton?i.insertBefore(L,d):d.appendChild(L);break;case"closeLabel":n.closeLabel=e.closeLabel,L.innerHTML=n.closeLabel;break;case"a11y":const l=e.a11y;let s=!1;if(typeof l=="object")for(const r in l)l[r]&&n.a11y[r]&&(n.a11y[r]=l[r],s=!0);if(s){const r=M("clr-open-label"),h=M("clr-swatch-label");r.innerHTML=n.a11y.open,h.innerHTML=n.a11y.swatch,L.setAttribute("aria-label",n.a11y.close),O.setAttribute("aria-label",n.a11y.clear),$.setAttribute("aria-label",n.a11y.hueSlider),x.setAttribute("aria-label",n.a11y.alphaSlider),E.setAttribute("aria-label",n.a11y.input),p.setAttribute("aria-label",n.a11y.instruction)}break;default:n[a]=e[a]}}function fe(e,a){typeof e=="string"&&typeof a=="object"&&(z[e]=a,V=!0)}function me(e){delete z[e],Object.keys(z).length===0&&(V=!1,e===ae&&le())}function re(e){if(V){const a=["el","wrap","rtl","inline","defaultColor","a11y"];for(let l in z){const s=z[l];if(e.matches(l)){ae=l,j={},a.forEach(r=>delete s[r]);for(let r in s)j[r]=Array.isArray(n[r])?n[r].slice():n[r];J(s);break}}}}function le(){Object.keys(j).length>0&&(J(j),ae="",j={})}function ne(e){T(t,"click",e,a=>{n.inline||(re(a.target),w=a.target,F=w.value,W=se(F),i.classList.add("clr-open"),K(),Z(F),(n.focusInput||n.selectInput)&&(E.focus({preventScroll:!0}),E.setSelectionRange(w.selectionStart,w.selectionEnd)),n.selectInput&&E.select(),(te||n.swatchesOnly)&&ue().shift().focus(),w.dispatchEvent(new Event("open",{bubbles:!0})))}),T(t,"input",e,a=>{const l=a.target.parentNode;l.classList.contains("clr-field")&&(l.style.color=a.target.value)})}function K(){if(!i||!w&&!n.inline)return;const e=g,a=b.scrollY,l=i.offsetWidth,s=i.offsetHeight,r={left:!1,top:!1};let h,C,D,S={x:0,y:0};if(e&&(h=b.getComputedStyle(e),C=parseFloat(h.marginTop),D=parseFloat(h.borderTopWidth),S=e.getBoundingClientRect(),S.y+=D+a),!n.inline){const k=w.getBoundingClientRect();let B=k.x,U=a+k.y+k.height+n.margin;e?(B-=S.x,U-=S.y,B+l>e.clientWidth&&(B+=k.width-l,r.left=!0),U+s>e.clientHeight-C&&s+n.margin<=k.top-(S.y-a)&&(U-=k.height+s+n.margin*2,r.top=!0),U+=e.scrollTop):(B+l>t.documentElement.clientWidth&&(B+=k.width-l,r.left=!0),U+s-a>t.documentElement.clientHeight&&s+n.margin<=k.top&&(U=a+k.y-s-n.margin,r.top=!0)),i.classList.toggle("clr-left",r.left),i.classList.toggle("clr-top",r.top),i.style.left=`${B}px`,i.style.top=`${U}px`,S.x+=i.offsetLeft,S.y+=i.offsetTop}N={width:p.offsetWidth,height:p.offsetHeight,x:p.offsetLeft+S.x,y:p.offsetTop+S.y}}function Q(e){t.querySelectorAll(e).forEach(a=>{const l=a.parentNode;if(!l.classList.contains("clr-field")){const s=t.createElement("div");let r="clr-field";(n.rtl||a.classList.contains("clr-rtl"))&&(r+=" clr-rtl"),s.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',l.insertBefore(s,a),s.setAttribute("class",r),s.style.color=a.value,s.appendChild(a)}})}function Y(e){if(w&&!n.inline){const a=w;e&&(w=m,F!==a.value&&(a.value=F,a.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{F!==a.value&&a.dispatchEvent(new Event("change",{bubbles:!0}))}),i.classList.remove("clr-open"),V&&le(),a.dispatchEvent(new Event("close",{bubbles:!0})),n.focusInput&&a.focus({preventScroll:!0}),w=m}}function Z(e){const a=Ie(e),l=Ce(a);de(l.s,l.v),_(a,l),$.value=l.h,i.style.color=`hsl(${l.h}, 100%, 50%)`,q.style.left=`${l.h/360*100}%`,c.style.left=`${N.width*l.s/100}px`,c.style.top=`${N.height-N.height*l.v/100}px`,x.value=l.a*100,A.style.left=`${l.a*100}%`}function se(e){const a=e.substring(0,3).toLowerCase();return a==="rgb"||a==="hsl"?a:"hex"}function G(e){e=e!==m?e:E.value,w&&(w.value=e,w.dispatchEvent(new Event("input",{bubbles:!0}))),n.onChange&&n.onChange.call(b,e,w),t.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:e,currentEl:w}}))}function ce(e,a){const l={h:$.value*1,s:e/N.width*100,v:100-a/N.height*100,a:x.value/100},s=be(l);de(l.s,l.v),_(s,l),G()}function de(e,a){let l=n.a11y.marker;e=e.toFixed(1)*1,a=a.toFixed(1)*1,l=l.replace("{s}",e),l=l.replace("{v}",a),c.setAttribute("aria-label",l)}function ye(e){return{pageX:e.changedTouches?e.changedTouches[0].pageX:e.pageX,pageY:e.changedTouches?e.changedTouches[0].pageY:e.pageY}}function P(e){const a=ye(e);let l=a.pageX-N.x,s=a.pageY-N.y;g&&(s+=g.scrollTop),he(l,s),e.preventDefault(),e.stopPropagation()}function ge(e,a){let l=c.style.left.replace("px","")*1+e,s=c.style.top.replace("px","")*1+a;he(l,s)}function he(e,a){e=e<0?0:e>N.width?N.width:e,a=a<0?0:a>N.height?N.height:a,c.style.left=`${e}px`,c.style.top=`${a}px`,ce(e,a),c.focus()}function _(e,a){e===void 0&&(e={}),a===void 0&&(a={});let l=n.format;for(const h in e)v[h]=e[h];for(const h in a)v[h]=a[h];const s=we(v),r=s.substring(0,7);switch(c.style.color=r,A.parentNode.style.color=r,A.style.color=s,d.style.color=s,p.style.display="none",p.offsetHeight,p.style.display="",A.nextElementSibling.style.display="none",A.nextElementSibling.offsetHeight,A.nextElementSibling.style.display="",l==="mixed"?l=v.a===1?"hex":"rgb":l==="auto"&&(l=W),l){case"hex":E.value=s;break;case"rgb":E.value=Se(v);break;case"hsl":E.value=Re(Te(v));break}t.querySelector(`.clr-format [value="${l}"]`).checked=!0}function Ee(){const e=$.value*1,a=c.style.left.replace("px","")*1,l=c.style.top.replace("px","")*1;i.style.color=`hsl(${e}, 100%, 50%)`,q.style.left=`${e/360*100}%`,ce(a,l)}function ve(){const e=x.value/100;A.style.left=`${e*100}%`,_({a:e}),G()}function be(e){const a=e.s/100,l=e.v/100;let s=a*l,r=e.h/60,h=s*(1-o.abs(r%2-1)),C=l-s;s=s+C,h=h+C;const D=o.floor(r)%6,S=[s,h,C,C,h,s][D],k=[h,s,s,h,C,C][D],B=[C,C,h,s,s,h][D];return{r:o.round(S*255),g:o.round(k*255),b:o.round(B*255),a:e.a}}function Te(e){const a=e.v/100,l=a*(1-e.s/100/2);let s;return l>0&&l<1&&(s=o.round((a-l)/o.min(l,1-l)*100)),{h:e.h,s:s||0,l:o.round(l*100),a:e.a}}function Ce(e){const a=e.r/255,l=e.g/255,s=e.b/255,r=o.max(a,l,s),h=o.min(a,l,s),C=r-h,D=r;let S=0,k=0;return C&&(r===a&&(S=(l-s)/C),r===l&&(S=2+(s-a)/C),r===s&&(S=4+(a-l)/C),r&&(k=C/r)),S=o.floor(S*60),{h:S<0?S+360:S,s:o.round(k*100),v:o.round(D*100),a:e.a}}function Ie(e){const a=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i;let l,s;return y.fillStyle="#000",y.fillStyle=e,l=a.exec(y.fillStyle),l?(s={r:l[3]*1,g:l[4]*1,b:l[5]*1,a:l[6]*1},s.a=+s.a.toFixed(2)):(l=y.fillStyle.replace("#","").match(/.{2}/g).map(r=>parseInt(r,16)),s={r:l[0],g:l[1],b:l[2],a:1}),s}function we(e){let a=e.r.toString(16),l=e.g.toString(16),s=e.b.toString(16),r="";if(e.r<16&&(a="0"+a),e.g<16&&(l="0"+l),e.b<16&&(s="0"+s),n.alpha&&(e.a<1||n.forceAlpha)){const h=e.a*255|0;r=h.toString(16),h<16&&(r="0"+r)}return"#"+a+l+s+r}function Se(e){return!n.alpha||e.a===1&&!n.forceAlpha?`rgb(${e.r}, ${e.g}, ${e.b})`:`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`}function Re(e){return!n.alpha||e.a===1&&!n.forceAlpha?`hsl(${e.h}, ${e.s}%, ${e.l}%)`:`hsla(${e.h}, ${e.s}%, ${e.l}%, ${e.a})`}function Oe(){t.getElementById("clr-picker")||(g=m,i=t.createElement("div"),i.setAttribute("id","clr-picker"),i.className="clr-picker",i.innerHTML=`<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="${n.a11y.input}"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="${n.a11y.instruction}"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="${n.a11y.hueSlider}"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="${n.a11y.alphaSlider}"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>${n.a11y.format}</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear" aria-label="${n.a11y.clear}">${n.clearLabel}</button><div id="clr-color-preview" class="clr-preview"><button type="button" id="clr-close" class="clr-close" aria-label="${n.a11y.close}">${n.closeLabel}</button></div><span id="clr-open-label" hidden>${n.a11y.open}</span><span id="clr-swatch-label" hidden>${n.a11y.swatch}</span>`,t.body.appendChild(i),p=M("clr-color-area"),c=M("clr-color-marker"),O=M("clr-clear"),L=M("clr-close"),d=M("clr-color-preview"),E=M("clr-color-value"),$=M("clr-hue-slider"),q=M("clr-hue-marker"),x=M("clr-alpha-slider"),A=M("clr-alpha-marker"),ne(n.el),Q(n.el),T(i,"mousedown",e=>{i.classList.remove("clr-keyboard-nav"),e.stopPropagation()}),T(p,"mousedown",e=>{T(t,"mousemove",P)}),T(p,"touchstart",e=>{t.addEventListener("touchmove",P,{passive:!1})}),T(c,"mousedown",e=>{T(t,"mousemove",P)}),T(c,"touchstart",e=>{t.addEventListener("touchmove",P,{passive:!1})}),T(E,"change",e=>{const a=E.value;if(w||n.inline){const l=a===""?a:Z(a);G(l)}}),T(O,"click",e=>{G(""),Y()}),T(L,"click",e=>{G(),Y()}),T(M("clr-format"),"click",".clr-format input",e=>{W=e.target.value,_(),G()}),T(i,"click",".clr-swatches button",e=>{Z(e.target.textContent),G(),n.swatchesOnly&&Y()}),T(t,"mouseup",e=>{t.removeEventListener("mousemove",P)}),T(t,"touchend",e=>{t.removeEventListener("touchmove",P)}),T(t,"mousedown",e=>{te=!1,i.classList.remove("clr-keyboard-nav"),Y()}),T(t,"keydown",e=>{const a=e.key,l=e.target,s=e.shiftKey;if(a==="Escape"?Y(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(a)&&(te=!0,i.classList.add("clr-keyboard-nav")),a==="Tab"&&l.matches(".clr-picker *")){const h=ue(),C=h.shift(),D=h.pop();s&&l===C?(D.focus(),e.preventDefault()):!s&&l===D&&(C.focus(),e.preventDefault())}}),T(t,"click",".clr-field button",e=>{V&&le(),e.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),T(c,"keydown",e=>{const a={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(a).includes(e.key)&&(ge(...a[e.key]),e.preventDefault())}),T(p,"click",P),T($,"input",Ee),T(x,"input",ve))}function ue(){return Array.from(i.querySelectorAll("input, button")).filter(l=>!!l.offsetWidth)}function M(e){return t.getElementById(e)}function T(e,a,l,s){const r=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof l=="string"?e.addEventListener(a,h=>{r.call(h.target,l)&&s.call(h.target,h)}):(s=l,e.addEventListener(a,s))}function ee(e,a){a=a!==m?a:[],t.readyState!=="loading"?e(...a):t.addEventListener("DOMContentLoaded",()=>{e(...a)})}NodeList!==m&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function Le(e,a){w=a,F=w.value,re(a),W=se(e),K(),Z(e),G(),F!==e&&w.dispatchEvent(new Event("change",{bubbles:!0}))}const oe=(()=>{const e={init:Oe,set:J,wrap:Q,close:Y,setInstance:fe,setColor:Le,removeInstance:me,updatePosition:K,ready:ee};function a(l){ee(()=>{l&&(typeof l=="string"?ne(l):J(l))})}for(const l in e)a[l]=function(){for(var s=arguments.length,r=new Array(s),h=0;h<s;h++)r[h]=arguments[h];ee(e[l],r)};return ee(()=>{b.addEventListener("resize",l=>{a.updatePosition()}),b.addEventListener("scroll",l=>{a.updatePosition()})}),a})();return oe.coloris=oe,oe})(window,document,Math)})();H.coloris;H.init;H.set;H.wrap;H.close;H.setInstance;H.removeInstance;H.updatePosition;f.BONESENTRY.innerHTML=`    
    <div class="header"><span style="float:left;" id="optionsToggle">▼</span>Dice Options</div><div id="patreonContainer"></div>
    <div id="optionsContainer">
        <div style="display:flex; justify-content:space-between;">
            <div id="selectContainer" class="select"></div>
            
        </div>
        <div style="display:flex; justify-content:space-between;">
            <div id="zoomContainer" class="select"></div>
            <div id="backColorisContainer" class='coloris-container full'></div>
        </div>
    </div>
    <div class="header"><span style="float:left;" id="rollToggle">▼</span>Dice Log</div>
    <div id="rollContainer"><ul id="rollLog"></ul></div>
    <div class="header"><span style="float:left;" id="manualRollToggle">▼</span>Custom Rolls</div>
    <div id="manualRollContainer">
        <div id="viewToggleContainer"></div>
    </div>`;u.onReady(async()=>{await R.InitializeCache(),R.SetupHandlers(),m(),v(),y(),o(),document.getElementById("patreonContainer").appendChild(Me()),t("optionsToggle","optionsContainer",50,"block"),t("rollToggle","rollContainer",160,"block"),t("manualRollToggle","manualRollContainer",31,"flex");function t(g,i,p,c){const d=document.getElementById(g);d.style.cursor="pointer";const E=document.getElementById(i);d.onclick=async()=>{const O=await u.popover.getHeight(f.EXTENSIONDICECONTROLLERID);E.style.display!=="none"?(d.innerText="▶",await u.popover.setHeight(f.EXTENSIONDICECONTROLLERID,O-p),E.style.display="none"):(d.innerText="▼",await u.popover.setHeight(f.EXTENSIONDICECONTROLLERID,O+p),E.style.display=c)}}function o(){const g=document.getElementById("manualRollContainer"),i=document.getElementById("viewToggleContainer"),p=document.createElement("input");p.type="text",p.placeholder="Custom Roll",p.classList.add("input-button");const c=document.createElement("input");c.id="manualRollSelfButton",c.type="button",c.classList.add("options-button"),c.classList.add("options-hover"),c.value="Self",c.dataset.active=f.FALSE,c.onclick=()=>{c.dataset.active===f.TRUE?(c.dataset.active=f.FALSE,c.classList.remove("options-active")):(c.dataset.active=f.TRUE,c.classList.add("options-active"))};const d=document.createElement("input");d.id="manualRollGMButton",d.type="button",d.classList.add("options-button"),d.classList.add("options-hover"),d.value="GM",d.onclick=()=>{d.dataset.active===f.TRUE?(d.dataset.active=f.FALSE,d.classList.remove("options-active")):(d.dataset.active=f.TRUE,d.classList.add("options-active"))};const E=document.createElement("input");E.id="rollButton",E.type="image",E.src="/dice-twenty.svg",E.onclick=async()=>{await O()},p.onkeydown=async L=>{L.key==="Enter"&&await O()},g.prepend(p),i.appendChild(E),i.appendChild(c),i.appendChild(d);async function O(){const L=p.value;if(L.length>0){const $=c.dataset.active,q=d.dataset.active;let x="ALL";$==="TRUE"&&(x="SELF"),q==="TRUE"&&(x="GM");const A={},w=new Date().toISOString();A[`${f.EXTENSIONID}/metadata_bonesroll`]={notation:L,created:w,senderName:R.playerName,senderId:R.playerId,viewers:x},await u.player.setMetadata(A)}p.value=""}}function m(){let g;const i=document.getElementById("backColorisContainer"),p=document.createElement("input");p.type="text",p.classList.add("coloris"),p.id="diceColoris",p.value=R.playerDiceColor,p.maxLength=7,p.oninput=async c=>{if(!c||!c.target)return;const d=c.target;clearTimeout(g),g=setTimeout(async()=>{/#[a-f0-9]{6}/.test(d.value)&&await u.room.setMetadata({[f.DICECOLORSETTING+R.playerId]:d.value})},400)},i.appendChild(p),H.init(),H({alpha:!1,theme:"polaroid",closeButton:!0,themeMode:R.theme.mode==="DARK"?"dark":"light",el:"#diceColoris"})}function y(){const g=document.getElementById("zoomContainer"),i=document.createElement("select");i.id="zoomSelect",[{text:"25%",value:"1"},{text:"50%",value:"2"},{text:"75%",value:"3"},{text:"100%",value:"4"},{text:"125%",value:"5"},{text:"150%",value:"6"},{text:"175%",value:"7"},{text:"200%",value:"8"}].forEach(c=>{const d=document.createElement("option");d.setAttribute("value",c.value);const E=document.createTextNode(c.text);d.appendChild(E),i.appendChild(d)}),i.value=R.playerDiceZoom.toString(),i.onchange=async c=>{const d=c.currentTarget;await u.room.setMetadata({[f.DICEZOOMSETTING+R.playerId]:parseInt(d.value)})},g.appendChild(i)}function v(){const g=document.getElementById("selectContainer"),i=document.createElement("select");i.id="textureSelect",[{text:"Default",value:"default"},{text:"D.o.R",value:"diceOfRolling"},{text:"Gemstone",value:"gemstone"},{text:"Marble",value:"gemstoneMarble"},{text:"Rocky",value:"rock"},{text:"Rusty",value:"rust"},{text:"Smooth",value:"smooth"},{text:"Wood",value:"wooden"},{text:"Genesys",value:"genesys"}].forEach(c=>{const d=document.createElement("option");d.setAttribute("value",c.value);const E=document.createTextNode(c.text);d.appendChild(E),i.appendChild(d)}),i.value=R.playerDiceTexture,i.onchange=async c=>{const d=c.currentTarget;await u.room.setMetadata({[f.DICETEXTURESETTING+R.playerId]:d.value})},g.appendChild(i)}});
