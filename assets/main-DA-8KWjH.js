import{C as m,O as c}from"./bsConstants-E4N5t5Rc.js";function Ae(){const u=document.createElement("img");u.id="whatsNewButton",u.style.cursor="pointer",u.setAttribute("class","icon"),u.classList.add("clickable"),u.setAttribute("title","Whats New?"),u.setAttribute("src","/info.svg"),u.onclick=async function(){try{localStorage.setItem(m.VERSION,"true"),u.classList.remove("whats-new-shine")}catch{}await c.modal.open({id:m.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(m.VERSION)!=="true"&&u.classList.add("whats-new-shine")}catch{}return u}function ce(u,t){let s;return function(){clearTimeout(s),s=setTimeout(()=>{u()},t)}}function me(u,t){const s=window.matchMedia("(prefers-color-scheme: dark)"),h=s.matches?"dark":"light",f=s.matches?"light":"dark";for(var p=0;p<t.styleSheets.length;p++)for(var E=0;E<t.styleSheets[p].cssRules.length;E++){let o=t.styleSheets[p].cssRules[E];o&&o.media&&o.media.mediaText.includes("prefers-color-scheme")&&(u.mode=="LIGHT"?(o.media.appendMedium(`(prefers-color-scheme: ${h})`),o.media.mediaText.includes(f)&&o.media.deleteMedium(`(prefers-color-scheme: ${f})`)):u.mode=="DARK"&&(o.media.appendMedium(`(prefers-color-scheme: ${f})`),o.media.mediaText.includes(h)&&o.media.deleteMedium(`(prefers-color-scheme: ${h})`)))}}class De{constructor(t){this.totalSlots=t,this.initializeSlots()}slots=[];initializeSlots(){for(let t=0;t<this.totalSlots;t++)this.slots.push(!0)}occupySlot(){const t=this.slots.findIndex(s=>s);return t!==-1?(this.slots[t]=!1,setTimeout(()=>{this.releaseSlot(t)},3500),t):-1}releaseSlot(t){this.slots[t]=!0}runFunction(){const t=this.occupySlot();return console.log(t!==-1?`Function is running on slot ${t}`:"No available slots. Please try again later."),t}}class xe{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new De(4)}IsThisOld(t,s,h="DEFAULT"){const f=`${s}_${h}`,p=this.messageCounter[f];return p?p!==t?(this.messageCounter[f]=t,!1):!0:(this.messageCounter[f]=t,!1)}async ShowBonesRoll(t){if(t[`${m.EXTENSIONID}/metadata_bonesroll`]!=null){const s=t[`${m.EXTENSIONID}/metadata_bonesroll`];if(!this.IsThisOld(s.created,s.senderId,"ROLL")){const h=await c.viewport.getHeight(),f=await c.viewport.getWidth();await c.popover.open({id:m.EXTENSIONDICEWINDOWID,url:"/dicewindow.html",height:h-50,width:f-50,anchorPosition:{top:25,left:25},anchorReference:"POSITION",anchorOrigin:{vertical:"TOP",horizontal:"LEFT"},transformOrigin:{vertical:"TOP",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}async LogBonesRoll(t){if(t[`${m.EXTENSIONID}/metadata_logroll`]!=null){const s=t[`${m.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(s.created,s.senderId,"LOG"))if(s.senderId===N.playerId||s.viewers===N.playerRole||s.viewers==="ALL"){const h=document.querySelector("#rollLog"),f=s.rollHtml;let p="";s.viewers==="GM"&&(p="[GM]"),s.viewers==="SELF"&&(p="[SELF]");const E=document.createElement("li");if(E.className="dice-log-item",E.innerHTML=`[${this.getTimestamp(s.created)}] ${p}<span style="font-weight: bold; color:${s.senderColor};">${s.senderName}</span> => ${f}`,h.append(E),E.scrollIntoView(!1),s.senderId!==N.playerId){const o=await c.viewport.getHeight(),C=encodeURIComponent(f),w=encodeURIComponent(s.senderName);let L=N.party.find(H=>H.id===s.senderId)?.color??"#FFF";const I=encodeURIComponent(L),R=this.queue.runFunction();if(R!==-1){const H=R===0?o-50:o-R*100-50;await c.popover.open({id:m.EXTENSIONNOTIFY+R.toString(),url:`/dicenotify.html?sender=${w}&message=${C}&color=${I}&queue=${encodeURIComponent(R)}`,height:95,width:300,anchorPosition:{top:H,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}else{const h=document.querySelector("#rollLog"),f=document.createElement("li");if(f.className="dice-log-item",f.innerHTML=`[${this.getTimestamp(s.created)}]<span style="font-weight: bold; color:${s.senderColor};">${s.senderName}</span> rolled out of view.`,h.append(f),f.scrollIntoView(!1),s.senderId!==N.playerId){const p=await c.viewport.getHeight(),E=encodeURIComponent(" just rolled out of view."),o=encodeURIComponent(s.senderName);let C=N.party.find(I=>I.id===s.senderId)?.color??"#FFF";const w=encodeURIComponent(C),L=this.queue.runFunction();if(L!==-1){const I=L===0?p-50:p-L*100-50;await c.popover.open({id:m.EXTENSIONNOTIFY+L.toString(),url:`/dicenotify.html?sender=${o}&message=${E}&color=${w}&queue=${encodeURIComponent(L)}`,height:95,width:300,anchorPosition:{top:I,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}getTimestamp(t){const s=new Date(t),h=s.getHours().toString().padStart(2,"0"),f=s.getMinutes().toString().padStart(2,"0");return`${h}:${f}`}}const B=new xe;class b{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerDiceTexture;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(t){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="skulls",this.playerDiceColor="#ff0000",this.caches=t,this.debouncedOnSceneItemsChange=ce(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=ce(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=ce(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await c.scene.isReady(),this.theme=await c.theme.getTheme(),me(this.theme,document),this.caches.includes(b.PLAYER)){this.playerId=await c.player.getId(),this.playerName=await c.player.getName(),this.playerColor=await c.player.getColor(),this.playerMetadata=await c.player.getMetadata(),this.playerRole=await c.player.getRole();const t=this.playerMetadata[`${m.EXTENSIONID}/metadata_bonesroll`];t&&B.IsThisOld(t.created,t.senderName,"DEFAULT");const s=this.playerMetadata[`${m.EXTENSIONID}/metadata_logroll`];s&&B.IsThisOld(s.created,s.senderId,"LOG")}if(this.caches.includes(b.PARTY)){this.party=await c.party.getPlayers();for(const t of this.party){const s=t.metadata[`${m.EXTENSIONID}/metadata_bonesroll`];s&&B.IsThisOld(s.created,s.senderName,"DEFAULT");const h=t.metadata[`${m.EXTENSIONID}/metadata_logroll`];h&&B.IsThisOld(h.created,h.senderId,"LOG")}}this.caches.includes(b.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await c.scene.items.getItems()),this.caches.includes(b.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await c.scene.getMetadata()),this.caches.includes(b.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await c.scene.grid.getDpi(),this.gridScale=(await c.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(b.ROOMMETA)&&(this.roomMetadata=await c.room.getMetadata(),this.playerDiceColor=this.roomMetadata[m.DICECOLORSETTING+this.playerId]??"#ff0000",this.playerDiceTexture=this.roomMetadata[m.DICETEXTURESETTING+this.playerId]??"default",["default","diceOfRolling","gemstone","gemstoneMarble","rock","rust","smooth","wooden"].includes(this.playerDiceTexture)||(this.playerDiceTexture="default"))}KillHandlers(){this.caches.includes(b.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(b.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(b.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(b.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(b.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(b.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(b.SCENEMETA)&&(this.sceneMetadataHandler=c.scene.onMetadataChange(async t=>{this.sceneMetadata=t,this.debouncedOnSceneMetadataChange(t)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(b.SCENEITEMS)&&(this.sceneItemsHandler=c.scene.items.onChange(async t=>{this.sceneItems=t,this.debouncedOnSceneItemsChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(b.SCENEGRID)&&(this.sceneGridHandler=c.scene.grid.onChange(async t=>{this.gridDpi=t.dpi,this.gridScale=parseInt(t.scale),await this.OnSceneGridChange(t)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(b.PLAYER)&&(this.playerHandler=c.player.onChange(async t=>{this.playerName=t.name,this.playerColor=t.color,this.playerId=t.id,this.playerRole=t.role,this.playerMetadata=t.metadata,await this.OnPlayerChange(t)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(b.PARTY)&&(this.partyHandler=c.party.onChange(async t=>{this.party=t,await this.OnPartyChange(t)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(b.ROOMMETA)&&(this.roomHandler=c.room.onMetadataChange(async t=>{this.roomMetadata=t,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=c.theme.onChange(async t=>{this.theme=t.mode,await this.OnThemeChange(t)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=c.scene.onReadyChange(async t=>{this.sceneReady=t,t&&(this.sceneItems=await c.scene.items.getItems(),this.sceneMetadata=await c.scene.getMetadata(),this.gridDpi=await c.scene.grid.getDpi(),this.gridScale=(await c.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(t)}))}async OnSceneMetadataChanges(t){}async OnSceneItemsChange(t){this.sceneReady}async OnSceneGridChange(t){}async OnSceneReadyChange(t){}async OnPlayerChange(t){await B.ShowBonesRoll(t.metadata),await B.LogBonesRoll(t.metadata)}async OnPartyChange(t){for await(const s of t)await B.LogBonesRoll(s.metadata)}async OnRoomMetadataChange(){const t=this.roomMetadata[m.DICECOLORSETTING+this.playerId],s=this.roomMetadata[m.DICETEXTURESETTING+this.playerId];t&&(this.playerDiceColor=t),s&&(this.playerDiceTexture=s)}async OnThemeChange(t){me(t,document)}}const N=new b([b.PLAYER,b.PARTY,b.ROOMMETA]),A=(()=>{/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return((u,t,s,h)=>{const f=t.createElement("canvas").getContext("2d"),p={r:0,g:0,b:0,h:0,s:0,v:0,a:1};let E,o,C,w,L,I,R,H,W,ae,X,D,v,V,x,le,M={};const r={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>h,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},q={};let re="",U={},z=!1;function Q(e){if(typeof e=="object")for(const a in e)switch(a){case"el":ie(e.el),e.wrap!==!1&&J(e.el);break;case"parent":E=t.querySelector(e.parent),E&&(E.appendChild(o),r.parent=e.parent,E===t.body&&(E=h));break;case"themeMode":r.themeMode=e.themeMode,e.themeMode==="auto"&&u.matchMedia&&u.matchMedia("(prefers-color-scheme: dark)").matches&&(r.themeMode="dark");case"theme":e.theme&&(r.theme=e.theme),o.className=`clr-picker clr-${r.theme} clr-${r.themeMode}`,r.inline&&j();break;case"rtl":r.rtl=!!e.rtl,t.querySelectorAll(".clr-field").forEach(n=>n.classList.toggle("clr-rtl",r.rtl));break;case"margin":e.margin*=1,r.margin=isNaN(e.margin)?r.margin:e.margin;break;case"wrap":e.el&&e.wrap&&J(e.el);break;case"formatToggle":r.formatToggle=!!e.formatToggle,S("clr-format").style.display=r.formatToggle?"block":"none",r.formatToggle&&(r.format="auto");break;case"swatches":if(Array.isArray(e.swatches)){const n=[];e.swatches.forEach((d,y)=>{n.push(`<button type="button" id="clr-swatch-${y}" aria-labelledby="clr-swatch-label clr-swatch-${y}" style="color: ${d};">${d}</button>`)}),S("clr-swatches").innerHTML=n.length?`<div>${n.join("")}</div>`:"",r.swatches=e.swatches.slice()}break;case"swatchesOnly":r.swatchesOnly=!!e.swatchesOnly,o.setAttribute("data-minimal",r.swatchesOnly);break;case"alpha":r.alpha=!!e.alpha,o.setAttribute("data-alpha",r.alpha);break;case"inline":if(r.inline=!!e.inline,o.setAttribute("data-inline",r.inline),r.inline){const n=e.defaultColor||r.defaultColor;V=ne(n),j(),K(n)}break;case"clearButton":typeof e.clearButton=="object"&&(e.clearButton.label&&(r.clearLabel=e.clearButton.label,R.innerHTML=r.clearLabel),e.clearButton=e.clearButton.show),r.clearButton=!!e.clearButton,R.style.display=r.clearButton?"block":"none";break;case"clearLabel":r.clearLabel=e.clearLabel,R.innerHTML=r.clearLabel;break;case"closeButton":r.closeButton=!!e.closeButton,r.closeButton?o.insertBefore(H,L):L.appendChild(H);break;case"closeLabel":r.closeLabel=e.closeLabel,H.innerHTML=r.closeLabel;break;case"a11y":const l=e.a11y;let i=!1;if(typeof l=="object")for(const n in l)l[n]&&r.a11y[n]&&(r.a11y[n]=l[n],i=!0);if(i){const n=S("clr-open-label"),d=S("clr-swatch-label");n.innerHTML=r.a11y.open,d.innerHTML=r.a11y.swatch,H.setAttribute("aria-label",r.a11y.close),R.setAttribute("aria-label",r.a11y.clear),W.setAttribute("aria-label",r.a11y.hueSlider),X.setAttribute("aria-label",r.a11y.alphaSlider),I.setAttribute("aria-label",r.a11y.input),C.setAttribute("aria-label",r.a11y.instruction)}break;default:r[a]=e[a]}}function be(e,a){typeof e=="string"&&typeof a=="object"&&(q[e]=a,z=!0)}function Ee(e){delete q[e],Object.keys(q).length===0&&(z=!1,e===re&&se())}function de(e){if(z){const a=["el","wrap","rtl","inline","defaultColor","a11y"];for(let l in q){const i=q[l];if(e.matches(l)){re=l,U={},a.forEach(n=>delete i[n]);for(let n in i)U[n]=Array.isArray(r[n])?r[n].slice():r[n];Q(i);break}}}}function se(){Object.keys(U).length>0&&(Q(U),re="",U={})}function ie(e){g(t,"click",e,a=>{r.inline||(de(a.target),v=a.target,x=v.value,V=ne(x),o.classList.add("clr-open"),j(),K(x),(r.focusInput||r.selectInput)&&(I.focus({preventScroll:!0}),I.setSelectionRange(v.selectionStart,v.selectionEnd)),r.selectInput&&I.select(),(le||r.swatchesOnly)&&pe().shift().focus(),v.dispatchEvent(new Event("open",{bubbles:!0})))}),g(t,"input",e,a=>{const l=a.target.parentNode;l.classList.contains("clr-field")&&(l.style.color=a.target.value)})}function j(){if(!o||!v&&!r.inline)return;const e=E,a=u.scrollY,l=o.offsetWidth,i=o.offsetHeight,n={left:!1,top:!1};let d,y,k,T={x:0,y:0};if(e&&(d=u.getComputedStyle(e),y=parseFloat(d.marginTop),k=parseFloat(d.borderTopWidth),T=e.getBoundingClientRect(),T.y+=k+a),!r.inline){const O=v.getBoundingClientRect();let P=O.x,F=a+O.y+O.height+r.margin;e?(P-=T.x,F-=T.y,P+l>e.clientWidth&&(P+=O.width-l,n.left=!0),F+i>e.clientHeight-y&&i+r.margin<=O.top-(T.y-a)&&(F-=O.height+i+r.margin*2,n.top=!0),F+=e.scrollTop):(P+l>t.documentElement.clientWidth&&(P+=O.width-l,n.left=!0),F+i-a>t.documentElement.clientHeight&&i+r.margin<=O.top&&(F=a+O.y-i-r.margin,n.top=!0)),o.classList.toggle("clr-left",n.left),o.classList.toggle("clr-top",n.top),o.style.left=`${P}px`,o.style.top=`${F}px`,T.x+=o.offsetLeft,T.y+=o.offsetTop}M={width:C.offsetWidth,height:C.offsetHeight,x:C.offsetLeft+T.x,y:C.offsetTop+T.y}}function J(e){t.querySelectorAll(e).forEach(a=>{const l=a.parentNode;if(!l.classList.contains("clr-field")){const i=t.createElement("div");let n="clr-field";(r.rtl||a.classList.contains("clr-rtl"))&&(n+=" clr-rtl"),i.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',l.insertBefore(i,a),i.setAttribute("class",n),i.style.color=a.value,i.appendChild(a)}})}function Y(e){if(v&&!r.inline){const a=v;e&&(v=h,x!==a.value&&(a.value=x,a.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{x!==a.value&&a.dispatchEvent(new Event("change",{bubbles:!0}))}),o.classList.remove("clr-open"),z&&se(),a.dispatchEvent(new Event("close",{bubbles:!0})),r.focusInput&&a.focus({preventScroll:!0}),v=h}}function K(e){const a=Le(e),l=Oe(a);ue(l.s,l.v),Z(a,l),W.value=l.h,o.style.color=`hsl(${l.h}, 100%, 50%)`,ae.style.left=`${l.h/360*100}%`,w.style.left=`${M.width*l.s/100}px`,w.style.top=`${M.height-M.height*l.v/100}px`,X.value=l.a*100,D.style.left=`${l.a*100}%`}function ne(e){const a=e.substring(0,3).toLowerCase();return a==="rgb"||a==="hsl"?a:"hex"}function $(e){e=e!==h?e:I.value,v&&(v.value=e,v.dispatchEvent(new Event("input",{bubbles:!0}))),r.onChange&&r.onChange.call(u,e,v),t.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:e,currentEl:v}}))}function he(e,a){const l={h:W.value*1,s:e/M.width*100,v:100-a/M.height*100,a:X.value/100},i=Ce(l);ue(l.s,l.v),Z(i,l),$()}function ue(e,a){let l=r.a11y.marker;e=e.toFixed(1)*1,a=a.toFixed(1)*1,l=l.replace("{s}",e),l=l.replace("{v}",a),w.setAttribute("aria-label",l)}function ve(e){return{pageX:e.changedTouches?e.changedTouches[0].pageX:e.pageX,pageY:e.changedTouches?e.changedTouches[0].pageY:e.pageY}}function G(e){const a=ve(e);let l=a.pageX-M.x,i=a.pageY-M.y;E&&(i+=E.scrollTop),fe(l,i),e.preventDefault(),e.stopPropagation()}function Te(e,a){let l=w.style.left.replace("px","")*1+e,i=w.style.top.replace("px","")*1+a;fe(l,i)}function fe(e,a){e=e<0?0:e>M.width?M.width:e,a=a<0?0:a>M.height?M.height:a,w.style.left=`${e}px`,w.style.top=`${a}px`,he(e,a),w.focus()}function Z(e,a){e===void 0&&(e={}),a===void 0&&(a={});let l=r.format;for(const d in e)p[d]=e[d];for(const d in a)p[d]=a[d];const i=Re(p),n=i.substring(0,7);switch(w.style.color=n,D.parentNode.style.color=n,D.style.color=i,L.style.color=i,C.style.display="none",C.offsetHeight,C.style.display="",D.nextElementSibling.style.display="none",D.nextElementSibling.offsetHeight,D.nextElementSibling.style.display="",l==="mixed"?l=p.a===1?"hex":"rgb":l==="auto"&&(l=V),l){case"hex":I.value=i;break;case"rgb":I.value=Me(p);break;case"hsl":I.value=Ne(Se(p));break}t.querySelector(`.clr-format [value="${l}"]`).checked=!0}function we(){const e=W.value*1,a=w.style.left.replace("px","")*1,l=w.style.top.replace("px","")*1;o.style.color=`hsl(${e}, 100%, 50%)`,ae.style.left=`${e/360*100}%`,he(a,l)}function Ie(){const e=X.value/100;D.style.left=`${e*100}%`,Z({a:e}),$()}function Ce(e){const a=e.s/100,l=e.v/100;let i=a*l,n=e.h/60,d=i*(1-s.abs(n%2-1)),y=l-i;i=i+y,d=d+y;const k=s.floor(n)%6,T=[i,d,y,y,d,i][k],O=[d,i,i,d,y,y][k],P=[y,y,d,i,i,d][k];return{r:s.round(T*255),g:s.round(O*255),b:s.round(P*255),a:e.a}}function Se(e){const a=e.v/100,l=a*(1-e.s/100/2);let i;return l>0&&l<1&&(i=s.round((a-l)/s.min(l,1-l)*100)),{h:e.h,s:i||0,l:s.round(l*100),a:e.a}}function Oe(e){const a=e.r/255,l=e.g/255,i=e.b/255,n=s.max(a,l,i),d=s.min(a,l,i),y=n-d,k=n;let T=0,O=0;return y&&(n===a&&(T=(l-i)/y),n===l&&(T=2+(i-a)/y),n===i&&(T=4+(a-l)/y),n&&(O=y/n)),T=s.floor(T*60),{h:T<0?T+360:T,s:s.round(O*100),v:s.round(k*100),a:e.a}}function Le(e){const a=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i;let l,i;return f.fillStyle="#000",f.fillStyle=e,l=a.exec(f.fillStyle),l?(i={r:l[3]*1,g:l[4]*1,b:l[5]*1,a:l[6]*1},i.a=+i.a.toFixed(2)):(l=f.fillStyle.replace("#","").match(/.{2}/g).map(n=>parseInt(n,16)),i={r:l[0],g:l[1],b:l[2],a:1}),i}function Re(e){let a=e.r.toString(16),l=e.g.toString(16),i=e.b.toString(16),n="";if(e.r<16&&(a="0"+a),e.g<16&&(l="0"+l),e.b<16&&(i="0"+i),r.alpha&&(e.a<1||r.forceAlpha)){const d=e.a*255|0;n=d.toString(16),d<16&&(n="0"+n)}return"#"+a+l+i+n}function Me(e){return!r.alpha||e.a===1&&!r.forceAlpha?`rgb(${e.r}, ${e.g}, ${e.b})`:`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`}function Ne(e){return!r.alpha||e.a===1&&!r.forceAlpha?`hsl(${e.h}, ${e.s}%, ${e.l}%)`:`hsla(${e.h}, ${e.s}%, ${e.l}%, ${e.a})`}function ke(){t.getElementById("clr-picker")||(E=h,o=t.createElement("div"),o.setAttribute("id","clr-picker"),o.className="clr-picker",o.innerHTML=`<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="${r.a11y.input}"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="${r.a11y.instruction}"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="${r.a11y.hueSlider}"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="${r.a11y.alphaSlider}"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>${r.a11y.format}</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear" aria-label="${r.a11y.clear}">${r.clearLabel}</button><div id="clr-color-preview" class="clr-preview"><button type="button" id="clr-close" class="clr-close" aria-label="${r.a11y.close}">${r.closeLabel}</button></div><span id="clr-open-label" hidden>${r.a11y.open}</span><span id="clr-swatch-label" hidden>${r.a11y.swatch}</span>`,t.body.appendChild(o),C=S("clr-color-area"),w=S("clr-color-marker"),R=S("clr-clear"),H=S("clr-close"),L=S("clr-color-preview"),I=S("clr-color-value"),W=S("clr-hue-slider"),ae=S("clr-hue-marker"),X=S("clr-alpha-slider"),D=S("clr-alpha-marker"),ie(r.el),J(r.el),g(o,"mousedown",e=>{o.classList.remove("clr-keyboard-nav"),e.stopPropagation()}),g(C,"mousedown",e=>{g(t,"mousemove",G)}),g(C,"touchstart",e=>{t.addEventListener("touchmove",G,{passive:!1})}),g(w,"mousedown",e=>{g(t,"mousemove",G)}),g(w,"touchstart",e=>{t.addEventListener("touchmove",G,{passive:!1})}),g(I,"change",e=>{const a=I.value;if(v||r.inline){const l=a===""?a:K(a);$(l)}}),g(R,"click",e=>{$(""),Y()}),g(H,"click",e=>{$(),Y()}),g(S("clr-format"),"click",".clr-format input",e=>{V=e.target.value,Z(),$()}),g(o,"click",".clr-swatches button",e=>{K(e.target.textContent),$(),r.swatchesOnly&&Y()}),g(t,"mouseup",e=>{t.removeEventListener("mousemove",G)}),g(t,"touchend",e=>{t.removeEventListener("touchmove",G)}),g(t,"mousedown",e=>{le=!1,o.classList.remove("clr-keyboard-nav"),Y()}),g(t,"keydown",e=>{const a=e.key,l=e.target,i=e.shiftKey;if(a==="Escape"?Y(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(a)&&(le=!0,o.classList.add("clr-keyboard-nav")),a==="Tab"&&l.matches(".clr-picker *")){const d=pe(),y=d.shift(),k=d.pop();i&&l===y?(k.focus(),e.preventDefault()):!i&&l===k&&(y.focus(),e.preventDefault())}}),g(t,"click",".clr-field button",e=>{z&&se(),e.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),g(w,"keydown",e=>{const a={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(a).includes(e.key)&&(Te(...a[e.key]),e.preventDefault())}),g(C,"click",G),g(W,"input",we),g(X,"input",Ie))}function pe(){return Array.from(o.querySelectorAll("input, button")).filter(l=>!!l.offsetWidth)}function S(e){return t.getElementById(e)}function g(e,a,l,i){const n=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof l=="string"?e.addEventListener(a,d=>{n.call(d.target,l)&&i.call(d.target,d)}):(i=l,e.addEventListener(a,i))}function _(e,a){a=a!==h?a:[],t.readyState!=="loading"?e(...a):t.addEventListener("DOMContentLoaded",()=>{e(...a)})}NodeList!==h&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function He(e,a){v=a,x=v.value,de(a),V=ne(e),j(),K(e),$(),x!==e&&v.dispatchEvent(new Event("change",{bubbles:!0}))}const oe=(()=>{const e={init:ke,set:Q,wrap:J,close:Y,setInstance:be,setColor:He,removeInstance:Ee,updatePosition:j,ready:_};function a(l){_(()=>{l&&(typeof l=="string"?ie(l):Q(l))})}for(const l in e)a[l]=function(){for(var i=arguments.length,n=new Array(i),d=0;d<i;d++)n[d]=arguments[d];_(e[l],n)};return _(()=>{u.addEventListener("resize",l=>{a.updatePosition()}),u.addEventListener("scroll",l=>{a.updatePosition()})}),a})();return oe.coloris=oe,oe})(window,document,Math)})();A.coloris;A.init;A.set;A.wrap;A.close;A.setInstance;A.removeInstance;A.updatePosition;m.BONESENTRY.innerHTML=`
    <div class="header">Dice Color</div><div id="whatsNew"></div>
    <div id="colorisContainer" class='coloris-container full'></div>
    <div class="header">Dice Choice</div>
    <div id="selectContainer" class="select"></div>
    <div class="header">Dice Log</div>
    <div id="rollContainer"><ul id="rollLog"></ul></div>
`;let ee,te;c.onReady(async()=>{await N.InitializeCache(),N.SetupHandlers(),Pe(),Ge(),document.getElementById("whatsNew").appendChild(Ae()),await ye(),setInterval($e,2e3)});async function $e(){const u=await c.viewport.getHeight(),t=await c.viewport.getWidth();(u!==ee||t!==te)&&(await c.popover.close(m.EXTENSIONDICECONTROLLERID),await ye(),ee=u,te=t)}async function ye(){try{await ge()}catch{setTimeout(async()=>{await ge()},2e3)}}async function ge(){ee=await c.viewport.getHeight(),te=await c.viewport.getWidth(),await c.popover.close(m.EXTENSIONDICECONTROLLERID),await c.popover.open({id:m.EXTENSIONDICECONTROLLERID,url:"/dicecontroller.html",height:54,width:54,anchorPosition:{top:ee-75,left:te-20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"RIGHT"},transformOrigin:{vertical:"BOTTOM",horizontal:"RIGHT"},disableClickAway:!0,hidePaper:!0})}function Pe(){let u;const t=document.getElementById("colorisContainer"),s=document.createElement("input");s.type="text",s.classList.add("coloris"),s.id="diceColoris",s.value=N.playerDiceColor,s.maxLength=7,s.oninput=async h=>{if(!h||!h.target)return;const f=h.target;clearTimeout(u),u=setTimeout(async()=>{/#[a-f0-9]{6}/.test(f.value)&&await c.room.setMetadata({[m.DICECOLORSETTING+N.playerId]:f.value})},400)},t.appendChild(s),A.init(),A({alpha:!1,theme:"polaroid",closeButton:!0,themeMode:"dark",el:"#diceColoris"})}function Ge(){const u=document.getElementById("selectContainer"),t=document.createElement("select");t.id="textureSelect",[{text:"Default",value:"default"},{text:"D.o.R",value:"diceOfRolling"},{text:"Gemstone",value:"gemstone"},{text:"Marble",value:"gemstoneMarble"},{text:"Rocky",value:"rock"},{text:"Rusty",value:"rust"},{text:"Smooth",value:"smooth"},{text:"Wood",value:"wooden"}].forEach(h=>{const f=document.createElement("option");f.setAttribute("value",h.value);const p=document.createTextNode(h.text);f.appendChild(p),t.appendChild(f)}),t.value=N.playerDiceTexture,t.onchange=async h=>{const f=h.currentTarget;await c.room.setMetadata({[m.DICETEXTURESETTING+N.playerId]:f.value})},u.appendChild(t)}
