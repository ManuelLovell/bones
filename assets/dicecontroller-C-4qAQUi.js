import{C as p,O as h}from"./bsConstants-anvcUbPb.js";/* empty css                   */function Me(){const E=document.createElement("img");E.id="whatsNewButton",E.style.cursor="pointer",E.setAttribute("class","icon"),E.classList.add("clickable"),E.setAttribute("title","Whats New?"),E.setAttribute("src","/info.svg"),E.onclick=async function(){try{localStorage.setItem(p.VERSION,"true"),E.classList.remove("whats-new-shine")}catch{}await h.modal.open({id:p.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(p.VERSION)!=="true"&&E.classList.add("whats-new-shine")}catch{}return E}function oe(E,t){let i;return function(){clearTimeout(i),i=setTimeout(()=>{E()},t)}}function pe(E,t){const i=window.matchMedia("(prefers-color-scheme: dark)"),m=i.matches?"dark":"light",v=i.matches?"light":"dark";for(var b=0;b<t.styleSheets.length;b++)for(var g=0;g<t.styleSheets[b].cssRules.length;g++){let o=t.styleSheets[b].cssRules[g];o&&o.media&&o.media.mediaText.includes("prefers-color-scheme")&&(E.mode=="LIGHT"?(o.media.appendMedium(`(prefers-color-scheme: ${m})`),o.media.mediaText.includes(v)&&o.media.deleteMedium(`(prefers-color-scheme: ${v})`)):E.mode=="DARK"&&(o.media.appendMedium(`(prefers-color-scheme: ${v})`),o.media.mediaText.includes(m)&&o.media.deleteMedium(`(prefers-color-scheme: ${m})`)))}}class Ne{constructor(t){this.totalSlots=t,this.initializeSlots()}slots=[];initializeSlots(){for(let t=0;t<this.totalSlots;t++)this.slots.push(!0)}occupySlot(){const t=this.slots.findIndex(i=>i);return t!==-1?(this.slots[t]=!1,setTimeout(()=>{this.releaseSlot(t)},3500),t):-1}releaseSlot(t){this.slots[t]=!0}runFunction(){const t=this.occupySlot();return console.log(t!==-1?`Function is running on slot ${t}`:"No available slots. Please try again later."),t}}class ke{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new Ne(4)}IsThisOld(t,i,m="DEFAULT"){const v=`${i}_${m}`,b=this.messageCounter[v];return b?b!==t?(this.messageCounter[v]=t,!1):!0:(this.messageCounter[v]=t,!1)}async ShowBonesRoll(t){if(t[`${p.EXTENSIONID}/metadata_bonesroll`]!=null){const i=t[`${p.EXTENSIONID}/metadata_bonesroll`];if(!this.IsThisOld(i.created,i.senderId,"ROLL")){const m=await h.viewport.getHeight(),v=await h.viewport.getWidth();await h.modal.open({id:p.EXTENSIONDICEWINDOWID,url:"/dicewindow.html",height:m-100,width:v-50,hidePaper:!0,hideBackdrop:!0,disablePointerEvents:!0})}}}async LogBonesRoll(t){if(t[`${p.EXTENSIONID}/metadata_logroll`]!=null){const i=t[`${p.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(i.created,i.senderId,"LOG"))if(i.senderId===R.playerId||i.viewers===R.playerRole||i.viewers==="ALL"){const m=document.querySelector("#rollLog"),v=i.rollHtml;let b="";i.viewers==="GM"&&(b="[GM]"),i.viewers==="SELF"&&(b="[SELF]");const g=document.createElement("li");if(g.className="dice-log-item dice-notification",g.innerHTML=`[${this.getTimestamp(i.created)}] ${b}<span style="font-weight: bold; color:${i.senderColor};">${i.senderName}</span> => ${v}`,m.append(g),g.scrollIntoView(!1),i.senderId!==R.playerId){const o=await h.viewport.getHeight(),f=encodeURIComponent(v),c=encodeURIComponent(i.senderName);let d=R.party.find(L=>L.id===i.senderId)?.color??"#FFF";const y=encodeURIComponent(d),O=this.queue.runFunction();if(O!==-1){const L=O===0?o-50:o-O*100-50;await h.popover.open({id:p.EXTENSIONNOTIFY+O.toString(),url:`/dicenotify.html?sender=${c}&message=${f}&color=${y}&queue=${encodeURIComponent(O)}`,height:95,width:300,anchorPosition:{top:L,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}else{const m=document.querySelector("#rollLog"),v=document.createElement("li");if(v.className="dice-log-item dice-notification",v.innerHTML=`[${this.getTimestamp(i.created)}]<span style="font-weight: bold; color:${i.senderColor};">${i.senderName}</span> rolled out of view.`,m.append(v),v.scrollIntoView(!1),i.senderId!==R.playerId){const b=await h.viewport.getHeight(),g=encodeURIComponent(" just rolled out of view."),o=encodeURIComponent(i.senderName);let f=R.party.find(y=>y.id===i.senderId)?.color??"#FFF";const c=encodeURIComponent(f),d=this.queue.runFunction();if(d!==-1){const y=d===0?b-50:b-d*100-50;await h.popover.open({id:p.EXTENSIONNOTIFY+d.toString(),url:`/dicenotify.html?sender=${o}&message=${g}&color=${c}&queue=${encodeURIComponent(d)}`,height:95,width:300,anchorPosition:{top:y,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}getTimestamp(t){const i=new Date(t),m=i.getHours().toString().padStart(2,"0"),v=i.getMinutes().toString().padStart(2,"0");return`${m}:${v}`}}const X=new ke;class C{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerFrontDiceColor;playerDiceTexture;playerDiceZoom;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(t){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="skulls",this.playerDiceColor="#ff0000",this.playerFrontDiceColor="#FFFFFF",this.playerDiceZoom=4,this.caches=t,this.debouncedOnSceneItemsChange=oe(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=oe(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=oe(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await h.scene.isReady(),this.theme=await h.theme.getTheme(),pe(this.theme,document),this.caches.includes(C.PLAYER)){this.playerId=await h.player.getId(),this.playerName=await h.player.getName(),this.playerColor=await h.player.getColor(),this.playerMetadata=await h.player.getMetadata(),this.playerRole=await h.player.getRole();const t=this.playerMetadata[`${p.EXTENSIONID}/metadata_bonesroll`];t&&X.IsThisOld(t.created,t.senderName,"DEFAULT");const i=this.playerMetadata[`${p.EXTENSIONID}/metadata_logroll`];i&&X.IsThisOld(i.created,i.senderId,"LOG")}if(this.caches.includes(C.PARTY)){this.party=await h.party.getPlayers();for(const t of this.party){const i=t.metadata[`${p.EXTENSIONID}/metadata_bonesroll`];i&&X.IsThisOld(i.created,i.senderName,"DEFAULT");const m=t.metadata[`${p.EXTENSIONID}/metadata_logroll`];m&&X.IsThisOld(m.created,m.senderId,"LOG")}}this.caches.includes(C.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await h.scene.items.getItems()),this.caches.includes(C.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await h.scene.getMetadata()),this.caches.includes(C.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await h.scene.grid.getDpi(),this.gridScale=(await h.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(C.ROOMMETA)&&(this.roomMetadata=await h.room.getMetadata(),this.playerDiceColor=this.roomMetadata[p.DICECOLORSETTING+this.playerId]??"#ff0000",this.playerDiceZoom=this.roomMetadata[p.DICEZOOMSETTING+this.playerId]??4,this.playerFrontDiceColor=this.roomMetadata[p.FRONTDICECOLORSETTING+this.playerId]??"#FFFFFF",this.playerDiceTexture=this.roomMetadata[p.DICETEXTURESETTING+this.playerId]??"default",p.DEFAULTTEXTURES.includes(this.playerDiceTexture)||(this.playerDiceTexture="default"))}KillHandlers(){this.caches.includes(C.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(C.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(C.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(C.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(C.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(C.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(C.SCENEMETA)&&(this.sceneMetadataHandler=h.scene.onMetadataChange(async t=>{this.sceneMetadata=t,this.debouncedOnSceneMetadataChange(t)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(C.SCENEITEMS)&&(this.sceneItemsHandler=h.scene.items.onChange(async t=>{this.sceneItems=t,this.debouncedOnSceneItemsChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(C.SCENEGRID)&&(this.sceneGridHandler=h.scene.grid.onChange(async t=>{this.gridDpi=t.dpi,this.gridScale=parseInt(t.scale),await this.OnSceneGridChange(t)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(C.PLAYER)&&(this.playerHandler=h.player.onChange(async t=>{this.playerName=t.name,this.playerColor=t.color,this.playerId=t.id,this.playerRole=t.role,this.playerMetadata=t.metadata,await this.OnPlayerChange(t)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(C.PARTY)&&(this.partyHandler=h.party.onChange(async t=>{this.party=t,await this.OnPartyChange(t)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(C.ROOMMETA)&&(this.roomHandler=h.room.onMetadataChange(async t=>{this.roomMetadata=t,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=h.theme.onChange(async t=>{this.theme=t.mode,await this.OnThemeChange(t)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=h.scene.onReadyChange(async t=>{this.sceneReady=t,t&&(this.sceneItems=await h.scene.items.getItems(),this.sceneMetadata=await h.scene.getMetadata(),this.gridDpi=await h.scene.grid.getDpi(),this.gridScale=(await h.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(t)}))}async OnSceneMetadataChanges(t){}async OnSceneItemsChange(t){this.sceneReady}async OnSceneGridChange(t){}async OnSceneReadyChange(t){}async OnPlayerChange(t){await X.ShowBonesRoll(t.metadata),await X.LogBonesRoll(t.metadata)}async OnPartyChange(t){for await(const i of t)await X.LogBonesRoll(i.metadata)}async OnRoomMetadataChange(){const t=this.roomMetadata[p.DICECOLORSETTING+this.playerId],i=this.roomMetadata[p.DICEZOOMSETTING+this.playerId],m=this.roomMetadata[p.FRONTDICECOLORSETTING+this.playerId],v=this.roomMetadata[p.DICETEXTURESETTING+this.playerId];t&&(this.playerDiceColor=t),m&&(this.playerFrontDiceColor=m),i&&(this.playerDiceZoom=i),v&&(this.playerDiceTexture=v)}async OnThemeChange(t){pe(t,document)}}const R=new C([C.PLAYER,C.PARTY,C.ROOMMETA]),H=(()=>{/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return((E,t,i,m)=>{const v=t.createElement("canvas").getContext("2d"),b={r:0,g:0,b:0,h:0,s:0,v:0,a:1};let g,o,f,c,d,y,O,L,$,W,D,A,w,q,F,te,k={};const s={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>m,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},V={};let ae="",z={},j=!1;function Q(e){if(typeof e=="object")for(const a in e)switch(a){case"el":se(e.el),e.wrap!==!1&&J(e.el);break;case"parent":g=t.querySelector(e.parent),g&&(g.appendChild(o),s.parent=e.parent,g===t.body&&(g=m));break;case"themeMode":s.themeMode=e.themeMode,e.themeMode==="auto"&&E.matchMedia&&E.matchMedia("(prefers-color-scheme: dark)").matches&&(s.themeMode="dark");case"theme":e.theme&&(s.theme=e.theme),o.className=`clr-picker clr-${s.theme} clr-${s.themeMode}`,s.inline&&K();break;case"rtl":s.rtl=!!e.rtl,t.querySelectorAll(".clr-field").forEach(r=>r.classList.toggle("clr-rtl",s.rtl));break;case"margin":e.margin*=1,s.margin=isNaN(e.margin)?s.margin:e.margin;break;case"wrap":e.el&&e.wrap&&J(e.el);break;case"formatToggle":s.formatToggle=!!e.formatToggle,M("clr-format").style.display=s.formatToggle?"block":"none",s.formatToggle&&(s.format="auto");break;case"swatches":if(Array.isArray(e.swatches)){const r=[];e.swatches.forEach((u,I)=>{r.push(`<button type="button" id="clr-swatch-${I}" aria-labelledby="clr-swatch-label clr-swatch-${I}" style="color: ${u};">${u}</button>`)}),M("clr-swatches").innerHTML=r.length?`<div>${r.join("")}</div>`:"",s.swatches=e.swatches.slice()}break;case"swatchesOnly":s.swatchesOnly=!!e.swatchesOnly,o.setAttribute("data-minimal",s.swatchesOnly);break;case"alpha":s.alpha=!!e.alpha,o.setAttribute("data-alpha",s.alpha);break;case"inline":if(s.inline=!!e.inline,o.setAttribute("data-inline",s.inline),s.inline){const r=e.defaultColor||s.defaultColor;q=ne(r),K(),Z(r)}break;case"clearButton":typeof e.clearButton=="object"&&(e.clearButton.label&&(s.clearLabel=e.clearButton.label,O.innerHTML=s.clearLabel),e.clearButton=e.clearButton.show),s.clearButton=!!e.clearButton,O.style.display=s.clearButton?"block":"none";break;case"clearLabel":s.clearLabel=e.clearLabel,O.innerHTML=s.clearLabel;break;case"closeButton":s.closeButton=!!e.closeButton,s.closeButton?o.insertBefore(L,d):d.appendChild(L);break;case"closeLabel":s.closeLabel=e.closeLabel,L.innerHTML=s.closeLabel;break;case"a11y":const l=e.a11y;let n=!1;if(typeof l=="object")for(const r in l)l[r]&&s.a11y[r]&&(s.a11y[r]=l[r],n=!0);if(n){const r=M("clr-open-label"),u=M("clr-swatch-label");r.innerHTML=s.a11y.open,u.innerHTML=s.a11y.swatch,L.setAttribute("aria-label",s.a11y.close),O.setAttribute("aria-label",s.a11y.clear),$.setAttribute("aria-label",s.a11y.hueSlider),D.setAttribute("aria-label",s.a11y.alphaSlider),y.setAttribute("aria-label",s.a11y.input),f.setAttribute("aria-label",s.a11y.instruction)}break;default:s[a]=e[a]}}function fe(e,a){typeof e=="string"&&typeof a=="object"&&(V[e]=a,j=!0)}function me(e){delete V[e],Object.keys(V).length===0&&(j=!1,e===ae&&le())}function re(e){if(j){const a=["el","wrap","rtl","inline","defaultColor","a11y"];for(let l in V){const n=V[l];if(e.matches(l)){ae=l,z={},a.forEach(r=>delete n[r]);for(let r in n)z[r]=Array.isArray(s[r])?s[r].slice():s[r];Q(n);break}}}}function le(){Object.keys(z).length>0&&(Q(z),ae="",z={})}function se(e){T(t,"click",e,a=>{s.inline||(re(a.target),w=a.target,F=w.value,q=ne(F),o.classList.add("clr-open"),K(),Z(F),(s.focusInput||s.selectInput)&&(y.focus({preventScroll:!0}),y.setSelectionRange(w.selectionStart,w.selectionEnd)),s.selectInput&&y.select(),(te||s.swatchesOnly)&&ue().shift().focus(),w.dispatchEvent(new Event("open",{bubbles:!0})))}),T(t,"input",e,a=>{const l=a.target.parentNode;l.classList.contains("clr-field")&&(l.style.color=a.target.value)})}function K(){if(!o||!w&&!s.inline)return;const e=g,a=E.scrollY,l=o.offsetWidth,n=o.offsetHeight,r={left:!1,top:!1};let u,I,x,S={x:0,y:0};if(e&&(u=E.getComputedStyle(e),I=parseFloat(u.marginTop),x=parseFloat(u.borderTopWidth),S=e.getBoundingClientRect(),S.y+=x+a),!s.inline){const N=w.getBoundingClientRect();let G=N.x,U=a+N.y+N.height+s.margin;e?(G-=S.x,U-=S.y,G+l>e.clientWidth&&(G+=N.width-l,r.left=!0),U+n>e.clientHeight-I&&n+s.margin<=N.top-(S.y-a)&&(U-=N.height+n+s.margin*2,r.top=!0),U+=e.scrollTop):(G+l>t.documentElement.clientWidth&&(G+=N.width-l,r.left=!0),U+n-a>t.documentElement.clientHeight&&n+s.margin<=N.top&&(U=a+N.y-n-s.margin,r.top=!0)),o.classList.toggle("clr-left",r.left),o.classList.toggle("clr-top",r.top),o.style.left=`${G}px`,o.style.top=`${U}px`,S.x+=o.offsetLeft,S.y+=o.offsetTop}k={width:f.offsetWidth,height:f.offsetHeight,x:f.offsetLeft+S.x,y:f.offsetTop+S.y}}function J(e){t.querySelectorAll(e).forEach(a=>{const l=a.parentNode;if(!l.classList.contains("clr-field")){const n=t.createElement("div");let r="clr-field";(s.rtl||a.classList.contains("clr-rtl"))&&(r+=" clr-rtl"),n.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',l.insertBefore(n,a),n.setAttribute("class",r),n.style.color=a.value,n.appendChild(a)}})}function Y(e){if(w&&!s.inline){const a=w;e&&(w=m,F!==a.value&&(a.value=F,a.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{F!==a.value&&a.dispatchEvent(new Event("change",{bubbles:!0}))}),o.classList.remove("clr-open"),j&&le(),a.dispatchEvent(new Event("close",{bubbles:!0})),s.focusInput&&a.focus({preventScroll:!0}),w=m}}function Z(e){const a=Ce(e),l=Ie(a);de(l.s,l.v),_(a,l),$.value=l.h,o.style.color=`hsl(${l.h}, 100%, 50%)`,W.style.left=`${l.h/360*100}%`,c.style.left=`${k.width*l.s/100}px`,c.style.top=`${k.height-k.height*l.v/100}px`,D.value=l.a*100,A.style.left=`${l.a*100}%`}function ne(e){const a=e.substring(0,3).toLowerCase();return a==="rgb"||a==="hsl"?a:"hex"}function B(e){e=e!==m?e:y.value,w&&(w.value=e,w.dispatchEvent(new Event("input",{bubbles:!0}))),s.onChange&&s.onChange.call(E,e,w),t.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:e,currentEl:w}}))}function ce(e,a){const l={h:$.value*1,s:e/k.width*100,v:100-a/k.height*100,a:D.value/100},n=be(l);de(l.s,l.v),_(n,l),B()}function de(e,a){let l=s.a11y.marker;e=e.toFixed(1)*1,a=a.toFixed(1)*1,l=l.replace("{s}",e),l=l.replace("{v}",a),c.setAttribute("aria-label",l)}function ye(e){return{pageX:e.changedTouches?e.changedTouches[0].pageX:e.pageX,pageY:e.changedTouches?e.changedTouches[0].pageY:e.pageY}}function P(e){const a=ye(e);let l=a.pageX-k.x,n=a.pageY-k.y;g&&(n+=g.scrollTop),he(l,n),e.preventDefault(),e.stopPropagation()}function ge(e,a){let l=c.style.left.replace("px","")*1+e,n=c.style.top.replace("px","")*1+a;he(l,n)}function he(e,a){e=e<0?0:e>k.width?k.width:e,a=a<0?0:a>k.height?k.height:a,c.style.left=`${e}px`,c.style.top=`${a}px`,ce(e,a),c.focus()}function _(e,a){e===void 0&&(e={}),a===void 0&&(a={});let l=s.format;for(const u in e)b[u]=e[u];for(const u in a)b[u]=a[u];const n=we(b),r=n.substring(0,7);switch(c.style.color=r,A.parentNode.style.color=r,A.style.color=n,d.style.color=n,f.style.display="none",f.offsetHeight,f.style.display="",A.nextElementSibling.style.display="none",A.nextElementSibling.offsetHeight,A.nextElementSibling.style.display="",l==="mixed"?l=b.a===1?"hex":"rgb":l==="auto"&&(l=q),l){case"hex":y.value=n;break;case"rgb":y.value=Se(b);break;case"hsl":y.value=Oe(Te(b));break}t.querySelector(`.clr-format [value="${l}"]`).checked=!0}function ve(){const e=$.value*1,a=c.style.left.replace("px","")*1,l=c.style.top.replace("px","")*1;o.style.color=`hsl(${e}, 100%, 50%)`,W.style.left=`${e/360*100}%`,ce(a,l)}function Ee(){const e=D.value/100;A.style.left=`${e*100}%`,_({a:e}),B()}function be(e){const a=e.s/100,l=e.v/100;let n=a*l,r=e.h/60,u=n*(1-i.abs(r%2-1)),I=l-n;n=n+I,u=u+I;const x=i.floor(r)%6,S=[n,u,I,I,u,n][x],N=[u,n,n,u,I,I][x],G=[I,I,u,n,n,u][x];return{r:i.round(S*255),g:i.round(N*255),b:i.round(G*255),a:e.a}}function Te(e){const a=e.v/100,l=a*(1-e.s/100/2);let n;return l>0&&l<1&&(n=i.round((a-l)/i.min(l,1-l)*100)),{h:e.h,s:n||0,l:i.round(l*100),a:e.a}}function Ie(e){const a=e.r/255,l=e.g/255,n=e.b/255,r=i.max(a,l,n),u=i.min(a,l,n),I=r-u,x=r;let S=0,N=0;return I&&(r===a&&(S=(l-n)/I),r===l&&(S=2+(n-a)/I),r===n&&(S=4+(a-l)/I),r&&(N=I/r)),S=i.floor(S*60),{h:S<0?S+360:S,s:i.round(N*100),v:i.round(x*100),a:e.a}}function Ce(e){const a=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i;let l,n;return v.fillStyle="#000",v.fillStyle=e,l=a.exec(v.fillStyle),l?(n={r:l[3]*1,g:l[4]*1,b:l[5]*1,a:l[6]*1},n.a=+n.a.toFixed(2)):(l=v.fillStyle.replace("#","").match(/.{2}/g).map(r=>parseInt(r,16)),n={r:l[0],g:l[1],b:l[2],a:1}),n}function we(e){let a=e.r.toString(16),l=e.g.toString(16),n=e.b.toString(16),r="";if(e.r<16&&(a="0"+a),e.g<16&&(l="0"+l),e.b<16&&(n="0"+n),s.alpha&&(e.a<1||s.forceAlpha)){const u=e.a*255|0;r=u.toString(16),u<16&&(r="0"+r)}return"#"+a+l+n+r}function Se(e){return!s.alpha||e.a===1&&!s.forceAlpha?`rgb(${e.r}, ${e.g}, ${e.b})`:`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`}function Oe(e){return!s.alpha||e.a===1&&!s.forceAlpha?`hsl(${e.h}, ${e.s}%, ${e.l}%)`:`hsla(${e.h}, ${e.s}%, ${e.l}%, ${e.a})`}function Re(){t.getElementById("clr-picker")||(g=m,o=t.createElement("div"),o.setAttribute("id","clr-picker"),o.className="clr-picker",o.innerHTML=`<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="${s.a11y.input}"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="${s.a11y.instruction}"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="${s.a11y.hueSlider}"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="${s.a11y.alphaSlider}"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>${s.a11y.format}</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear" aria-label="${s.a11y.clear}">${s.clearLabel}</button><div id="clr-color-preview" class="clr-preview"><button type="button" id="clr-close" class="clr-close" aria-label="${s.a11y.close}">${s.closeLabel}</button></div><span id="clr-open-label" hidden>${s.a11y.open}</span><span id="clr-swatch-label" hidden>${s.a11y.swatch}</span>`,t.body.appendChild(o),f=M("clr-color-area"),c=M("clr-color-marker"),O=M("clr-clear"),L=M("clr-close"),d=M("clr-color-preview"),y=M("clr-color-value"),$=M("clr-hue-slider"),W=M("clr-hue-marker"),D=M("clr-alpha-slider"),A=M("clr-alpha-marker"),se(s.el),J(s.el),T(o,"mousedown",e=>{o.classList.remove("clr-keyboard-nav"),e.stopPropagation()}),T(f,"mousedown",e=>{T(t,"mousemove",P)}),T(f,"touchstart",e=>{t.addEventListener("touchmove",P,{passive:!1})}),T(c,"mousedown",e=>{T(t,"mousemove",P)}),T(c,"touchstart",e=>{t.addEventListener("touchmove",P,{passive:!1})}),T(y,"change",e=>{const a=y.value;if(w||s.inline){const l=a===""?a:Z(a);B(l)}}),T(O,"click",e=>{B(""),Y()}),T(L,"click",e=>{B(),Y()}),T(M("clr-format"),"click",".clr-format input",e=>{q=e.target.value,_(),B()}),T(o,"click",".clr-swatches button",e=>{Z(e.target.textContent),B(),s.swatchesOnly&&Y()}),T(t,"mouseup",e=>{t.removeEventListener("mousemove",P)}),T(t,"touchend",e=>{t.removeEventListener("touchmove",P)}),T(t,"mousedown",e=>{te=!1,o.classList.remove("clr-keyboard-nav"),Y()}),T(t,"keydown",e=>{const a=e.key,l=e.target,n=e.shiftKey;if(a==="Escape"?Y(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(a)&&(te=!0,o.classList.add("clr-keyboard-nav")),a==="Tab"&&l.matches(".clr-picker *")){const u=ue(),I=u.shift(),x=u.pop();n&&l===I?(x.focus(),e.preventDefault()):!n&&l===x&&(I.focus(),e.preventDefault())}}),T(t,"click",".clr-field button",e=>{j&&le(),e.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),T(c,"keydown",e=>{const a={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(a).includes(e.key)&&(ge(...a[e.key]),e.preventDefault())}),T(f,"click",P),T($,"input",ve),T(D,"input",Ee))}function ue(){return Array.from(o.querySelectorAll("input, button")).filter(l=>!!l.offsetWidth)}function M(e){return t.getElementById(e)}function T(e,a,l,n){const r=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof l=="string"?e.addEventListener(a,u=>{r.call(u.target,l)&&n.call(u.target,u)}):(n=l,e.addEventListener(a,n))}function ee(e,a){a=a!==m?a:[],t.readyState!=="loading"?e(...a):t.addEventListener("DOMContentLoaded",()=>{e(...a)})}NodeList!==m&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function Le(e,a){w=a,F=w.value,re(a),q=ne(e),K(),Z(e),B(),F!==e&&w.dispatchEvent(new Event("change",{bubbles:!0}))}const ie=(()=>{const e={init:Re,set:Q,wrap:J,close:Y,setInstance:fe,setColor:Le,removeInstance:me,updatePosition:K,ready:ee};function a(l){ee(()=>{l&&(typeof l=="string"?se(l):Q(l))})}for(const l in e)a[l]=function(){for(var n=arguments.length,r=new Array(n),u=0;u<n;u++)r[u]=arguments[u];ee(e[l],r)};return ee(()=>{E.addEventListener("resize",l=>{a.updatePosition()}),E.addEventListener("scroll",l=>{a.updatePosition()})}),a})();return ie.coloris=ie,ie})(window,document,Math)})();H.coloris;H.init;H.set;H.wrap;H.close;H.setInstance;H.removeInstance;H.updatePosition;p.BONESENTRY.innerHTML=`    
    <div class="header"><span style="float:left;" id="optionsToggle">▼</span>Dice Options</div><div id="whatsNew"></div>
    <div id="optionsContainer">
        <div style="display:flex; justify-content:space-between;">
            <div id="selectContainer" class="select"></div>
            
        </div>
        <div style="display:flex; justify-content:space-between;">
            <div id="zoomContainer" class="select"></div>
            <div id="backColorisContainer" class='coloris-container full'></div>
        </div>
    </div>
    <div class="header"><span style="float:left;" id="rollToggle">▼</span>Dice Log</div>
    <div id="rollContainer"><ul id="rollLog"></ul></div>
    <div class="header"><span style="float:left;" id="manualRollToggle">▼</span>Custom Rolls</div>
    <div id="manualRollContainer">
        <div id="viewToggleContainer"></div>
    </div>`;h.onReady(async()=>{await R.InitializeCache(),R.SetupHandlers(),m(),b(),v(),i(),document.getElementById("whatsNew").appendChild(Me()),t("optionsToggle","optionsContainer",50,"block"),t("rollToggle","rollContainer",160,"block"),t("manualRollToggle","manualRollContainer",31,"flex");function t(g,o,f,c){const d=document.getElementById(g);d.style.cursor="pointer";const y=document.getElementById(o);d.onclick=async()=>{const O=await h.popover.getHeight(p.EXTENSIONDICECONTROLLERID);y.style.display!=="none"?(d.innerText="▶",await h.popover.setHeight(p.EXTENSIONDICECONTROLLERID,O-f),y.style.display="none"):(d.innerText="▼",await h.popover.setHeight(p.EXTENSIONDICECONTROLLERID,O+f),y.style.display=c)}}function i(){const g=document.getElementById("manualRollContainer"),o=document.getElementById("viewToggleContainer"),f=document.createElement("input");f.type="text",f.placeholder="Custom Roll",f.classList.add("input-button");const c=document.createElement("input");c.id="manualRollSelfButton",c.type="button",c.classList.add("options-button"),c.classList.add("options-hover"),c.value="Self",c.dataset.active=p.FALSE,c.onclick=()=>{c.dataset.active===p.TRUE?(c.dataset.active=p.FALSE,c.classList.remove("options-active")):(c.dataset.active=p.TRUE,c.classList.add("options-active"))};const d=document.createElement("input");d.id="manualRollGMButton",d.type="button",d.classList.add("options-button"),d.classList.add("options-hover"),d.value="GM",d.onclick=()=>{d.dataset.active===p.TRUE?(d.dataset.active=p.FALSE,d.classList.remove("options-active")):(d.dataset.active=p.TRUE,d.classList.add("options-active"))};const y=document.createElement("input");y.id="rollButton",y.type="image",y.src="/dice-twenty.svg",y.onclick=async()=>{await O()},f.onkeydown=async L=>{L.key==="Enter"&&await O()},g.prepend(f),o.appendChild(y),o.appendChild(c),o.appendChild(d);async function O(){const L=f.value;if(L.length>0){const $=c.dataset.active,W=d.dataset.active;let D="ALL";$==="TRUE"&&(D="SELF"),W==="TRUE"&&(D="GM");const A={},w=new Date().toISOString();A[`${p.EXTENSIONID}/metadata_bonesroll`]={notation:L,created:w,senderName:R.playerName,senderId:R.playerId,viewers:D},await h.player.setMetadata(A)}f.value=""}}function m(){let g;const o=document.getElementById("backColorisContainer"),f=document.createElement("input");f.type="text",f.classList.add("coloris"),f.id="diceColoris",f.value=R.playerDiceColor,f.maxLength=7,f.oninput=async c=>{if(!c||!c.target)return;const d=c.target;clearTimeout(g),g=setTimeout(async()=>{/#[a-f0-9]{6}/.test(d.value)&&await h.room.setMetadata({[p.DICECOLORSETTING+R.playerId]:d.value})},400)},o.appendChild(f),H.init(),H({alpha:!1,theme:"polaroid",closeButton:!0,themeMode:R.theme.mode==="DARK"?"dark":"light",el:"#diceColoris"})}function v(){const g=document.getElementById("zoomContainer"),o=document.createElement("select");o.id="zoomSelect",[{text:"25%",value:"1"},{text:"50%",value:"2"},{text:"75%",value:"3"},{text:"100%",value:"4"},{text:"125%",value:"5"},{text:"150%",value:"6"},{text:"175%",value:"7"},{text:"200%",value:"8"}].forEach(c=>{const d=document.createElement("option");d.setAttribute("value",c.value);const y=document.createTextNode(c.text);d.appendChild(y),o.appendChild(d)}),o.value=R.playerDiceZoom.toString(),o.onchange=async c=>{const d=c.currentTarget;await h.room.setMetadata({[p.DICEZOOMSETTING+R.playerId]:parseInt(d.value)})},g.appendChild(o)}function b(){const g=document.getElementById("selectContainer"),o=document.createElement("select");o.id="textureSelect",[{text:"Default",value:"default"},{text:"D.o.R",value:"diceOfRolling"},{text:"Gemstone",value:"gemstone"},{text:"Marble",value:"gemstoneMarble"},{text:"Rocky",value:"rock"},{text:"Rusty",value:"rust"},{text:"Smooth",value:"smooth"},{text:"Wood",value:"wooden"}].forEach(c=>{const d=document.createElement("option");d.setAttribute("value",c.value);const y=document.createTextNode(c.text);d.appendChild(y),o.appendChild(d)}),o.value=R.playerDiceTexture,o.onchange=async c=>{const d=c.currentTarget;await h.room.setMetadata({[p.DICETEXTURESETTING+R.playerId]:d.value})},g.appendChild(o)}});
