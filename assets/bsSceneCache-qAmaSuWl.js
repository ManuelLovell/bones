import{C as G,O}from"./bsConstants-E4N5t5Rc.js";var St=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Oe(F,h){let y;return function(){clearTimeout(y),y=setTimeout(()=>{F()},h)}}function Ht(F){if(F.indexOf("#")===0&&(F=F.slice(1)),F.length===3&&(F=F[0]+F[0]+F[1]+F[1]+F[2]+F[2]),F.length!==6)throw new Error("Invalid HEX color.");var h=parseInt(F.slice(0,2),16),y=parseInt(F.slice(2,4),16),C=parseInt(F.slice(4,6),16);return h*.299+y*.587+C*.114>186?"#000000":"#FFFFFF"}function st(F,h){const y=window.matchMedia("(prefers-color-scheme: dark)"),C=y.matches?"dark":"light",I=y.matches?"light":"dark";for(var o=0;o<h.styleSheets.length;o++)for(var t=0;t<h.styleSheets[o].cssRules.length;t++){let a=h.styleSheets[o].cssRules[t];a&&a.media&&a.media.mediaText.includes("prefers-color-scheme")&&(F.mode=="LIGHT"?(a.media.appendMedium(`(prefers-color-scheme: ${C})`),a.media.mediaText.includes(I)&&a.media.deleteMedium(`(prefers-color-scheme: ${I})`)):F.mode=="DARK"&&(a.media.appendMedium(`(prefers-color-scheme: ${I})`),a.media.mediaText.includes(C)&&a.media.deleteMedium(`(prefers-color-scheme: ${C})`)))}}var at={exports:{}};(function(F,h){(function(y,C){F.exports=C()})(St,function(){return function(y){var C={};function I(o){if(C[o])return C[o].exports;var t=C[o]={i:o,l:!1,exports:{}};return y[o].call(t.exports,t,t.exports,I),t.l=!0,t.exports}return I.m=y,I.c=C,I.d=function(o,t,a){I.o(o,t)||Object.defineProperty(o,t,{enumerable:!0,get:a})},I.r=function(o){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},I.t=function(o,t){if(1&t&&(o=I(o)),8&t||4&t&&typeof o=="object"&&o&&o.__esModule)return o;var a=Object.create(null);if(I.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:o}),2&t&&typeof o!="string")for(var c in o)I.d(a,c,function(e){return o[e]}.bind(null,c));return a},I.n=function(o){var t=o&&o.__esModule?function(){return o.default}:function(){return o};return I.d(t,"a",t),t},I.o=function(o,t){return Object.prototype.hasOwnProperty.call(o,t)},I.p="",I(I.s=0)}([function(y,C,I){function o(t){for(var a in t)C.hasOwnProperty(a)||(C[a]=t[a])}Object.defineProperty(C,"__esModule",{value:!0}),o(I(1)),o(I(3))},function(y,C,I){Object.defineProperty(C,"__esModule",{value:!0});const o=I(2);C.DiceRoller=class{constructor(t,a=1e3){this.randFunction=Math.random,this.maxRollCount=1e3,t&&(this.randFunction=t),this.maxRollCount=a}parse(t){return o.parse(t)}roll(t){const a=o.parse(t);return this.rollType(a)}rollValue(t){return this.roll(t).value}rollParsed(t){return this.rollType(t)}rollType(t){let a;switch(t.type){case"diceExpression":a=this.rollDiceExpr(t);break;case"group":a=this.rollGroup(t);break;case"die":a=this.rollDie(t);break;case"expression":a=this.rollExpression(t);break;case"mathfunction":a=this.rollFunction(t);break;case"inline":a=this.rollType(t.expr);break;case"number":a=Object.assign(Object.assign({},t),{success:!1,valid:!0,order:0});break;default:throw new Error(`Unable to render ${t.type}`)}return t.label&&(a.label=t.label),a}rollDiceExpr(t){const a=this.rollType(t.head),c=[a],e=[],u=t.ops.reduce((E,d,g)=>{const M=this.rollType(d.tail);switch(M.order=g,c.push(M),e.push(d.op),d.op){case"+":return E+M.value;case"-":return E-M.value;default:return E}},a.value);return{dice:c,ops:e,success:!1,type:"diceexpressionroll",valid:!0,value:u,order:0}}rollGroup(t){let a=t.rolls.map((c,e)=>Object.assign(Object.assign({},this.rollType(c)),{order:e}));if(t.mods){const c=t.mods,e=u=>{const E=c.some(d=>["failure","success"].includes(d.type));return u=c.reduce((d,g)=>this.applyGroupMod(d,g),u),E&&(u=u.map(d=>(d.success||(d.value=0,d.success=!0),d))),u};if(a.length===1&&["die","diceexpressionroll"].includes(a[0].type)){const u=a[0];let E=u.type==="die"?u.rolls:u.dice.filter(d=>d.type!=="number").reduce((d,g)=>[...d,...g.type==="die"?g.rolls:g.dice],[]);E=e(E),u.value=E.reduce((d,g)=>g.valid?d+g.value:d,0)}else a=e(a)}return{dice:a,success:!1,type:"grouproll",valid:!0,value:a.reduce((c,e)=>e.valid?c+e.value:c,0),order:0}}rollDie(t){const a=this.rollType(t.count);if(a.value>this.maxRollCount)throw new Error("Entered number of dice too large.");let c,e;t.die.type==="fate"?(e={type:"fate",success:!1,valid:!1,value:0,order:0},c=Array.from({length:a.value},(d,g)=>this.generateFateRoll(g))):(e=this.rollType(t.die),c=Array.from({length:a.value},(d,g)=>this.generateDiceRoll(e.value,g))),t.mods&&(c=t.mods.reduce((d,g)=>this.applyMod(d,g),c)),t.targets&&(c=t.targets.reduce((d,g)=>this.applyMod(d,g),c).map(d=>(d.success||(d.value=0,d.success=!0),d)));let u=!1,E=0;if(t.match){const d=t.match,g=c.reduce((x,$)=>x.set($.roll,(x.get($.roll)||0)+1),new Map),M=new Set(Array.from(g.entries()).filter(([x,$])=>$>=d.min.value).filter(([x])=>!(d.mod&&d.expr)||this.successTest(d.mod,this.rollType(d.expr).value,x)).map(([x])=>x));c.filter(x=>M.has(x.roll)).forEach(x=>x.matched=!0),d.count&&(u=!0,E=M.size)}return t.sort&&(c=this.applySort(c,t.sort)),{count:a,die:e,rolls:c,success:!1,type:"die",valid:!0,value:u?E:c.reduce((d,g)=>g.valid?d+g.value:d,0),order:0,matched:u}}rollExpression(t){const a=this.rollType(t.head),c=[a],e=[],u=t.ops.reduce((E,d)=>{const g=this.rollType(d.tail);switch(c.push(g),e.push(d.op),d.op){case"+":return E+g.value;case"-":return E-g.value;case"*":return E*g.value;case"/":return E/g.value;case"%":return E%g.value;case"**":return E**g.value;default:return E}},a.value);return{dice:c,ops:e,success:!1,type:"expressionroll",valid:!0,value:u,order:0}}rollFunction(t){const a=this.rollType(t.expr);let c;switch(t.op){case"floor":c=Math.floor(a.value);break;case"ceil":c=Math.ceil(a.value);break;case"round":c=Math.round(a.value);break;case"abs":c=Math.abs(a.value);break;default:c=a.value}return{expr:a,op:t.op,success:!1,type:"mathfunction",valid:!0,value:c,order:0}}applyGroupMod(t,a){return this.getGroupModMethod(a)(t)}getGroupModMethod(t){const a=c=>c.value;switch(t.type){case"success":return this.getSuccessMethod(t,a);case"failure":return this.getFailureMethod(t,a);case"keep":return this.getKeepMethod(t,a);case"drop":return this.getDropMethod(t,a);default:throw new Error(`Mod ${t.type} is not recognised`)}}applyMod(t,a){return this.getModMethod(a)(t)}getModMethod(t){const a=c=>c.roll;switch(t.type){case"success":return this.getSuccessMethod(t,a);case"failure":return this.getFailureMethod(t,a);case"crit":return this.getCritSuccessMethod(t,a);case"critfail":return this.getCritFailureMethod(t,a);case"keep":return c=>this.getKeepMethod(t,a)(c).sort((e,u)=>e.order-u.order);case"drop":return c=>this.getDropMethod(t,a)(c).sort((e,u)=>e.order-u.order);case"explode":return this.getExplodeMethod(t);case"compound":return this.getCompoundMethod(t);case"penetrate":return this.getPenetrateMethod(t);case"reroll":return this.getReRollMethod(t);case"rerollOnce":return this.getReRollOnceMethod(t);default:throw new Error(`Mod ${t.type} is not recognised`)}}applySort(t,a){return t.sort((c,e)=>a.asc?c.roll-e.roll:e.roll-c.roll),t.forEach((c,e)=>c.order=e),t}getCritSuccessMethod(t,a){const c=this.rollType(t.expr);return e=>e.map(u=>{if(!u.valid||u.type!=="roll"||u.success)return u;const E=u;return this.successTest(t.mod,c.value,a(u))?E.critical="success":E.critical==="success"&&(E.critical=null),u})}getCritFailureMethod(t,a){const c=this.rollType(t.expr);return e=>e.map(u=>{if(!u.valid||u.type!=="roll"||u.success)return u;const E=u;return this.successTest(t.mod,c.value,a(u))?E.critical="failure":E.critical==="failure"&&(E.critical=null),u})}getSuccessMethod(t,a){const c=this.rollType(t.expr);return e=>e.map(u=>(u.valid&&this.successTest(t.mod,c.value,a(u))&&(u.success?u.value+=1:(u.value=1,u.success=!0)),u))}getFailureMethod(t,a){const c=this.rollType(t.expr);return e=>e.map(u=>(u.valid&&this.successTest(t.mod,c.value,a(u))&&(u.success?u.value-=1:(u.value=-1,u.success=!0)),u))}getKeepMethod(t,a){const c=this.rollType(t.expr);return e=>{if(e.length===0)return e;e=e.sort((M,x)=>t.highlow==="l"?a(x)-a(M):a(M)-a(x)).sort((M,x)=>(M.valid?1:0)-(x.valid?1:0));const u=Math.max(Math.min(c.value,e.length),0);let E=0,d=0;const g=e.reduce((M,x)=>(x.valid?1:0)+M,0)-u;for(;d<e.length&&E<g;)e[d].valid&&(e[d].valid=!1,E++),d++;return e}}getDropMethod(t,a){const c=this.rollType(t.expr);return e=>{e=e.sort((g,M)=>t.highlow==="h"?a(M)-a(g):a(g)-a(M));const u=Math.max(Math.min(c.value,e.length),0);let E=0,d=0;for(;d<e.length&&E<u;)e[d].valid&&(e[d].valid=!1,E++),d++;return e}}getExplodeMethod(t){const a=t.target?this.rollType(t.target.value):null;return c=>{const e=a?u=>this.successTest(t.target.mod,a.value,u.roll):u=>this.successTest("=",u.type==="fateroll"?1:u.die,u.roll);if(c[0].type==="roll"&&e({roll:1})&&e({roll:c[0].die}))throw new Error("Invalid reroll target");for(let u=0;u<c.length;u++){let E=c[u];E.order=u;let d=0;for(;e(E)&&d++<1e3;){const g=this.reRoll(E,++u);c.splice(u,0,g),E=g}}return c}}getCompoundMethod(t){const a=t.target?this.rollType(t.target.value):null;return c=>{const e=a?u=>this.successTest(t.target.mod,a.value,u.roll):u=>this.successTest("=",u.type==="fateroll"?1:u.die,u.roll);if(c[0].type==="roll"&&e({roll:1})&&e({roll:c[0].die}))throw new Error("Invalid reroll target");for(let u=0;u<c.length;u++){let E=c[u],d=E.roll,g=0;for(;e(E)&&g++<1e3;){const M=this.reRoll(c[u],++u);d+=M.roll,E=M}E.value=d,E.roll=d}return c}}getPenetrateMethod(t){const a=t.target?this.rollType(t.target.value):null;return c=>{const e=a?u=>this.successTest(t.target.mod,a.value,u.roll):u=>this.successTest("=",u.type==="fateroll"?1:u.die,u.roll);if(a&&c[0].type==="roll"&&e(c[0])&&this.successTest(t.target.mod,a.value,1))throw new Error("Invalid reroll target");for(let u=0;u<c.length;u++){let E=c[u];E.order=u;let d=0;for(;e(E)&&d++<1e3;){const g=this.reRoll(E,++u);g.value-=1,g.roll-=1,c.splice(u,0,g),E=g}}return c}}getReRollMethod(t){const a=t.target?this.successTest.bind(null,t.target.mod,this.rollType(t.target.value).value):this.successTest.bind(null,"=",1);return c=>{if(c[0].type==="roll"&&a(1)&&a(c[0].die))throw new Error("Invalid reroll target");for(let e=0;e<c.length;e++)for(;a(c[e].roll);){c[e].valid=!1;const u=this.reRoll(c[e],e+1);c.splice(++e,0,u)}return c}}getReRollOnceMethod(t){const a=t.target?this.successTest.bind(null,t.target.mod,this.rollType(t.target.value).value):this.successTest.bind(null,"=",1);return c=>{if(c[0].type==="roll"&&a(1)&&a(c[0].die))throw new Error("Invalid reroll target");for(let e=0;e<c.length;e++)if(a(c[e].roll)){c[e].valid=!1;const u=this.reRoll(c[e],e+1);c.splice(++e,0,u)}return c}}successTest(t,a,c){switch(t){case">":return c>=a;case"<":return c<=a;case"=":default:return c==a}}reRoll(t,a){switch(t.type){case"roll":return this.generateDiceRoll(t.die,a);case"fateroll":return this.generateFateRoll(a);default:throw new Error(`Cannot do a reroll of a ${t.type}.`)}}generateDiceRoll(t,a){const c=Math.floor(this.randFunction()*t)+1;return{critical:c===t?"success":c===1?"failure":null,die:t,matched:!1,order:a,roll:c,success:!1,type:"roll",valid:!0,value:c}}generateFateRoll(t){const a=Math.floor(3*this.randFunction())-1;return{matched:!1,order:t,roll:a,success:!1,type:"fateroll",valid:!0,value:a}}}},function(y,C,I){function o(t,a,c,e){this.message=t,this.expected=a,this.found=c,this.location=e,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,o)}(function(t,a){function c(){this.constructor=t}c.prototype=a.prototype,t.prototype=new c})(o,Error),o.buildMessage=function(t,a){var c={literal:function(d){return'"'+u(d.text)+'"'},class:function(d){var g,M="";for(g=0;g<d.parts.length;g++)M+=d.parts[g]instanceof Array?E(d.parts[g][0])+"-"+E(d.parts[g][1]):E(d.parts[g]);return"["+(d.inverted?"^":"")+M+"]"},any:function(d){return"any character"},end:function(d){return"end of input"},other:function(d){return d.description}};function e(d){return d.charCodeAt(0).toString(16).toUpperCase()}function u(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+e(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+e(g)})}function E(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+e(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+e(g)})}return"Expected "+function(d){var g,M,x,$=new Array(d.length);for(g=0;g<d.length;g++)$[g]=(x=d[g],c[x.type](x));if($.sort(),$.length>0){for(g=1,M=1;g<$.length;g++)$[g-1]!==$[g]&&($[M]=$[g],M++);$.length=M}switch($.length){case 1:return $[0];case 2:return $[0]+" or "+$[1];default:return $.slice(0,-1).join(", ")+", or "+$[$.length-1]}}(t)+" but "+function(d){return d?'"'+u(d)+'"':"end of input"}(a)+" found."},y.exports={SyntaxError:o,parse:function(t,a){a=a!==void 0?a:{};var c,e={},u={start:Ve},E=Ve,d={type:"any"},g=b("[[",!1),M=b("]]",!1),x=function(s,l){return l&&(s.label=l),s},$=b(">",!1),Q=b("<",!1),se=b("=",!1),H=b("f",!1),k=b("cs",!1),Z=b("cf",!1),K=b("m",!1),z=b("t",!1),_=b("k",!1),ne=b("l",!1),ee=b("h",!1),Se=b("d",!1),lt=b("{",!1),De=b(",",!1),ot=b("}",!1),oe=b("+",!1),it=b("sa",!1),ct=b("sd",!1),ut=b("!",!1),dt=b("!!",!1),ht=b("!p",!1),pt=b("r",!1),ft=b("ro",!1),gt=b("F",!1),fe=b("%",!1),xe=b("(",!1),Ne=b(")",!1),ge=b("-",!1),me=function(s,l){return l.length==0?s:{head:s,type:"expression",ops:l.map(n=>({type:"math",op:n[1],tail:n[3]}))}},He=b("*",!1),Fe=b("/",!1),ke=b("**",!1),mt=b("floor",!1),yt=b("ceil",!1),vt=b("round",!1),Et=b("abs",!1),Tt=Ue("integer"),Pe=/^[0-9]/,Ge=ve([["0","9"]],!1,!1),Mt=function(){return{type:"number",value:parseInt(t.substring(w,r),10)}},Ct=b("[",!1),je=/^[^\]]/,Le=ve(["]"],!0,!1),It=b("]",!1),bt=Ue("whitespace"),_e=/^[ \t\n\r]/,Xe=ve([" ","	",`
`,"\r"],!1,!1),r=0,w=0,ie=[{line:1,column:1}],B=0,ye=[],f=0;if("startRule"in a){if(!(a.startRule in u))throw new Error(`Can't start parsing from rule "`+a.startRule+'".');E=u[a.startRule]}function b(s,l){return{type:"literal",text:s,ignoreCase:l}}function ve(s,l,n){return{type:"class",parts:s,inverted:l,ignoreCase:n}}function Ue(s){return{type:"other",description:s}}function We(s){var l,n=ie[s];if(n)return n;for(l=s-1;!ie[l];)l--;for(n={line:(n=ie[l]).line,column:n.column};l<s;)t.charCodeAt(l)===10?(n.line++,n.column=1):n.column++,l++;return ie[s]=n,n}function Ye(s,l){var n=We(s),i=We(l);return{start:{offset:s,line:n.line,column:n.column},end:{offset:l,line:i.line,column:i.column}}}function m(s){r<B||(r>B&&(B=r,ye=[]),ye.push(s))}function Rt(s,l,n){return new o(o.buildMessage(s,l),s,l,n)}function Ve(){var s,l,n,i,T,p;if(s=r,(l=Me())!==e){for(n=[],t.length>r?(i=t.charAt(r),r++):(i=e,f===0&&m(d));i!==e;)n.push(i),t.length>r?(i=t.charAt(r),r++):(i=e,f===0&&m(d));n!==e?(w=s,p=n,(T=l).root=!0,p&&(T.label=p.join("")),s=l=T):(r=s,s=e)}else r=s,s=e;return s}function wt(){var s,l,n;return s=r,(l=function(){var i,T,p,v,R;if(i=r,(T=function(){var S,Y,te,X,j,V,W,q,L;if(S=r,t.charCodeAt(r)===123?(Y="{",r++):(Y=e,f===0&&m(lt)),Y!==e)if(D()!==e)if((te=Ee())!==e){for(X=[],j=r,(V=D())!==e?(t.charCodeAt(r)===44?(W=",",r++):(W=e,f===0&&m(De)),W!==e&&(q=D())!==e&&(L=Ee())!==e?j=V=[V,W,q,L]:(r=j,j=e)):(r=j,j=e);j!==e;)X.push(j),j=r,(V=D())!==e?(t.charCodeAt(r)===44?(W=",",r++):(W=e,f===0&&m(De)),W!==e&&(q=D())!==e&&(L=Ee())!==e?j=V=[V,W,q,L]:(r=j,j=e)):(r=j,j=e);X!==e&&(j=D())!==e?(t.charCodeAt(r)===125?(V="}",r++):(V=e,f===0&&m(ot)),V!==e?(w=S,Y={rolls:[te,...X.map($t=>$t[3])],type:"group"},S=Y):(r=S,S=e)):(r=S,S=e)}else r=S,S=e;else r=S,S=e;else r=S,S=e;return S}())!==e){for(p=[],(v=de())===e&&(v=he())===e&&(v=ce())===e&&(v=ue());v!==e;)p.push(v),(v=de())===e&&(v=he())===e&&(v=ce())===e&&(v=ue());p!==e&&(v=D())!==e?((R=pe())===e&&(R=null),R!==e?(w=i,A=T,U=R,(N=p).length>0&&(A.mods=(A.mods||[]).concat(N)),U&&(A.label=U),i=T=A):(r=i,i=e)):(r=i,i=e)}else r=i,i=e;var A,N,U;return i}())===e&&(l=ze())===e&&(l=Ae()),l!==e&&D()!==e?((n=pe())===e&&(n=null),n!==e?(w=s,s=l=x(l,n)):(r=s,s=e)):(r=s,s=e),s}function ce(){var s,l,n;return s=r,t.charCodeAt(r)===62?(l=">",r++):(l=e,f===0&&m($)),l===e&&(t.charCodeAt(r)===60?(l="<",r++):(l=e,f===0&&m(Q)),l===e&&(t.charCodeAt(r)===61?(l="=",r++):(l=e,f===0&&m(se)))),l!==e&&(n=J())!==e?(w=s,s=l={type:"success",mod:l,expr:n}):(r=s,s=e),s}function ue(){var s,l,n,i;return s=r,t.charCodeAt(r)===102?(l="f",r++):(l=e,f===0&&m(H)),l!==e?(t.charCodeAt(r)===62?(n=">",r++):(n=e,f===0&&m($)),n===e&&(t.charCodeAt(r)===60?(n="<",r++):(n=e,f===0&&m(Q)),n===e&&(t.charCodeAt(r)===61?(n="=",r++):(n=e,f===0&&m(se)))),n===e&&(n=null),n!==e&&(i=J())!==e?(w=s,s=l={type:"failure",mod:n,expr:i}):(r=s,s=e)):(r=s,s=e),s}function qe(){var s,l,n,i;return s=r,t.substr(r,2)==="cs"?(l="cs",r+=2):(l=e,f===0&&m(k)),l!==e?(t.charCodeAt(r)===62?(n=">",r++):(n=e,f===0&&m($)),n===e&&(t.charCodeAt(r)===60?(n="<",r++):(n=e,f===0&&m(Q)),n===e&&(t.charCodeAt(r)===61?(n="=",r++):(n=e,f===0&&m(se)))),n===e&&(n=null),n!==e&&(i=J())!==e?(w=s,s=l={type:"crit",mod:n,expr:i}):(r=s,s=e)):(r=s,s=e),s}function Ke(){var s,l,n,i;return s=r,t.substr(r,2)==="cf"?(l="cf",r+=2):(l=e,f===0&&m(Z)),l!==e?(t.charCodeAt(r)===62?(n=">",r++):(n=e,f===0&&m($)),n===e&&(t.charCodeAt(r)===60?(n="<",r++):(n=e,f===0&&m(Q)),n===e&&(t.charCodeAt(r)===61?(n="=",r++):(n=e,f===0&&m(se)))),n===e&&(n=null),n!==e&&(i=J())!==e?(w=s,s=l={type:"critfail",mod:n,expr:i}):(r=s,s=e)):(r=s,s=e),s}function At(){var s,l,n,i,T;return s=r,t.charCodeAt(r)===109?(l="m",r++):(l=e,f===0&&m(K)),l!==e?(t.charCodeAt(r)===116?(n="t",r++):(n=e,f===0&&m(z)),n===e&&(n=null),n!==e?((i=Ae())===e&&(i=null),i!==e?((T=function(){var p,v,R;return p=r,t.charCodeAt(r)===62?(v=">",r++):(v=e,f===0&&m($)),v===e&&(t.charCodeAt(r)===60?(v="<",r++):(v=e,f===0&&m(Q)),v===e&&(t.charCodeAt(r)===61?(v="=",r++):(v=e,f===0&&m(se)))),v!==e&&(R=J())!==e?(w=p,p=v={mod:v,expr:R}):(r=p,p=e),p}())===e&&(T=null),T!==e?(w=s,s=l=function(p,v,R){const A={type:"match",min:v||{type:"number",value:2},count:!!p};return R&&(A.mod=R.mod,A.expr=R.expr),A}(n,i,T)):(r=s,s=e)):(r=s,s=e)):(r=s,s=e)):(r=s,s=e),s}function de(){var s,l,n,i;return s=r,t.charCodeAt(r)===107?(l="k",r++):(l=e,f===0&&m(_)),l!==e?(t.charCodeAt(r)===108?(n="l",r++):(n=e,f===0&&m(ne)),n===e&&(t.charCodeAt(r)===104?(n="h",r++):(n=e,f===0&&m(ee))),n===e&&(n=null),n!==e?((i=J())===e&&(i=null),i!==e?(w=s,s=l={type:"keep",highlow:n,expr:i||rt}):(r=s,s=e)):(r=s,s=e)):(r=s,s=e),s}function he(){var s,l,n,i;return s=r,t.charCodeAt(r)===100?(l="d",r++):(l=e,f===0&&m(Se)),l!==e?(t.charCodeAt(r)===108?(n="l",r++):(n=e,f===0&&m(ne)),n===e&&(t.charCodeAt(r)===104?(n="h",r++):(n=e,f===0&&m(ee))),n===e&&(n=null),n!==e?((i=J())===e&&(i=null),i!==e?(w=s,s=l={type:"drop",highlow:n,expr:i||rt}):(r=s,s=e)):(r=s,s=e)):(r=s,s=e),s}function Ee(){var s,l,n,i,T,p,v,R;if(s=r,(l=Te())!==e){for(n=[],i=r,(T=D())!==e?(t.charCodeAt(r)===43?(p="+",r++):(p=e,f===0&&m(oe)),p!==e&&(v=D())!==e&&(R=Te())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);i!==e;)n.push(i),i=r,(T=D())!==e?(t.charCodeAt(r)===43?(p="+",r++):(p=e,f===0&&m(oe)),p!==e&&(v=D())!==e&&(R=Te())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);n!==e?(w=s,s=l=function(A,N){return N.length==0?A:{head:A,type:"diceExpression",ops:N.map(U=>({type:"math",op:U[1],tail:U[3]}))}}(l,n)):(r=s,s=e)}else r=s,s=e;return s}function Te(){var s;return(s=ze())===e&&(s=Me()),s}function ze(){var s,l,n;return s=r,(l=function(){var i,T,p,v,R;if(i=r,(T=function(){var A,N,U,S;if(A=r,(N=function(){var X,j,V,W;return X=r,(j=J())===e&&(j=null),j!==e?(t.charCodeAt(r)===100?(V="d",r++):(V=e,f===0&&m(Se)),V!==e?((W=function(){var q,L;return q=r,t.charCodeAt(r)===70?(L="F",r++):(L=e,f===0&&m(gt)),L===e&&(t.charCodeAt(r)===102?(L="f",r++):(L=e,f===0&&m(H))),L!==e&&(w=q,L={type:"fate"}),q=L}())===e&&(W=function(){var q,L;return q=r,t.charCodeAt(r)===37?(L="%",r++):(L=e,f===0&&m(fe)),L!==e&&(w=q,L={type:"number",value:"100"}),q=L}())===e&&(W=J()),W!==e?(w=X,j={die:W,count:j||{type:"number",value:1},type:"die"},X=j):(r=X,X=e)):(r=X,X=e)):(r=X,X=e),X}())!==e){for(U=[],(S=Je())===e&&(S=Qe())===e&&(S=Be())===e&&(S=et())===e&&(S=Ze());S!==e;)U.push(S),(S=Je())===e&&(S=Qe())===e&&(S=Be())===e&&(S=et())===e&&(S=Ze());U!==e?(w=A,te=U,(Y=N).mods=(Y.mods||[]).concat(te),A=N=Y):(r=A,A=e)}else r=A,A=e;var Y,te;return A}())!==e){for(p=[],(v=he())===e&&(v=de())===e&&(v=ce())===e&&(v=ue())===e&&(v=Ke())===e&&(v=qe());v!==e;)p.push(v),(v=he())===e&&(v=de())===e&&(v=ce())===e&&(v=ue())===e&&(v=Ke())===e&&(v=qe());p!==e?((v=At())===e&&(v=null),v!==e?((R=function(){var A,N;return A=r,t.substr(r,2)==="sa"?(N="sa",r+=2):(N=e,f===0&&m(it)),N!==e&&(w=A,N={type:"sort",asc:!0}),A=N}())===e&&(R=function(){var A,N;return A=r,t.substr(r,2)==="sd"?(N="sd",r+=2):(N=e,f===0&&m(ct)),N!==e&&(w=A,N={type:"sort",asc:!1}),A=N}()),R===e&&(R=null),R!==e?(w=i,T=function(A,N,U,S){const Y=N.filter(te=>["success","failure"].includes(te.type));return N=N.filter(te=>!Y.includes(te)),A.mods=(A.mods||[]).concat(N),Y.length>0&&(A.targets=Y),U&&(A.match=U),S&&(A.sort=S),A}(T,p,v,R),i=T):(r=i,i=e)):(r=i,i=e)):(r=i,i=e)}else r=i,i=e;return i}())!==e&&D()!==e?((n=pe())===e&&(n=null),n!==e?(w=s,s=l=x(l,n)):(r=s,s=e)):(r=s,s=e),s}function Be(){var s,l,n;return s=r,t.charCodeAt(r)===33?(l="!",r++):(l=e,f===0&&m(ut)),l!==e?((n=le())===e&&(n=null),n!==e?(w=s,s=l={type:"explode",target:n}):(r=s,s=e)):(r=s,s=e),s}function Je(){var s,l,n;return s=r,t.substr(r,2)==="!!"?(l="!!",r+=2):(l=e,f===0&&m(dt)),l!==e?((n=le())===e&&(n=null),n!==e?(w=s,s=l={type:"compound",target:n}):(r=s,s=e)):(r=s,s=e),s}function Qe(){var s,l,n;return s=r,t.substr(r,2)==="!p"?(l="!p",r+=2):(l=e,f===0&&m(ht)),l!==e?((n=le())===e&&(n=null),n!==e?(w=s,s=l={type:"penetrate",target:n}):(r=s,s=e)):(r=s,s=e),s}function Ze(){var s,l,n;return s=r,t.charCodeAt(r)===114?(l="r",r++):(l=e,f===0&&m(pt)),l!==e?((n=le())===e&&(n=null),n!==e?(w=s,s=l={type:"reroll",target:n||tt}):(r=s,s=e)):(r=s,s=e),s}function et(){var s,l,n;return s=r,t.substr(r,2)==="ro"?(l="ro",r+=2):(l=e,f===0&&m(ft)),l!==e?((n=le())===e&&(n=null),n!==e?(w=s,s=l={type:"rerollOnce",target:n||tt}):(r=s,s=e)):(r=s,s=e),s}function le(){var s,l,n;return s=r,t.charCodeAt(r)===62?(l=">",r++):(l=e,f===0&&m($)),l===e&&(t.charCodeAt(r)===60?(l="<",r++):(l=e,f===0&&m(Q)),l===e&&(t.charCodeAt(r)===61?(l="=",r++):(l=e,f===0&&m(se)))),l===e&&(l=null),l!==e&&(n=J())!==e?(w=s,s=l={type:"target",mod:l,value:n}):(r=s,s=e),s}function J(){var s;return(s=Ce())===e&&(s=Ae()),s}function Me(){var s;return(s=function(){var l,n,i,T;return l=r,t.substr(r,2)==="[["?(n="[[",r+=2):(n=e,f===0&&m(g)),n!==e&&(i=Me())!==e?(t.substr(r,2)==="]]"?(T="]]",r+=2):(T=e,f===0&&m(M)),T!==e?(w=l,l=n={type:"inline",expr:i}):(r=l,l=e)):(r=l,l=e),l}())===e&&(s=Ie())===e&&(s=Ce()),s}function Ce(){var s,l,n,i,T,p,v;return s=r,t.charCodeAt(r)===40?(l="(",r++):(l=e,f===0&&m(xe)),l!==e&&(n=Ie())!==e?(t.charCodeAt(r)===41?(i=")",r++):(i=e,f===0&&m(Ne)),i!==e&&D()!==e?((T=pe())===e&&(T=null),T!==e?(w=s,p=n,(v=T)&&(p.label=v),s=l=p):(r=s,s=e)):(r=s,s=e)):(r=s,s=e),s}function Ie(){var s,l,n,i,T,p,v,R;if(s=r,(l=be())!==e){for(n=[],i=r,(T=D())!==e?(t.charCodeAt(r)===43?(p="+",r++):(p=e,f===0&&m(oe)),p===e&&(t.charCodeAt(r)===45?(p="-",r++):(p=e,f===0&&m(ge))),p!==e&&(v=D())!==e&&(R=be())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);i!==e;)n.push(i),i=r,(T=D())!==e?(t.charCodeAt(r)===43?(p="+",r++):(p=e,f===0&&m(oe)),p===e&&(t.charCodeAt(r)===45?(p="-",r++):(p=e,f===0&&m(ge))),p!==e&&(v=D())!==e&&(R=be())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);n!==e?(w=s,s=l=me(l,n)):(r=s,s=e)}else r=s,s=e;return s}function be(){var s,l,n,i,T,p,v,R;if(s=r,(l=Re())!==e){for(n=[],i=r,(T=D())!==e?(t.charCodeAt(r)===42?(p="*",r++):(p=e,f===0&&m(He)),p===e&&(t.charCodeAt(r)===47?(p="/",r++):(p=e,f===0&&m(Fe))),p!==e&&(v=D())!==e&&(R=Re())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);i!==e;)n.push(i),i=r,(T=D())!==e?(t.charCodeAt(r)===42?(p="*",r++):(p=e,f===0&&m(He)),p===e&&(t.charCodeAt(r)===47?(p="/",r++):(p=e,f===0&&m(Fe))),p!==e&&(v=D())!==e&&(R=Re())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);n!==e?(w=s,s=l=me(l,n)):(r=s,s=e)}else r=s,s=e;return s}function Re(){var s,l,n,i,T,p,v,R;if(s=r,(l=we())!==e){for(n=[],i=r,(T=D())!==e?(t.substr(r,2)==="**"?(p="**",r+=2):(p=e,f===0&&m(ke)),p===e&&(t.charCodeAt(r)===37?(p="%",r++):(p=e,f===0&&m(fe))),p!==e&&(v=D())!==e&&(R=we())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);i!==e;)n.push(i),i=r,(T=D())!==e?(t.substr(r,2)==="**"?(p="**",r+=2):(p=e,f===0&&m(ke)),p===e&&(t.charCodeAt(r)===37?(p="%",r++):(p=e,f===0&&m(fe))),p!==e&&(v=D())!==e&&(R=we())!==e?i=T=[T,p,v,R]:(r=i,i=e)):(r=i,i=e);n!==e?(w=s,s=l=me(l,n)):(r=s,s=e)}else r=s,s=e;return s}function Ot(){var s,l,n,i,T;return s=r,(l=function(){var p;return t.substr(r,5)==="floor"?(p="floor",r+=5):(p=e,f===0&&m(mt)),p===e&&(t.substr(r,4)==="ceil"?(p="ceil",r+=4):(p=e,f===0&&m(yt)),p===e&&(t.substr(r,5)==="round"?(p="round",r+=5):(p=e,f===0&&m(vt)),p===e&&(t.substr(r,3)==="abs"?(p="abs",r+=3):(p=e,f===0&&m(Et))))),p}())!==e&&D()!==e?(t.charCodeAt(r)===40?(n="(",r++):(n=e,f===0&&m(xe)),n!==e&&D()!==e&&(i=Ie())!==e&&D()!==e?(t.charCodeAt(r)===41?(T=")",r++):(T=e,f===0&&m(Ne)),T!==e?(w=s,s=l={type:"mathfunction",op:l,expr:i}):(r=s,s=e)):(r=s,s=e)):(r=s,s=e),s}function we(){var s;return(s=Ot())===e&&(s=wt())===e&&(s=Ce()),s}function Ae(){var s,l,n,i;if(f++,s=r,t.charCodeAt(r)===45?(l="-",r++):(l=e,f===0&&m(ge)),l===e&&(l=null),l!==e){if(n=[],Pe.test(t.charAt(r))?(i=t.charAt(r),r++):(i=e,f===0&&m(Ge)),i!==e)for(;i!==e;)n.push(i),Pe.test(t.charAt(r))?(i=t.charAt(r),r++):(i=e,f===0&&m(Ge));else n=e;n!==e?(w=s,s=l=Mt()):(r=s,s=e)}else r=s,s=e;return f--,s===e&&(l=e,f===0&&m(Tt)),s}function pe(){var s,l,n,i;if(s=r,t.charCodeAt(r)===91?(l="[",r++):(l=e,f===0&&m(Ct)),l!==e){if(n=[],je.test(t.charAt(r))?(i=t.charAt(r),r++):(i=e,f===0&&m(Le)),i!==e)for(;i!==e;)n.push(i),je.test(t.charAt(r))?(i=t.charAt(r),r++):(i=e,f===0&&m(Le));else n=e;n!==e?(t.charCodeAt(r)===93?(i="]",r++):(i=e,f===0&&m(It)),i!==e?(w=s,s=l=n.join("")):(r=s,s=e)):(r=s,s=e)}else r=s,s=e;return s}function D(){var s,l;for(f++,s=[],_e.test(t.charAt(r))?(l=t.charAt(r),r++):(l=e,f===0&&m(Xe));l!==e;)s.push(l),_e.test(t.charAt(r))?(l=t.charAt(r),r++):(l=e,f===0&&m(Xe));return f--,s===e&&(l=e,f===0&&m(bt)),s}const tt={type:"target",mod:"=",value:{type:"number",value:1}},rt={type:"number",value:1};if((c=E())!==e&&r===t.length)return c;throw c!==e&&r<t.length&&m({type:"end"}),Rt(ye,B<t.length?t.charAt(B):null,B<t.length?Ye(B,B+1):Ye(B,B))}}},function(y,C,I){Object.defineProperty(C,"__esModule",{value:!0}),C.DiscordRollRenderer=class{render(o){return this.doRender(o,!0)}doRender(o,t=!1){let a="";switch(o.type){case"diceexpressionroll":a=this.renderGroupExpr(o);break;case"grouproll":a=this.renderGroup(o);break;case"die":a=this.renderDie(o);break;case"expressionroll":a=this.renderExpression(o);break;case"mathfunction":a=this.renderFunction(o);break;case"roll":return this.renderRoll(o);case"fateroll":return this.renderFateRoll(o);case"number":const c=o.label?` (${o.label})`:"";return`${o.value}${c}`;case"fate":return"F";default:throw new Error("Unable to render")}return o.valid||(a="~~"+a.replace(/~~/g,"")+"~~"),t?this.stripBrackets(a):o.label?`(${o.label}: ${a})`:a}renderGroup(o){const t=[];for(const a of o.dice)t.push(this.doRender(a));return t.length>1?`{ ${t.join(" + ")} } = ${o.value}`:`{ ${this.stripBrackets(t[0])} } = ${o.value}`}renderGroupExpr(o){const t=[];for(const a of o.dice)t.push(this.doRender(a));return t.length>1?`(${t.join(" + ")} = ${o.value})`:t[0]}renderDie(o){const t=[];for(const e of o.rolls)t.push(this.doRender(e));let a=`${t.join(", ")}`;["number","fate"].includes(o.die.type)&&o.count.type==="number"||(a+=`[*Rolling: ${this.doRender(o.count)}d${this.doRender(o.die)}*]`);const c=o.matched?` Match${o.value===1?"":"es"}`:"";return a+=` = ${o.value}${c}`,`(${a})`}renderExpression(o){if(o.dice.length>1){const t=[];for(let a=0;a<o.dice.length-1;a++)t.push(this.doRender(o.dice[a])),t.push(o.ops[a]);return t.push(this.doRender(o.dice.slice(-1)[0])),t.push("="),t.push(o.value+""),`(${t.join(" ")})`}return o.dice[0].type==="number"?o.value+"":this.doRender(o.dice[0])}renderFunction(o){const t=this.doRender(o.expr);return`(${o.op}${this.addBrackets(t)} = ${o.value})`}addBrackets(o){return o.startsWith("(")||(o=`(${o}`),o.endsWith(")")||(o=`${o})`),o}stripBrackets(o){return o.startsWith("(")&&(o=o.substring(1)),o.endsWith(")")&&(o=o.substring(0,o.length-1)),o}renderRoll(o){let t=`${o.roll}`;return o.valid?o.success&&o.value===1?t=`**${o.roll}**`:o.success&&o.value===-1?t=`*${o.roll}*`:o.success||o.critical!=="success"?o.success||o.critical!=="failure"||(t=`*${o.roll}*`):t=`**${o.roll}**`:t=`~~${o.roll}~~`,o.matched&&(t=`__${t}__`),t}renderFateRoll(o){const t=o.roll===0?"0":o.roll>0?"+":"-";let a=`${o.roll}`;return o.valid?o.success&&o.value===1?a=`**${t}**`:o.success&&o.value===-1&&(a=`*${t}*`):a=`~~${t}~~`,o.matched&&(a=`__${a}__`),a}}}])})})(at);var Dt=at.exports;class xt{messageCounter;queue;constructor(){this.messageCounter={},this.queue=new nt(4)}IsThisOld(h,y,C="DEFAULT"){const I=`${y}_${C}`,o=this.messageCounter[I];return o?o!==h?(this.messageCounter[I]=h,!1):!0:(this.messageCounter[I]=h,!1)}async LogBonesRoll(h){if(h[`${G.EXTENSIONID}/metadata_logroll`]!=null){const y=h[`${G.EXTENSIONID}/metadata_logroll`];if(!this.IsThisOld(y.created,y.sender,"LOG")&&(y.senderId===ae.playerId||y.viewers===ae.playerRole||y.viewers==="ALL")){const C=document.querySelector("#rollLog"),I=y.rollMessage;let o="";y.viewers==="GM"&&(o="[GM]"),y.viewers==="SELF"&&(o="[SELF]");const t=document.createElement("li");if(t.className="dice-log-item",t.style.color=y.color,t.innerText=`[${this.getTimestamp(y.created)}] - ${o}${y.sender} ${I}`,C.append(t),t.scrollIntoView(!1),y.senderId!==ae.playerId){const a=await O.viewport.getHeight(),c=encodeURIComponent(I),e=encodeURIComponent(y.sender);let u=ae.party.find(g=>g.id===y.senderId)?.color??"#FFF";const E=encodeURIComponent(u),d=this.queue.runFunction();if(d!==-1){const g=d===0?a-50:a-d*100-50;await O.popover.open({id:G.EXTENSIONNOTIFY+d.toString(),url:`/dicenotify.html?sender=${e}&message=${c}&color=${E}&queue=${encodeURIComponent(d)}`,height:95,width:300,anchorPosition:{top:g,left:20},anchorReference:"POSITION",anchorOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},transformOrigin:{vertical:"BOTTOM",horizontal:"LEFT"},disableClickAway:!0,hidePaper:!0})}}}}}async VerifyMetadataRoll(h){if(h[`${G.EXTENSIONID}/metadata_bonesroll`]!=null){const y=h[`${G.EXTENSIONID}/metadata_bonesroll`];this.IsThisOld(y.created,y.sender,"DEFAULT")||await this.PrepareDiceRoll(y.notation,y.sender,y.viewers)}if(h[`${G.EXTENSIONID}/outside_bonesroll`]!=null){const y=h[`${G.EXTENSIONID}/outside_bonesroll`];this.IsThisOld(y.created,y.sender,"OUTSIDE")||await this.PrepareDiceRoll(y.notation,y.sender,y.viewers)}if(h[`${G.EXTENSIONID}/metadata_throwroll`]!=null){const y=h[`${G.EXTENSIONID}/metadata_throwroll`],C=await O.viewport.getHeight(),I=await O.viewport.getWidth();this.IsThisOld(y.created,y.sender,"THROW")||(await O.modal.close(G.EXTENSIONDICEWINDOWID),await O.modal.open({id:G.EXTENSIONDICEWINDOWID,url:y.rollResult,height:C-75,width:I-75,disablePointerEvents:!0,hideBackdrop:!0,hidePaper:!0}))}}async PrepareDiceRoll(h,y,C){if(G.NORMALDICE.test(h))this.ForecastDice(h,!0,y,C);else try{this.ForecastDice(h,!1,y,C)}catch(I){console.log(`Friend Roll was unable to be parsed: ${h} | ${I}`)}}async ForecastDice(h,y,C="Bones!",I){let o=h.replace(/\s/g,""),t=[],a=[],c=[],e=0,u=0,E=!1,d="";const g=new Dt.DiceRoller;let M=g.roll(o);if(o==="1d100"?(M=g.roll("1d10"),M.value=M.value*10,M.rolls[0].roll=M.value,M.rolls[0].value=M.value,M.rolls[0].die=100):M=g.roll(o),y){if(M.type==="expressionroll")if(o==="1d10+1d100"){let H=Math.round(Math.random()*10)+1,k=Math.round(Math.random()*9+1)*10;k===100&&H!==10?k=0:k!==100&&H===10?H=0:k===100&&H===10&&(H=0,k=0,E=!0),a.push(H.toString()),t.push("1d10"),a.push(k.toString()),t.push("1d100"),d=` rolled (1d10 ‚Üí [${H}], 1d100 ‚Üí [${k}]) for ${E?"100":H+k}!`}else M.dice.forEach(H=>{let k=[];H.type==="number"?u+=H.value:(H.rolls.forEach(Z=>{a.push(Z.value),t.push("1d"+Z.die),k.push(Z.value),e+=Z.value}),c.push(`${H.count.value}d${H.die.value} ‚Üí [${k.join("-")}]`))}),d=u>0?` rolled (${c.join(", ")} +${u}) for ${e+u}!`:` rolled (${c.join(", ")}) for ${E?"100":e}!`;else if(M.type==="die"){let H=[];M.rolls.forEach(k=>{a.push(k.value),t.push("1d"+k.die),H.push(k.value),e+=k.value}),c.push(`${M.count.value}d${M.die.value} ‚Üí [${H.join("-")}]`),d=M.modifier>0?` rolled (${c.join(", ")} +${M.modifier}) for ${e+M.modifier}!`:` rolled (${c.join(", ")}) for ${E?"100":e}!`}}else{let H="",k=[];if(M.type=="die"){const K=M;(h.indexOf("<")!==-1||h.indexOf(">")!==-1)&&this.checkBoolValues(K.rolls)?(K.rolls.forEach(z=>{const _=z;a.push(_.value.toString()),t.push("1d"+_.die.toString());const ne=z.value===1?"Pass":"Fail";k.push(`[${_.critical==="success"?"üí•":""}${ne}${_.valid?"":"‚úï"}]`)}),K.value!==0?H=K.value===1?"1 success!":`${K.value} successes!`:H="no success.."):K.die.type==="fate"?K.rolls.forEach(z=>{const _=z;a.push(_.value.toString()),t.push("1df")}):K.rolls.forEach(z=>{const _=z;a.push(_.value.toString()),t.push("1d"+_.die.toString()),k.push(`[${_.critical==="success"?"üí•":""}${_.value}${_.valid?"":"‚úï"}]`)})}else M.type=="number"||M.dice.forEach(z=>{const _=z;_.rolls?.length>0&&_.rolls.forEach(ne=>{const ee=ne;a.push(ee.value.toString()),t.push("1d"+ee.die.toString()),k.push(`[D${ee.die}‚Æû${ee.critical==="success"?"üí•":""}${ee.value}${ee.valid?"":"‚úï"}]`)})});d=" rolled ";let Z=o;M.label&&(Z=o.replace(M.label,""),d+="‚≠ê"+M.label+"‚≠ê"),d+=`[${Z}] ‚Üí ${k.join(", ")} for ${H==""?M.value+"!":H}`}const x=`${t.join("+")}@${a.join(",")}`,$=`/dicewindow.html?preroll=${encodeURIComponent(x)}&texture=${encodeURIComponent(ae.playerDiceTexture)}&color=${encodeURIComponent(ae.playerDiceColor)}`,Q={},se=new Date().toISOString();Q[`${G.EXTENSIONID}/metadata_throwroll`]={created:se,sender:C,senderId:ae.playerId,viewers:I,rollResult:$,rollMessage:d},await O.player.setMetadata(Q)}getTimestamp(h){const y=new Date(h),C=y.getHours().toString().padStart(2,"0"),I=y.getMinutes().toString().padStart(2,"0");return`${C}:${I}`}checkBoolValues(h){for(const y of h){const C=y.value;if(C!==0&&C!==1)return!1}return!0}}class nt{constructor(h){this.totalSlots=h,this.initializeSlots()}slots=[];initializeSlots(){for(let h=0;h<this.totalSlots;h++)this.slots.push(!0)}occupySlot(){const h=this.slots.findIndex(y=>y);return h!==-1?(this.slots[h]=!1,setTimeout(()=>{this.releaseSlot(h)},3500),h):-1}releaseSlot(h){this.slots[h]=!0}runFunction(){const h=this.occupySlot();return console.log(h!==-1?`Function is running on slot ${h}`:"No available slots. Please try again later."),h}}const $e=new nt(5);$e.runFunction();$e.runFunction();$e.runFunction();const re=new xt;class P{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerDiceColor;playerDiceTexture;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(h){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.playerDiceTexture="astral",this.playerDiceColor="#ff8989",this.caches=h,this.debouncedOnSceneItemsChange=Oe(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=Oe(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=Oe(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){if(this.sceneReady=await O.scene.isReady(),this.theme=await O.theme.getTheme(),st(this.theme,document),this.caches.includes(P.PLAYER)){this.playerId=await O.player.getId(),this.playerName=await O.player.getName(),this.playerColor=await O.player.getColor(),this.playerMetadata=await O.player.getMetadata(),this.playerRole=await O.player.getRole();const h=this.playerMetadata[`${G.EXTENSIONID}/metadata_bonesroll`];h&&re.IsThisOld(h.created,h.sender,"DEFAULT");const y=this.playerMetadata[`${G.EXTENSIONID}/metadata_throwroll`];y&&re.IsThisOld(y.created,y.sender,"LOG");const C=this.playerMetadata[`${G.EXTENSIONID}/metadata_logroll`];C&&re.IsThisOld(C.created,C.sender,"THROW")}if(this.caches.includes(P.PARTY)){this.party=await O.party.getPlayers();for(const h of this.party){const y=h.metadata[`${G.EXTENSIONID}/metadata_bonesroll`];y&&re.IsThisOld(y.created,y.sender,"DEFAULT");const C=h.metadata[`${G.EXTENSIONID}/metadata_throwroll`];C&&re.IsThisOld(C.created,C.sender,"LOG");const I=h.metadata[`${G.EXTENSIONID}/metadata_logroll`];I&&re.IsThisOld(I.created,I.sender,"THROW")}}this.caches.includes(P.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await O.scene.items.getItems()),this.caches.includes(P.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await O.scene.getMetadata()),this.caches.includes(P.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await O.scene.grid.getDpi(),this.gridScale=(await O.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(P.ROOMMETA)&&(this.roomMetadata=await O.room.getMetadata(),this.playerDiceColor=this.roomMetadata[G.DICECOLORSETTING+this.playerId]??"#ff8989",this.playerDiceTexture=this.roomMetadata[G.DICETEXTURESETTING+this.playerId]??"astral")}KillHandlers(){this.caches.includes(P.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(P.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(P.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(P.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(P.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(P.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(P.SCENEMETA)&&(this.sceneMetadataHandler=O.scene.onMetadataChange(async h=>{this.sceneMetadata=h,this.debouncedOnSceneMetadataChange(h)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(P.SCENEITEMS)&&(this.sceneItemsHandler=O.scene.items.onChange(async h=>{this.sceneItems=h,this.debouncedOnSceneItemsChange(h)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(P.SCENEGRID)&&(this.sceneGridHandler=O.scene.grid.onChange(async h=>{this.gridDpi=h.dpi,this.gridScale=parseInt(h.scale),await this.OnSceneGridChange(h)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(P.PLAYER)&&(this.playerHandler=O.player.onChange(async h=>{this.playerName=h.name,this.playerColor=h.color,this.playerId=h.id,this.playerRole=h.role,this.playerMetadata=h.metadata,await this.OnPlayerChange(h)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(P.PARTY)&&(this.partyHandler=O.party.onChange(async h=>{this.party=h,await this.OnPartyChange(h)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(P.ROOMMETA)&&(this.roomHandler=O.room.onMetadataChange(async h=>{this.roomMetadata=h,this.debouncedOnRoomMetadataChange()})),this.themeHandler===void 0&&(this.themeHandler=O.theme.onChange(async h=>{this.theme=h.mode,await this.OnThemeChange(h)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=O.scene.onReadyChange(async h=>{this.sceneReady=h,h&&(this.sceneItems=await O.scene.items.getItems(),this.sceneMetadata=await O.scene.getMetadata(),this.gridDpi=await O.scene.grid.getDpi(),this.gridScale=(await O.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(h)}))}async OnSceneMetadataChanges(h){}async OnSceneItemsChange(h){this.sceneReady}async OnSceneGridChange(h){}async OnSceneReadyChange(h){}async OnPlayerChange(h){await re.VerifyMetadataRoll(h.metadata),await re.LogBonesRoll(h.metadata)}async OnPartyChange(h){for await(const y of h)await re.LogBonesRoll(y.metadata)}async OnRoomMetadataChange(){const h=this.roomMetadata[G.DICECOLORSETTING+this.playerId],y=this.roomMetadata[G.DICETEXTURESETTING+this.playerId];h&&(this.playerDiceColor=h),y&&(this.playerDiceTexture=y)}async OnThemeChange(h){st(h,document)}}const ae=new P([P.PLAYER,P.PARTY,P.ROOMMETA]);export{ae as B,Ht as I};
